<div class="page-wrap">
    <!-- כותרת + טאבים -->
    <div class="card header-card">
        <div class="title-block">
            <h2>חיובים להורה</h2>
            <p class="subtitle">
                צפייה בחיובים קודמים ופתוחים, בחירת חיובים לחיוב, והוספת זיכויים.
            </p>
        </div>
        <div class="filters-row">
            <div class="filter-field">
                <label for="parentUidFilter">סינון לפי שם הורה</label>
                <input id="parentUidFilter" type="text" [ngModel]="parentNameFilter()"
                    (ngModelChange)="onParentNameFilterChange($event)" placeholder="שם הורה " />
            </div>
        </div>

        <button (click)="runbilling()">!!!!!!!!!</button>


        <div class="tabs">
            <button class="tab-chip" [class.active]="activeTab() === 'open'" (click)="activeTab.set('open')">
                חיובים פתוחים
                <span class="count" *ngIf="openCharges().length">
                    ({{ openCharges().length }})
                </span>
            </button>

            <button class="tab-chip" [class.active]="activeTab() === 'all'" (click)="activeTab.set('all')">
                כל החיובים
                <span class="count" *ngIf="charges().length">
                    ({{ charges().length }})
                </span>
            </button>
        </div>
    </div>

    <!-- גוף המסך -->
    <div class="card content-card" *ngIf="!loading(); else loadingTpl">
        <div *ngIf="error()" class="error-box">
            {{ error() }}
        </div>

        <!-- טבלת חיובים -->
        <div class="table-wrapper" *ngIf="visibleCharges().length; else emptyTpl">
            <div class="table-header" *ngIf="activeTab() === 'open'">
                <div class="left">
                    <label class="select-all">
                        <!-- קודם -->
                        <!-- חדש: select all -->
                        <input type="checkbox" [checked]="
                        selectedChargeIds().size === openCharges().length &&
                        openCharges().length > 0
                    " (change)="onSelectAllChange($event)" />


                        <span>בחר/י את כל החיובים הפתוחים</span>
                    </label>
                </div>

               <div class="right" *ngIf="anySelected()">
  <span class="pill">
    סה״כ לחיוב:
    <span class="strong">
      {{ selectedTotalShekels() | number: '1.2-2' }} ₪
    </span>
  </span>

  <!-- ✅ חדש: טקסט לחשבונית (שורה 0₪) -->
  <div class="invoice-note">
    <label class="invoice-note-label">הערה לחשבונית (שורה נוספת 0₪)</label>
    <input
      class="invoice-note-input"
      type="text"
      [(ngModel)]="invoiceExtraText"
      placeholder="לדוגמה: תשלום עבור ינואר בלבד"
      maxlength="120"
    />
    <div class="invoice-note-hint">
      הטקסט יופיע בחשבונית כשורה נוספת עם סכום 0 ₪.
    </div>
  </div>

  <button class="primary-btn" type="button" (click)="chargeSelected()">
    חיוב חיובים נבחרים
  </button>
</div>

            </div>

            <table class="charges-table">
                <thead>
                    <tr>
                        <th *ngIf="activeTab() === 'open'">בחירה</th>
                        <th>הורה</th>
                        <th>תאריך יצירת חיוב</th>
                        <th>תקופת חיוב</th>
                        <th>תיאור</th>
                        <th>סכום חיוב</th>
                        <th>שולם / זיכויים</th>
                        <th>יתרה לתשלום</th>
                        <th>סטטוס</th>
                        <th>פעולות</th>
                    </tr>
                </thead>

                <tbody>
                    <ng-container *ngFor="let c of visibleCharges()">
                        <!-- שורת החיוב -->
                        <tr>
                            <td *ngIf="activeTab() === 'open'">
                                <input type="checkbox" [checked]="isSelected(c.id)"
                                    [disabled]="remainingAgorot(c) <= 0 || c.status === 'cancelled'"
                                    (change)="onRowCheckboxChange(c.id, $event)" />
                            </td>

                            <td>{{ c.parent_name || (c.first_name + ' ' + c.last_name) }}</td>
                            <td>{{ c.created_at | date: 'yyyy-MM-dd' }}</td>
                            <td>{{ formatPeriod(c) }}</td>
                            <td>{{ c.description || '-' }}</td>
                            <td>{{ formatShekelsFromAgorot(c.charge_amount_agorot) }}</td>
                            <td>{{ formatShekelsFromAgorot(c.paid_agorot + c.credits_agorot) }}</td>
                            <td>{{ formatShekelsFromAgorot(c.remaining_agorot) }}</td>

                            <td>
                                <span class="badge" [class.badge-paid]="c.status === 'paid'"
                                    [class.badge-pending]="c.status === 'pending'"
                                    [class.badge-draft]="c.status === 'draft'"
                                    [class.badge-failed]="c.status === 'failed'"
                                    [class.badge-cancelled]="c.status === 'cancelled'">
                                    {{ formatStatus(c.status) }}
                                </span>
                            </td>

                            <td class="actions-cell">
                                <button class="secondary-btn" (click)="openChargeDetails(c.id)">פרטי חיוב</button>
                                <button class="secondary-btn" (click)="openCreditForCharge(c)">הוסף/י זיכוי</button>
                            </td>
                        </tr>

                        <!-- שורת פירוט -->
                        <tr class="details-row" *ngIf="detailsOpenFor() === c.id">
                            <td class="details-cell" [attr.colspan]="activeTab() === 'open' ? 10 : 9">
                                <!-- עטיפה -->
                                <div class="details-wrap">

                                    <!-- כותרת -->
                                    <div class="details-head">
                                        <div class="details-title">
                                            <b>פירוט חיוב</b>
                                            <span class="muted">— {{ c.parent_name || c.parent_uid }}</span>
                                        </div>

                                        <button class="link-btn" type="button" (click)="detailsOpenFor.set(null)">
                                            סגירה
                                        </button>
                                    </div>

                                    <!-- מצבי טעינה/שגיאה -->
                                    <div *ngIf="detailsLoading()" class="details-loading">טוען פירוט...</div>
                                    <div *ngIf="detailsError()" class="error-box small">{{ detailsError() }}</div>

                                    <!-- תוכן -->
                                    <div *ngIf="!detailsLoading() && !detailsError()">

                                        <!-- ===== שיעורים שחויבו ===== -->
                                        <div class="details-section">
                                            <div class="section-title">שיעורים שחויבו</div>

                                            <div *ngIf="detailsItems().length; else noItemsTpl" class="mini-table-wrap">
                                                <table class="mini-table">
                                                    <thead>
                                                        <tr>
                                                            <th>תאריך שיעור</th>
                                                            <th>שעה</th>
                                                            <th>הרוכב</th>
                                                            <th>מחיר ליח'</th>
                                                            <th>כמות</th>
                                                            <th>סכום</th>
                                                        </tr>
                                                    </thead>

                                                    <tbody>
                                                        <tr *ngFor="let it of detailsItems()">
                                                            <td>{{ it.occur_date }}</td>
                                                            <td>{{ it.start_datetime | date:'HH:mm' }}</td>
                                                            <td>{{ it.child_id }}</td>
                                                            <td>{{ formatShekelsFromAgorot(it.unit_price_agorot) }}</td>
                                                            <td>{{ it.quantity }}</td>
                                                            <td><b>{{ formatShekelsFromAgorot(it.amount_agorot) }}</b>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>

                                            <ng-template #noItemsTpl>
                                                <div class="empty-state">אין שורות חיוב לשיעורים בחיוב הזה.</div>
                                            </ng-template>
                                        </div>

                                        <!-- ===== זיכויים על החיוב ===== -->
                                        <div class="details-section">
                                            <div class="section-title">זיכויים</div>

                                            <div *ngIf="detailsCredits().length; else noCreditsTpl"
                                                class="mini-table-wrap">
                                                <table class="mini-table">
                                                    <thead>
                                                        <tr>
                                                            <th>תאריך</th>
                                                            <th>סכום זיכוי</th>
                                                            <th>סיבה</th>
                                                            <th>נוצר ע"י</th>
                                                        </tr>
                                                    </thead>

                                                    <tbody>
                                                        <tr *ngFor="let cr of detailsCredits()">
                                                            <td>{{ cr.created_at | date:'yyyy-MM-dd HH:mm' }}</td>
                                                            <td class="credit-amt"><b>-{{
                                                                    formatShekelsFromAgorot(cr.amount_agorot) }}</b>
                                                            </td>
                                                            <td>{{ cr.reason || '-' }}</td>
                                                            <td>{{ cr.created_by || '-' }}</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>

                                            <ng-template #noCreditsTpl>
                                                <div class="empty-state">אין זיכויים משויכים לחיוב הזה.</div>
                                            </ng-template>
                                        </div>

                                        <!-- סיכום קטן (אופציונלי) -->
                                        <div class="details-summary">
                                            <span class="pill">
                                                סכום חיוב: <b>{{ formatShekelsFromAgorot(c.charge_amount_agorot) }}</b>
                                            </span>

                                            <span class="pill" *ngIf="detailsCreditsTotalAgorot() > 0">
                                                סה״כ זיכויים בחיוב: <b>-{{
                                                    formatShekelsFromAgorot(detailsCreditsTotalAgorot()) }}</b>
                                            </span>
                                        </div>

                                    </div>
                                </div>
                            </td>
                        </tr>
                    </ng-container>
                </tbody>
            </table>
        </div>

        <!-- בלוק זיכוי -->
        <div class="credit-card">
            <h3>הוספת זיכוי</h3>
            <div class="pill" *ngIf="creditParentUid()">
                עבור: <b>{{ creditParentName() }}</b>
            </div>

            <p class="hint">
                הזיכוי נרשם כשורת תשלום שלילית ומקוזז מהחיובים הקיימים והעתידיים.
            </p>

            <div *ngIf="creditError()" class="error-box small">
                {{ creditError() }}
            </div>
            <div *ngIf="creditSuccess()" class="success-box small">
                {{ creditSuccess() }}
            </div>

            <div class="credit-form">
                <div class="field">
                    <label>סכום הזיכוי (₪)</label>
                    <input type="number" min="0" step="0.01" [ngModel]="creditAmount()"
                        (ngModelChange)="creditAmount.set($event)" placeholder="לדוגמה: 50" />
                </div>

                <div class="field">
                    <label>סיבה לזיכוי</label>
                    <textarea rows="2" [ngModel]="creditReason()" (ngModelChange)="creditReason.set($event)"
                        placeholder="לדוגמה: שיעור שבוטל באחריות החווה"></textarea>
                </div>

                <div class="actions">
                    <button class="secondary-btn" type="button" [disabled]="creditSaving()" (click)="submitCredit()">
                        {{ creditSaving() ? 'שומר...' : 'שמירת זיכוי' }}
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<ng-template #emptyTpl>
    <div class="empty-state">
        אין חיובים להצגה.
    </div>
</ng-template>

<ng-template #loadingTpl>
    <div class="card loading-card">
        טוען חיובים...
    </div>
</ng-template>
<div class="page">
  <h2>מרכז הודעות</h2>

  <nav class="tabs">
    <button [class.active]="tab()==='inbox'" (click)="tab.set('inbox'); loadInbox()">הודעות נכנסות</button>
    <button [class.active]="tab()==='compose'" (click)="tab.set('compose')">כתיבת הודעה</button>
    <button [class.active]="tab()==='sent'" (click)="tab.set('sent'); loadSent()">הודעות שנשלחו</button>
  </nav>

  <section *ngIf="tab()==='inbox'">
    <div class="split">
      <aside class="list">
        <div class="row" *ngFor="let c of inbox()" (click)="openConversation(c)" [class.active]="activeConv()?.id===c.id">
          <div class="title">{{c.subject || 'ללא נושא'}}</div>
          <div class="meta">
            <span class="badge" [class.open]="c.status==='open'" [class.pending]="c.status==='pending'" [class.closed]="c.status==='closed'">
              {{c.status}}
            </span>
            <span class="time">{{c.updated_at | date:'short'}}</span>
          </div>
        </div>
        <div *ngIf="loadingInbox()">טוען…</div>
      </aside>

      <main class="thread" *ngIf="activeConv(); else pickConv">
        <header>
          <h3>{{activeConv()?.subject || 'שיחה'}}</h3>
          <span class="muted">{{activeConv()?.updated_at | date:'short'}}</span>
        </header>

        <article class="msg" *ngFor="let m of thread()">
          <div class="meta">
            <strong>{{m.sender_role}}</strong>
            <small>{{m.created_at | date:'short'}}</small>
          </div>
          <div class="body" [innerHTML]="m.body_md"></div>
        </article>

        <footer class="reply">
          <textarea [(ngModel)]="replyTextModel" placeholder="כתבי תשובה..."></textarea>
          <button (click)="sendReply()" [disabled]="!replyText().trim()">שלחי</button>
        </footer>
      </main>

      <ng-template #pickConv>
        <div class="empty">בחרי שיחה כדי לצפות</div>
      </ng-template>
    </div>
  </section>

  <section *ngIf="tab()==='compose'">
    <div class="form">
      <label>נושא
        <input [(ngModel)]="compose.subject" placeholder="נושא ההודעה">
      </label>

      <label>תוכן ההודעה
        <textarea [(ngModel)]="compose.body" rows="6" placeholder="כתבי את תוכן ההודעה..."></textarea>
      </label>

      <fieldset>
        <legend>ערוצים</legend>
        <label><input type="checkbox" [(ngModel)]="compose.channelInApp"> In-App</label>
        <label><input type="checkbox" [(ngModel)]="compose.channelEmail"> Email</label>
        <label><input type="checkbox" [(ngModel)]="compose.channelSms"> SMS</label>
      </fieldset>

      <fieldset>
        <legend>קהל יעד</legend>
        <label><input type="radio" name="aud" [(ngModel)]="compose.audienceType" value="all"> כל ההורים</label>
        <label><input type="radio" name="aud" [(ngModel)]="compose.audienceType" value="manual"> בחירה ידנית</label>
        <label><input type="radio" name="aud" [(ngModel)]="compose.audienceType" value="single"> הורה בודד</label>

        <div *ngIf="compose.audienceType==='manual'">
          <small>הפרידי UID-ים בפסיק</small>
          <input [(ngModel)]="compose.manualUids" placeholder="uid1, uid2, ...">
        </div>
        <div *ngIf="compose.audienceType==='single'">
          <input [(ngModel)]="compose.singleUid" placeholder="UID של הורה">
        </div>
      </fieldset>

      <label>תזמון (אופציונלי)
        <input type="datetime-local" [(ngModel)]="compose.scheduledAt">
      </label>

      <button (click)="doSend()" [disabled]="sending() || !compose.body.trim()">שליחה</button>
      <span class="toast" *ngIf="toast()">{{toast()}}</span>
    </div>
  </section>

  <section *ngIf="tab()==='sent'">
    <table class="sent">
      <thead>
        <tr>
          <th>נושא</th><th>סטטוס</th><th>נשלח</th><th>ערוצים</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let m of sent()">
          <td>{{m.subject || 'ללא נושא'}}</td>
          <td>{{m.status}}</td>
          <td>{{m.sent_at || m.scheduled_at | date:'short'}}</td>
          <td>
            <span *ngIf="m.channel_inapp">In-App</span>
            <span *ngIf="m.channel_email"> · Email</span>
            <span *ngIf="m.channel_sms"> · SMS</span>
          </td>
        </tr>
      </tbody>
    </table>
    <div *ngIf="loadingSent()">טוען…</div>
  </section>
</div>

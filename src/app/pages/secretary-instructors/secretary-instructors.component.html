<div class="page-header">
  <h2>רשימת מדריכים</h2>

  <button type="button" class="fab-round" (click)="openAddInstructorDialog()" aria-label="הוספת מדריך/ה חדש/ה"
    title="הוספת מדריך חדש">
    +
  </button>
</div>

<!-- שורת חיפוש -->
<div class="search-shell">
  <div class="simple-search-bar" (click)="toggleSearchPanelFromBar()">
    <span class="search-icon" title="חיפוש" (click)="toggleFromSearchIcon($event)">
      <svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" viewBox="0 0 24 24" fill="#6e7462">
        <path
          d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16a6.471 6.471 0 0 0 4.23-1.57l.27.28v.79l5 5L20.49 19l-5-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
      </svg>
    </span>

    <input type="text" class="simple-search-input" [(ngModel)]="searchText" placeholder="חיפוש מדריך"
      (click)="$event.stopPropagation()" />

    <span class="filter-icon" title="סינון" (click)="toggleFromFilterIcon($event)">
      <svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" viewBox="0 0 24 24" fill="#6e7462">
        <path d="M10 18h4v-2h-4v2zm-7-8v2h18v-2H3zm3-6v2h12V4H6z" />
      </svg>
    </span>
  </div>

  <div *ngIf="showSearchPanel" class="search-panel" (click)="$event.stopPropagation()">
    <div class="panel-section" [class.active]="panelFocus === 'search'">
      <div class="panel-title">חיפוש</div>

      <label class="panel-option">
        <input type="radio" name="searchMode" value="name" [(ngModel)]="searchMode" />
        חיפוש לפי שם מדריך/ה
      </label>

      <label class="panel-option">
        <input type="radio" name="searchMode" value="id" [(ngModel)]="searchMode" />
        חיפוש מדויק לפי תעודת זהות
      </label>

      <div class="panel-hint">ההקלדה בשורה למעלה מחפשת לפי האפשרות שנבחרה.</div>
    </div>

    <hr />

    <div class="panel-section" [class.active]="panelFocus === 'filter'">
      <div class="panel-title">סינון</div>

      <label class="panel-label">סטטוס מדריך</label>
      <select [(ngModel)]="statusFilter">
        <option value="all">כל המדריכים</option>
        <option value="active">מדריכים פעילים</option>
        <option value="inactive">מדריכים לא פעילים</option>
      </select>

      <label class="panel-label">קבלת שיעורי השלמה</label>
      <select [(ngModel)]="makeupFilter">
        <option value="all">ללא סינון</option>
        <option value="accepts">מקבלים רוכבים משלימים</option>
        <option value="not_accepts">לא מקבלים השלמות</option>
      </select>

      <label class="panel-label">מין מדריך</label>
      <select [(ngModel)]="genderFilter">
        <option value="all">כולם</option>
        <option value="male">מדריכים</option>
        <option value="female">מדריכות</option>
        <option value="other">אחר</option>
      </select>
    </div>

    <button type="button" class="panel-clear" (click)="clearFilters()">איפוס חיפוש וסינון</button>
  </div>
</div>

<div *ngIf="isLoading" class="loading-state">טוען נתונים... ⏳</div>
<div *ngIf="error" class="error-state">שגיאה: {{ error }}</div>

<div *ngIf="!isLoading && !error && instructors.length > 0">
  <table>
    <thead>
      <tr>
        <th>שם פרטי</th>
        <th>שם משפחה</th>
        <th>טלפון</th>
        <th>אימייל</th>
        <th>סטטוס</th>
        <th>מקבל השלמות</th>
      </tr>
    </thead>

    <tbody>
      <tr *ngFor="let ins of filteredInstructors" (click)="openDetails(ins.id_number)" class="clickable-row">
        <td>{{ ins.first_name }}</td>
        <td>{{ ins.last_name }}</td>
        <td>{{ ins.phone || '—' }}</td>
        <td>{{ ins.email || '—' }}</td>
        <td>{{ statusLabel(ins.status) }}</td>
        <td>{{ ins.accepts_makeup_others ? 'כן' : 'לא' }}</td>
      </tr>
    </tbody>
  </table>
</div>

<div *ngIf="!isLoading && !error && (instructors?.length ?? 0) === 0" class="empty-state">
  לא נמצאו מדריכים בחווה.
</div>

<!-- ================= מגירה ================= -->
<!-- מגירה עם פרטי מדריך -->
<mat-sidenav-container class="drawer-container" dir="rtl" [hasBackdrop]="false"
  [class.drawer-open]="!!selectedIdNumber">
  <mat-sidenav #drawer mode="side" position="end" class="drawer-pane" [opened]="!!selectedIdNumber">
    <!-- HEADER -->
    <div class="drawer-header">
      <div class="drawer-title">
        <div class="drawer-title-text">פרטי מדריך/ה</div>
        <div class="drawer-subtitle" *ngIf="drawerInstructor as ins">
          {{ ins.first_name }} {{ ins.last_name }}
        </div>
      </div>

      <button class="close-btn" type="button" (click)="closeDetails()">✕</button>
    </div>

    <div class="drawer-mode" *ngIf="drawerInstructor">

      <ng-container *ngIf="!editMode; else editTopActions">
        <span class="mode-pill active">מצב צפייה</span>

        <button type="button" class="edit-primary" (click)="startEditFromDrawer()">
          עריכה
        </button>
      </ng-container>

      <ng-template #editTopActions>
        <span class="mode-pill active">מצב עריכה</span>

        <button type="button" class="top-action secondary" (click)="cancelEditFromDrawer()" [disabled]="savingEdit">
          ביטול
        </button>

        <button type="button" class="top-action primary" (click)="saveEditFromDrawer()" [disabled]="savingEdit">
          {{ savingEdit ? 'שומר...' : 'שמור' }}
        </button>
      </ng-template>

    </div>



    <div *ngIf="drawerLoading" class="hint">טוען פרטים...</div>

    <!-- BODY -->
    <ng-container *ngIf="!drawerLoading && drawerInstructor as ins">
      <div class="drawer-body" *ngIf="!editMode; else editForm">

        <!-- פרטים אישיים -->
        <div class="section-card">
          <div class="section-title">פרטים אישיים</div>

          <div class="fields-grid">
            <div class="field">
              <label>שם מלא</label>
              <div class="val">{{ ins.first_name }} {{ ins.last_name }}</div>
            </div>

            <div class="field">
              <label>תעודת זהות</label>
              <div class="val" dir="ltr">{{ ins.id_number || '—' }}</div>
            </div>

            <div class="field">
              <label>טלפון</label>
              <div class="val" dir="ltr">{{ ins.phone || '—' }}</div>
            </div>

            <div class="field">
              <label>אימייל</label>
              <div class="val" dir="ltr">{{ ins.email || '—' }}</div>
            </div>

            <div class="field">
              <label>תאריך לידה</label>
              <div class="val">{{ ins.birth_date || '—' }}</div>
            </div>

            <div class="field">
              <label>מין</label>
              <div class="val">{{ ins.gender || '—' }}</div>
            </div>
          </div>
        </div>

        <!-- סטטוס והרשאות -->
        <div class="section-card">
          <div class="section-title">סטטוס והרשאות</div>

          <div class="fields-grid">
            <div class="field">
              <label>סטטוס</label>
              <div class="val">{{ statusLabel(ins.status) }}</div>
            </div>

            <div class="field">
              <label>יכול לערוך זמינות</label>
              <div class="val">{{ ins.allow_availability_edit ? 'כן' : 'לא' }}</div>
            </div>

            <div class="field colspan">
              <label>מקבל שיעורי השלמה</label>
              <div class="val">{{ ins.accepts_makeup_others ? 'כן' : 'לא' }}</div>
            </div>
          </div>
        </div>

        <!-- פרטים מקצועיים -->
        <div class="section-card">
          <div class="section-title">פרטים מקצועיים</div>

          <div class="fields-grid">
            <div class="field">
              <label>רישיון מדריך</label>
              <div class="val">{{ ins.license_id || '—' }}</div>
            </div>

            <div class="field">
              <label>השכלה</label>
              <div class="val">{{ ins.education || '—' }}</div>
            </div>

            <div class="field">
              <label>טווח גילאים לבנים</label>
              <div class="val">
                <ng-container *ngIf="(ins.taught_child_genders ?? []).includes('זכר'); else noMale">
                  {{ ins.min_age_years_male ?? '—' }} - {{ ins.max_age_years_male ?? '—' }}
                </ng-container>
                <ng-template #noMale>—</ng-template>
              </div>
            </div>

            <div class="field">
              <label>טווח גילאים לבנות</label>
              <div class="val">
                <ng-container *ngIf="(ins.taught_child_genders ?? []).includes('נקבה'); else noFemale">
                  {{ ins.min_age_years_female ?? '—' }} - {{ ins.max_age_years_female ?? '—' }}
                </ng-container>
                <ng-template #noFemale>—</ng-template>
              </div>
            </div>


            <div class="field colspan" *ngIf="(ins.taught_child_genders ?? []).length">
              <label>מלמד רוכבים/ות</label>
              <div class="val">{{ (ins.taught_child_genders ?? []).join(', ') }}</div>
            </div>
          </div>
        </div>

        <!-- פרטים נוספים -->
        <div class="section-card">
          <div class="section-title">פרטים נוספים</div>

          <div class="fields-grid one-col">
            <div class="field">
              <label>כתובת</label>
              <div class="val">{{ ins.address || '—' }}</div>
            </div>

            <div class="field">
              <label>על המדריך</label>
              <div class="val prewrap">{{ ins.about || '—' }}</div>
            </div>
          </div>
        </div>

        <!-- קבצים -->
        <div class="section-card" *ngIf="ins.certificate || ins.photo_url">
          <div class="section-title">קבצים</div>

          <div class="fields-grid one-col">
            <div class="field" *ngIf="ins.certificate">
              <label>תעודה / קובץ הסמכה</label>
              <div class="val">
                <a [href]="ins.certificate" target="_blank">פתיחת תעודה</a>
              </div>
            </div>

            <div class="field" *ngIf="ins.photo_url">
              <label>תמונה</label>
              <div class="val">
                <img [src]="ins.photo_url" alt="תמונת מדריך" class="instructor-photo" />
              </div>
            </div>
          </div>
        </div>

        <!-- לו"ז שבועי -->
        <div class="section-card">
          <div class="section-title">לו"ז שבועי</div>

          <div class="work-table">
            <div class="work-header-row">
              <div>יום</div>
              <div>שעת התחלה</div>
              <div>שעת סיום</div>
              <div>סוג שיעור</div>
            </div>

            <div class="work-row" *ngFor="let slot of drawerAvailability">
              <div>{{ dayOfWeekToLabel(slot.day_of_week) }}</div>
              <div>{{ slot.start_time | slice:0:5 }}</div>
              <div>{{ slot.end_time | slice:0:5 }}</div>
              <div>{{ lessonTypeLabel(slot.lesson_type_mode) }}</div>
            </div>

            <div class="work-row" *ngIf="!(drawerAvailability?.length)">
              <div>—</div>
              <div>—</div>
              <div>—</div>
              <div>—</div>
            </div>
          </div>
        </div>
      </div>

      <!-- EDIT -->
      <ng-template #editForm>
        <div class="drawer-body" *ngIf="editModel as m">

          <div class="section-card">
            <div class="section-title">פרטים אישיים</div>

            <div class="fields-grid">
              <div class="field">
                <label>שם פרטי *</label>
                <input class="field-input" type="text" [(ngModel)]="m.first_name" />
              </div>

              <div class="field">
                <label>שם משפחה *</label>
                <input class="field-input" type="text" [(ngModel)]="m.last_name" />
              </div>

              <div class="field">
                <label>תעודת זהות</label>
                <div class="val" dir="ltr">{{ ins.id_number || '—' }}</div>
              </div>

              <div class="field">
                <label>תאריך לידה</label>
                <div class="val">{{ m.birth_date || '—' }}</div>
              </div>

              <div class="field">
                <label>טלפון *</label>
                <input class="field-input" type="tel" [(ngModel)]="m.phone" />
              </div>

              <div class="field">
                <label>אימייל *</label>
                <input class="field-input" type="email" [(ngModel)]="m.email" />
              </div>
            </div>
          </div>

          <div class="section-card">
            <div class="section-title">סטטוס והרשאות</div>

            <div class="fields-grid">
              <div class="field">
                <label>סטטוס</label>
                <select class="field-input" [(ngModel)]="m.status">
                  <option *ngFor="let opt of statusOptions" [ngValue]="opt.value">
                    {{ opt.label }}
                  </option>
                </select>
              </div>

              <div class="field">
                <label>מין</label>
                <div class="val">{{ ins.gender || '—' }}</div>
              </div>

              <div class="field">
                <label>מקבל שיעורי השלמה</label>
                <input type="checkbox" [(ngModel)]="m.accepts_makeup_others" />
              </div>

              <div class="field">
                <label>יכול לערוך זמינות</label>
                <input type="checkbox" [(ngModel)]="m.allow_availability_edit" />
              </div>
            </div>
          </div>

          <div class="section-card">
            <div class="section-title">פרטים מקצועיים</div>

            <div class="fields-grid">
              <div class="field">
                <label>השכלה</label>
                <input class="field-input" type="text" [(ngModel)]="m.education" />
              </div>

              <div class="field">
                <label>רישיון מדריך</label>
                <input class="field-input" type="text" [(ngModel)]="m.license_id" />
              </div>

              <!-- טווח לבנים -->
              <div class="range-card" [class.disabled]="!hasTaughtGender('זכר')">
                <div class="range-title">
                  טווח גילאים לבנים
                  <span class="meta-chip muted" *ngIf="!hasTaughtGender('זכר')">לא נבחר</span>
                </div>

                <div class="fields-grid three-cols">
                  <div class="field">
                    <label>מגיל</label>
                    <input class="field-input" type="number" min="0" step="1" [(ngModel)]="m.min_age_years_male"
                      [disabled]="!hasTaughtGender('זכר')" />
                  </div>

                  <div class="field">
                    <label>עד גיל</label>
                    <input class="field-input" type="number" min="0" step="1" [(ngModel)]="m.max_age_years_male"
                      [disabled]="!hasTaughtGender('זכר')" />
                  </div>
                </div>
              </div>

              <!-- טווח לבנות -->
              <div class="range-card" [class.disabled]="!hasTaughtGender('נקבה')">
                <div class="range-title">
                  טווח גילאים לבנות
                  <span class="meta-chip muted" *ngIf="!hasTaughtGender('נקבה')">לא נבחר</span>
                </div>

                <div class="fields-grid three-cols">
                  <div class="field">
                    <label>מגיל</label>
                    <input class="field-input" type="number" min="0" step="1" [(ngModel)]="m.min_age_years_female"
                      [disabled]="!hasTaughtGender('נקבה')" />
                  </div>

                  <div class="field">
                    <label>עד גיל</label>
                    <input class="field-input" type="number" min="0" step="1" [(ngModel)]="m.max_age_years_female"
                      [disabled]="!hasTaughtGender('נקבה')" />
                  </div>
                </div>
              </div>


              <div class="field colspan">
                <label>מלמד רוכבים/ות</label>
                <div class="chips-row">
                  <label>
                    <input type="checkbox" [checked]="hasTaughtGender('זכר')"
                      (change)="onTaughtGenderChange('זכר', $any($event.target).checked)" />
                    רוכבים (זכר)
                  </label>
                  <label>
                    <input type="checkbox" [checked]="hasTaughtGender('נקבה')"
                      (change)="onTaughtGenderChange('נקבה', $any($event.target).checked)" />
                    רוכבות (נקבה)
                  </label>
                </div>
              </div>
            </div>
          </div>

          <div class="section-card">
            <div class="section-title">פרטים נוספים</div>

            <div class="fields-grid one-col">
              <div class="field">
                <label>כתובת</label>
                <input class="field-input" type="text" [(ngModel)]="m.address" />
              </div>

              <div class="field">
                <label>על המדריך</label>
                <textarea class="field-textarea" rows="3" [(ngModel)]="m.about"></textarea>
              </div>
            </div>
          </div>

          <div class="drawer-actions">
            <button type="button" class="primary" (click)="saveEditFromDrawer()" [disabled]="savingEdit">
              {{ savingEdit ? 'שומר...' : 'שמירת שינויים' }}
            </button>

            <button type="button" class="secondary" (click)="cancelEditFromDrawer()" [disabled]="savingEdit">
              ביטול
            </button>
          </div>
        </div>
      </ng-template>
    </ng-container>
  </mat-sidenav>
  <div class="drawer-spacer"></div>
</mat-sidenav-container>
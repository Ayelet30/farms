<h2>רשימת מדריכים</h2>

<!-- שורת חיפוש כמו אצל ההורים -->
<div class="search-shell">
  <div class="simple-search-bar" (click)="toggleSearchPanelFromBar()">
    <span
      class="search-icon"
      title="חיפוש"
      (click)="toggleFromSearchIcon($event)"
    >
      <!-- svg זכוכית מגדלת -->
      <svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" viewBox="0 0 24 24" fill="#6e7462">
        <path
          d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16a6.471 6.471 0 0 0 4.23-1.57l.27.28v.79l5 5L20.49 19l-5-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"
        />
      </svg>
    </span>

    <input
      type="text"
      class="simple-search-input"
      [(ngModel)]="searchText"
      placeholder="חיפוש מדריך"
      (click)="$event.stopPropagation()"
    />

    <span
      class="filter-icon"
      title="סינון"
      (click)="toggleFromFilterIcon($event)"
    >
      <!-- svg פילטר -->
      <svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" viewBox="0 0 24 24" fill="#6e7462">
        <path d="M10 18h4v-2h-4v2zm-7-8v2h18v-2H3zm3-6v2h12V4H6z" />
      </svg>
    </span>
  </div>

  <div
    *ngIf="showSearchPanel"
    class="search-panel"
    (click)="$event.stopPropagation()"
  >
    <div class="panel-section" [class.active]="panelFocus === 'search'">
      <div class="panel-title">חיפוש</div>

      <label class="panel-option">
        <input
          type="radio"
          name="searchMode"
          value="name"
          [(ngModel)]="searchMode"
        />
        חיפוש לפי שם מדריך/ה
      </label>

      <label class="panel-option">
        <input
          type="radio"
          name="searchMode"
          value="id"
          [(ngModel)]="searchMode"
        />
        חיפוש מדויק לפי תעודת זהות
      </label>

      <div class="panel-hint">
        ההקלדה בשורה למעלה מחפשת לפי האפשרות שנבחרה.
      </div>
    </div>

    <hr />

    <div class="panel-section" [class.active]="panelFocus === 'filter'">
      <div class="panel-title">סינון</div>

      <label class="panel-label">סטטוס מדריך</label>
      <select [(ngModel)]="statusFilter">
        <option value="all">כל המדריכים</option>
        <option value="active">מדריכים פעילים</option>
        <option value="inactive">מדריכים לא פעילים</option>
      </select>

      <label class="panel-label">קבלת שיעורי השלמה</label>
      <select [(ngModel)]="makeupFilter">
        <option value="all">ללא סינון</option>
        <option value="accepts">מקבלים רוכבים משלימים</option>
        <option value="not_accepts">לא מקבלים השלמות</option>
      </select>

      <label class="panel-label">מין מדריך</label>
      <select [(ngModel)]="genderFilter">
        <option value="all">כולם</option>
        <option value="male">מדריכים</option>
        <option value="female">מדריכות</option>
        <option value="other">אחר</option>
      </select>
    </div>

    <button type="button" class="panel-clear" (click)="clearFilters()">
      איפוס חיפוש וסינון
    </button>
  </div>
</div>

<button
  class="fab"
  (click)="openAddInstructorDialog()"
  title="הוספת מדריך חדש"
>
  ＋
</button>

<div *ngIf="isLoading" class="loading-state">טוען נתונים... ⏳</div>

<div *ngIf="error" class="error-state">שגיאה: {{ error }}</div>

<div
  *ngIf="!isLoading && !error && instructors.length > 0"
>
  <table>
    <thead>
      <tr>
        <th>שם פרטי</th>
        <th>שם משפחה</th>
        <th>טלפון</th>
        <th>אימייל</th>
        <th>סטטוס</th>
        <th>מקבל השלמות</th>
      </tr>
    </thead>
    <tbody>
      <tr
        *ngFor="let ins of filteredInstructors"
        (click)="openDetails(ins.id_number)"
        class="clickable-row"
      >
        <td>{{ ins.first_name }}</td>
        <td>{{ ins.last_name }}</td>
        <td>{{ ins.phone || '—' }}</td>
        <td>{{ ins.email || '—' }}</td>
        <td>{{ ins.status || '—' }}</td>
        <td>
          {{ ins.accepts_makeup_others ? 'כן' : 'לא' }}
        </td>
      </tr>
    </tbody>
  </table>
</div>

<div
  *ngIf="!isLoading && !error && (instructors?.length ?? 0) === 0"
  class="empty-state"
>
  לא נמצאו מדריכים בחווה.
</div>

<!-- מגירה עם פרטי מדריך -->
<mat-sidenav-container
  class="drawer-container"
  dir="rtl"
  [hasBackdrop]="false"
  [class.drawer-open]="!!selectedIdNumber"
>
  <mat-sidenav
    #drawer
    mode="side"
    position="end"
    class="drawer-pane"
    [opened]="!!selectedIdNumber"
  >
    <div class="drawer-header">
  <!-- כפתור עריכה – רק כשיש מדריך טעון ולא במצב עריכה -->
  <button
    type="button"
    class="edit-btn"
    *ngIf="drawerInstructor && !editMode"
    (click)="startEditFromDrawer()"
  >
    עריכה
  </button>

  <h3>פרטי מדריך</h3>

  <button class="close-btn" (click)="closeDetails()">✕</button>
</div>


<div *ngIf="drawerLoading" class="hint">טוען פרטים...</div>

<!-- אם נטען מדריך למגירה -->
<ng-container *ngIf="!drawerLoading && drawerInstructor as ins">

  <!-- ===== מצב תצוגה בלבד (קריאה) ===== -->
  <section class="grid2" *ngIf="!editMode; else editForm">
    <div>
      <label>שם מלא</label>
      <div class="val">
        {{ ins.first_name }} {{ ins.last_name }}
      </div>
    </div>

    <div>
      <label>תעודת זהות</label>
      <div class="val">{{ ins.id_number || '—' }}</div>
    </div>

    <div>
      <label>טלפון</label>
      <div class="val">{{ ins.phone || '—' }}</div>
    </div>

    <div>
      <label>אימייל</label>
      <div class="val">{{ ins.email || '—' }}</div>
    </div>

    <div>
      <label>סטטוס</label>
      <div class="val">{{ ins.status || '—' }}</div>
    </div>

    <div>
      <label>מין</label>
      <div class="val">{{ ins.gender || '—' }}</div>
    </div>

 
 <div>
  <label>תאריך לידה</label>
  <div class="val">{{ ins.birth_date || '—' }}</div>
</div>


    <div>
      <label>רישיון מדריך</label>
      <div class="val">{{ ins.license_id || '—' }}</div>
    </div>

    <div>
      <label>השכלה</label>
      <div class="val">{{ ins.education || '—' }}</div>
    </div>
    <div>
      <label>גיל מינימלי</label>
      <div class="val">{{ ins.min_age_years || '—' }}</div>
    </div>

    <div>
      <label>גיל מקסימלי</label>
      <div class="val">{{ ins.max_age_years || '—' }}</div>
    </div>

    <div>
      <label>מקבל שיעורי השלמה מאחרים</label>
      <div class="val">
        {{ ins.accepts_makeup_others ? 'כן' : 'לא' }}
      </div>
    </div>

    <div>
      <label>יכול לערוך זמינות</label>
      <div class="val">
        {{ ins.allow_availability_edit ? 'כן' : 'לא' }}
      </div>
    </div>



    <div class="colspan">
      <label>כתובת</label>
      <div class="val">{{ ins.address || '—' }}</div>
    </div>

    <div class="colspan">
      <label>על המדריך</label>
      <div class="val prewrap">{{ ins.about || '—' }}</div>
    </div>

    <div class="colspan" *ngIf="ins.taught_child_genders?.length">
      <label>מלמד רוכבים/ות</label>
      <div class="val">
        {{ ins!.taught_child_genders!.join(', ') }}
      </div>
    </div>

    <div class="colspan" *ngIf="ins.certificate">
      <label>תעודה / קובץ הסמכה</label>
      <div class="val">
        <a [href]="ins.certificate" target="_blank">פתיחת תעודה</a>
      </div>
    </div>

    <div class="colspan" *ngIf="ins.photo_url">
      <label>תמונה</label>
      <div class="val">
        <img
          [src]="ins.photo_url"
          alt="תמונת מדריך"
          class="instructor-photo"
        />
      </div>
    </div>
      <!-- ⭐ לו"ז שבועי – זמני עבודה ושיעורי רכיבה -->
  <div class="colspan">
    <label>לו"ז שבועי - זמני עבודה ושיעורים</label>

    <div class="work-table">
      <div class="work-header-row">
        <div>יום</div>
        <div>שעת התחלה</div>
        <div>שעת סיום</div>
        <div>סוג שיעור</div>
      </div>

      <!-- אם יש נתונים מהדאטהבייס – מציגים אותם -->
      <div class="work-row" *ngFor="let slot of drawerAvailability">
        <div>{{ dayOfWeekToLabel(slot.day_of_week) }}</div>
        <div>{{ slot.start_time | slice:0:5 }}</div>
        <div>{{ slot.end_time   | slice:0:5 }}</div>
        <div>{{ lessonTypeLabel(slot.lesson_type_mode) }}</div>
      </div>

      <!-- אם אין שום שורה – מציגים שורה ריקה -->
      <div class="work-row" *ngIf="!drawerAvailability || !drawerAvailability.length">
        <div>—</div>
        <div>—</div>
        <div>—</div>
        <div>—</div>
      </div>
    </div>
  </div>


  </section>

</ng-container>

<!-- ===== מצב עריכה – INLINE לפי האפיון ===== -->
<ng-template #editForm>
  <section class="grid2" *ngIf="editModel">

    <!-- שם פרטי / שם משפחה – ניתנים לעריכה -->
    <div>
      <label>שם פרטי *</label>
      <input
        class="field-input"
        type="text"
        [(ngModel)]="editModel.first_name"
      />
    </div>

    <div>
      <label>שם משפחה *</label>
      <input
        class="field-input"
        type="text"
        [(ngModel)]="editModel.last_name"
      />
    </div>

    <!-- תעודת זהות – לקריאה בלבד -->
    <div>
      <label>תעודת זהות</label>
      <div class="val">
        {{ drawerInstructor?.id_number || '—' }}
      </div>
    </div>

    <!-- תאריך לידה – לקריאה בלבד אם יהיה בעתיד -->
    <div>
      <label>תאריך לידה</label>
      <div class="val">
       drawerInstructor?.birth_date

      </div>
    </div>

    <!-- טלפון / אימייל – ניתנים לעריכה -->
    <div>
      <label>טלפון *</label>
      <input
        class="field-input"
        type="tel"
        [(ngModel)]="editModel.phone"
      />
    </div>

    <div>
      <label>אימייל *</label>
      <input
        class="field-input"
        type="email"
        [(ngModel)]="editModel.email"
      />
    </div>

    <!-- סטטוס – ניתן לעריכה -->
    <div>
      <label>סטטוס</label>
      <input
        class="field-input"
        type="text"
        [(ngModel)]="editModel.status"
      />
    </div>

    <!-- מין – לקריאה בלבד -->
    <div>
      <label>מין</label>
      <div class="val">
        {{ drawerInstructor?.gender || '—' }}
      </div>
    </div>

    <!-- כתובת – ניתנת לעריכה -->
    <div class="colspan">
      <label>כתובת</label>
      <input
        class="field-input"
        type="text"
        [(ngModel)]="editModel.address"
      />
    </div>

    <!-- השכלה + רישיון מדריך – ניתנים לעריכה -->
    <div>
      <label>השכלה</label>
      <input
        class="field-input"
        type="text"
        [(ngModel)]="editModel.education"
      />
    </div>

    <div>
      <label>רישיון מדריך</label>
      <input
        class="field-input"
        type="text"
        [(ngModel)]="editModel.license_id"
      />
    </div>

    <!-- על המדריך – ניתן לעריכה -->
    <div class="colspan">
      <label>על המדריך</label>
      <textarea
        class="field-textarea"
        rows="3"
        [(ngModel)]="editModel.about"
      ></textarea>
    </div>

    <!-- גיל מינימלי / מקסימלי – ניתנים לעריכה -->
    <div>
      <label>גיל מינימלי</label>
      <input
        class="field-input"
        type="number"
        [(ngModel)]="editModel.min_age_years"
      />
    </div>

    <div>
      <label>גיל מקסימלי</label>
      <input
        class="field-input"
        type="number"
        [(ngModel)]="editModel.max_age_years"
      />
    </div>

    <!-- מקבל השלמות / יכול לערוך זמינות – ניתנים לעריכה -->
    <div>
      <label>מקבל שיעורי השלמה ממדריכים אחרים</label>
      <input
        type="checkbox"
        [(ngModel)]="editModel.accepts_makeup_others"
      />
    </div>

    <div>
      <label>יכול לערוך זמינות</label>
      <input
        type="checkbox"
        [(ngModel)]="editModel.allow_availability_edit"
      />
    </div>

    <!-- מלמד רוכבים/ות – צ'קבוקסים -->
    <div class="colspan">
      <label>מלמד רוכבים/ות</label>
      <div class="chips-row">
        <label>
          <input
            type="checkbox"
            [checked]="hasTaughtGender('זכר')"
            (change)="onTaughtGenderChange('זכר', $any($event.target).checked)"
          />
          רוכבים (זכר)
        </label>
        <label>
          <input
            type="checkbox"
            [checked]="hasTaughtGender('נקבה')"
            (change)="onTaughtGenderChange('נקבה', $any($event.target).checked)"
          />
          רוכבות (נקבה)
        </label>
      </div>
    </div>

  </section>

  <!-- כפתורי שמירה / ביטול בתחתית המגירה -->
  <div class="drawer-actions">
    <button
      type="button"
      class="primary"
      (click)="saveEditFromDrawer()"
      [disabled]="savingEdit"
    >
      {{ savingEdit ? 'שומר...' : 'שמירת שינויים' }}
    </button>

    <button
      type="button"
      class="secondary"
      (click)="cancelEditFromDrawer()"
      [disabled]="savingEdit"
    >
      ביטול
    </button>
  </div>
</ng-template>
</mat-sidenav>

  <div></div>
</mat-sidenav-container>

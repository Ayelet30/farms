<!-- app/secretary/billing/secretary-payments.component.html -->

<div class="page-wrap">
  <div class="card header-card">
    <div class="title-block">
      <h2>תשלומים במערכת</h2>
      <p class="subtitle">
        צפייה בתשלומים שבוצעו, כולל משתמשים חיצוניים וקישורי חשבוניות.
      </p>
    </div>

    <div class="toolbar">
      <div class="search-wrap">
        <label for="search">חיפוש</label>
        <input
          id="search"
          type="text"
          [ngModel]="searchTerm()"
          (ngModelChange)="onSearchChange($event)"
          placeholder="חיפוש לפי שם, טלפון, מייל או UID..."
        />
      </div>

      <div class="summary">
        <div class="pill">
          סה״כ בעמוד:
          <span class="strong">
            {{ pageTotalAmount() | number: '1.2-2' }} ₪
          </span>
        </div>
        <div class="pill light" *ngIf="totalCount() !== null">
          {{ totalCount() }} תשלומים במערכת
        </div>
      </div>
    </div>
  </div>

  <div class="card content-card" *ngIf="!loading(); else loadingTpl">
    <div *ngIf="error()" class="error-box">
      {{ error() }}
    </div>

    <!-- דסקטופ: טבלה -->
    <div class="table-wrapper desktop-only" *ngIf="rows().length > 0">
      <table class="charges-table">
        <thead>
          <tr>
            <th>תאריך</th>
            <th>שם הורה</th>
            <th>טלפון</th>
            <th>מייל</th>
            <th>סכום</th>
            <th>סוג תשלום</th>
            <th>סטטוס משתמש</th>
            <th>חשבונית</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let r of rows()">
            <td>{{ r.date }}</td>
            <td class="parent-cell">
              <div class="parent-name">
                {{ r.parent_name || 'ללא שם' }}
              </div>
              <div class="uid" *ngIf="r.parent_uid">
                UID: {{ r.parent_uid }}
              </div>
            </td>
            <td>{{ r.parent_phone || '-' }}</td>
            <td>{{ r.parent_email || '-' }}</td>
            <td>{{ formatAmount(r.amount) }}</td>
            <td>{{ formatMethod(r.method) }}</td>
            <td>
              <span class="badge external" *ngIf="r.is_external">
                משתמש חיצוני
              </span>
              <span class="badge internal" *ngIf="!r.is_external">
                משתמש במערכת
              </span>
            </td>
           <td>
  <a
  *ngIf="r.invoice_status === 'ready'; else invBtnTpl"
  class="invoice-link"
  [href]="r.tranzila_invoice_url || r.invoice_url"
  target="_blank"
  rel="noopener noreferrer"
>
  חשבונית
</a>

<ng-template #invBtnTpl>
  <button
    type="button"
    (click)="createOrFetchInvoice(r)"
    class="btn-invoice"
  >
    הפקת חשבונית
  </button>
</ng-template>

</td>

          </tr>
        </tbody>
      </table>
    </div>

    <!-- מובייל: כרטיסיות -->
    <div class="mobile-list mobile-only" *ngIf="rows().length > 0">
      <div class="charge-card" *ngFor="let r of rows()">
        <div class="row main-row">
          <div class="left">
            <div class="parent-name">
              {{ r.parent_name || 'ללא שם' }}
            </div>
            <div class="date">תאריך: {{ r.date }}</div>
          </div>
          <div class="right">
            <div class="amount">{{ formatAmount(r.amount) }}</div>
            <div class="badge internal" *ngIf="!r.is_external">
              משתמש במערכת
            </div>
            <div class="badge external" *ngIf="r.is_external">
              משתמש חיצוני
            </div>
          </div>
        </div>

        <div class="row">
          <div class="label">טלפון:</div>
          <div class="value">{{ r.parent_phone || '-' }}</div>
        </div>
        <div class="row">
          <div class="label">מייל:</div>
          <div class="value">{{ r.parent_email || '-' }}</div>
        </div>
        <div class="row">
          <div class="label">סוג תשלום:</div>
          <div class="value">{{ formatMethod(r.method) }}</div>
        </div>
        <div class="row">
          <div class="label">UID:</div>
          <div class="value">{{ r.parent_uid || '-' }}</div>
        </div>
      <div class="row">
  <div class="label">חשבונית:</div>
  <div class="value">
    <a
  *ngIf="r.invoice_status === 'ready'; else invBtnMobileTpl"
  class="invoice-link"
  [href]="r.tranzila_invoice_url || r.invoice_url"
  target="_blank"
  rel="noopener noreferrer"
>
  פתיחת חשבונית
</a>


    <ng-template #invBtnMobileTpl>
      <button type="button" (click)="createOrFetchInvoice(r)" class="btn-invoice">
        הפקת חשבונית
      </button>
    </ng-template>
  </div>
</div>

      </div>
    </div>

    <div class="empty-state" *ngIf="!rows().length && !error()">
      אין תשלומים להצגה.
    </div>

    <!-- פאג׳ינציה -->
    <div class="pager" *ngIf="totalCount() && totalCount()! > pageSize">
      <button (click)="prevPage()" [disabled]="!canPrev()">קודם</button>
      <div class="pager-info">
        עמוד {{ pageIndex() + 1 }}
      </div>
      <button (click)="nextPage()" [disabled]="!canNext()">הבא</button>
    </div>
  </div>
</div>

<ng-template #loadingTpl>
  <div class="card loading-card">
    טוען תשלומים...
  </div>
</ng-template>

<div class="note-wrapper">
  <div class="note-overlay" (click)="onBackdropClick($event)">
    <mat-card class="child-details-card" (click)="$event.stopPropagation()">

      <!-- HEADER -->
      <mat-card-header>
        <mat-card-title>
          <mat-icon>person</mat-icon>
          פרטי הילד –
          {{ (child?.first_name || '') + ' ' + (child?.last_name || '') || child?.name || '—' }}
        </mat-card-title>

        <button mat-icon-button class="close-button" (click)="onClose()">
          <mat-icon>close</mat-icon>
        </button>
      </mat-card-header>

      <!-- WARNINGS -->
      <div class="presence-error top-warning" *ngIf="mustChooseAttendance">
        חובה לבחור נוכחות (הגיע / לא הגיע) לפני סגירת הכרטיסייה.
      </div>

      <div
        class="presence-error top-warning"
        *ngIf="!mustChooseAttendance && mustFillNoteForPresent">
        לאחר סימון "הגיע" – חובה להוסיף הערה חדשה לפני סגירת הכרטיסייה.
      </div>

      <!-- CONTENT -->
      <mat-card-content class="scrollable-content">

        <!-- ================= TOP ================= -->
        <div class="inner-section top">

          <!-- נוכחות -->
          <section *ngIf="occurrence && canEditNotes">
            <h3>נוכחות</h3>

            <div class="attendance-actions">
              <button
                mat-stroked-button
                [class.active]="attendanceStatus === 'present'"
                (click)="setAttendance('present')">
                הגיע
              </button>

              <button
                mat-stroked-button
                [class.active]="attendanceStatus === 'absent'"
                (click)="setAttendance('absent')">
                לא הגיע
              </button>

              <button
                mat-icon-button
                *ngIf="attendanceStatus"
                (click)="setAttendance(null)">
                <mat-icon>clear</mat-icon>
              </button>
            </div>
          </section>

          <!-- פרטי שיעור -->
          <section *ngIf="lessonDetails">
            <h3>פרטי שיעור</h3>

            <div class="lesson-meta-grid">
              <div class="detail-item">
                <span class="label">תאריך</span>
                <span class="value">
                  {{ occurrence?.occur_date | date:'dd/MM/yyyy' }}
                </span>
              </div>

              <div class="detail-item">
                <span class="label">שעה</span>
                <span class="value">
                  {{ lessonDetails.start_time }} – {{ lessonDetails.end_time }}
                </span>
              </div>

              <div class="detail-item">
                <span class="label">סוג שיעור</span>
                <span class="value">{{ lessonDetails.lesson_type || '—' }}</span>
              </div>

              <div class="detail-item">
                <span class="label">סטטוס</span>
                <span class="value">{{ lessonDetails.status || '—' }}</span>
              </div>
            </div>

            <div class="lesson-resources-row">
              <mat-form-field appearance="fill" class="resource-field">
                <mat-label>סוס</mat-label>
                <mat-select [(ngModel)]="lessonDetails.horse_id">
                  <mat-option [value]="null">— ללא סוס —</mat-option>
                  <mat-option *ngFor="let h of horses" [value]="h.id">
                    {{ h.name }}
                  </mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="fill" class="resource-field">
                <mat-label>מגרש</mat-label>
                <mat-select [(ngModel)]="lessonDetails.arena_id">
                  <mat-option [value]="null">— ללא מגרש —</mat-option>
                  <mat-option *ngFor="let a of arenas" [value]="a.id">
                    {{ a.name }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </div>
          </section>
        </div>

        <!-- ================= BOTTOM ================= -->
        <div class="inner-section bottom">

          <!-- הערות רפואיות -->
          <section class="note-box medical-note">
            <h4>הערות רפואיות</h4>
            <p *ngIf="!notesMedical?.length">אין הערות רפואיות.</p>
            <p *ngFor="let n of notesMedical">{{ n.display_text }}</p>
          </section>

          <!-- הערות התנהגותיות -->
          <section class="note-box behavioral-note">
            <h4>הערות התנהגותיות</h4>
            <p *ngIf="!notesBehavioral?.length">אין הערות התנהגותיות.</p>
            <p *ngFor="let n of notesBehavioral">{{ n.display_text }}</p>
          </section>

          <!-- ===== הערות שיעור (עם עריכה/מחיקה) ===== -->
          <section class="note-box general-note">
            <h4>הערות שיעורים</h4>

            <p *ngIf="!notesGeneral?.length">אין הערות שיעורים.</p>

            <div
              *ngFor="let note of notesGeneral; trackBy: trackByNote"
              class="lesson-note-card">

              <div class="note-row">

                <div *ngIf="!note.isEditing; else editTpl" class="note-text">
                  {{ note.display_text }}
                </div>

                <ng-template #editTpl>
                  <textarea
                    [(ngModel)]="note.display_text"
                    rows="2">
                  </textarea>
                </ng-template>

                <div class="actions" *ngIf="canEditNotes">
                  <button
                    mat-icon-button
                    class="edit-btn"
                    *ngIf="!note.isEditing"
                    (click)="startEdit(note)">
                    <mat-icon>edit</mat-icon>
                  </button>

                  <button
                    mat-icon-button
                    class="save-btn"
                    *ngIf="note.isEditing"
                    (click)="saveEdit(note)">
                    <mat-icon>check</mat-icon>
                  </button>

                  <button
                    mat-icon-button
                    class="delete-btn"
                    (click)="deleteNote(note.id)">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>

              <div class="note-meta">
                {{ note.instructor_name || 'מזכירה' }} ·
                {{ note.created_at | date:'dd.MM.yyyy HH:mm' }}
              </div>
            </div>
          </section>

          <!-- הוספת הערה -->
          <section class="note-box new-note" *ngIf="canEditNotes">
            <h4>הוסף הערה חדשה</h4>

            <mat-form-field appearance="fill" class="full-width">
              <mat-label>כתוב הערה</mat-label>
              <textarea matInput [(ngModel)]="newNote" rows="2"></textarea>
            </mat-form-field>

            <button mat-raised-button color="primary" (click)="addNote()">
              הוסף הערה
            </button>
          </section>

          <!-- הערות מוכנות -->
          <section class="note-box prepared-notes" *ngIf="canEditNotes">
            <h4>הערות מוכנות</h4>

            <button
              mat-stroked-button
              *ngFor="let rn of readyNotes"
              (click)="addReadyNote(rn.content)">
              {{ rn.content }}
            </button>
          </section>

        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>

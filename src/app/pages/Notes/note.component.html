<div class="note-wrapper">
<div class="note-overlay" (click)="onBackdropClick($event)">

    <mat-card class="child-details-card" (click)="$event.stopPropagation()">

      <!-- HEADER -->
      <mat-card-header>
        <mat-card-title>
          <mat-icon>person</mat-icon>
          ×¤×¨×˜×™ ×”×™×œ×“ â€“
       {{ (childDetails?.first_name || '') + ' ' + (childDetails?.last_name || '') || 'â€”' }}

        </mat-card-title>

     <button mat-icon-button class="close-button" (click)="tryClose()">
  <mat-icon>close</mat-icon>
</button>


      </mat-card-header>
<button
  mat-icon-button
  *ngIf="attendanceStatus"
  (click)="clearAttendance()">
  <mat-icon>clear</mat-icon>
</button>

      <!-- WARNINGS -->
<!-- WARNINGS -->
<div
  class="presence-error top-warning"
  *ngIf="!occurrence?.isCancelled && mustChooseAttendance">
  ×—×•×‘×” ×œ×‘×—×•×¨ × ×•×›×—×•×ª (×”×’×™×¢ / ×œ× ×”×’×™×¢) ×œ×¤× ×™ ×¡×’×™×¨×ª ×”×›×¨×˜×™×¡×™×™×”.
</div>

<div
  class="presence-error top-warning"
  *ngIf="!occurrence?.isCancelled && !mustChooseAttendance && mustFillNoteForPresent">
  ×œ××—×¨ ×¡×™××•×Ÿ "×”×’×™×¢" â€“ ×—×•×‘×” ×œ×”×•×¡×™×£ ×”×¢×¨×” ×—×“×©×” ×œ×¤× ×™ ×¡×’×™×¨×ª ×”×›×¨×˜×™×¡×™×™×”.
</div>


      <!-- CONTENT -->
      <mat-card-content class="scrollable-content">
<!-- ================= ×¤×¨×˜×™ ×™×œ×“ ================= -->
<!-- ================= ×¤×¨×˜×™ ×™×œ×“ ================= -->
<section class="child-details" *ngIf="childDetails">

  <h3 class="section-title">
    <mat-icon>person</mat-icon>
    ×¤×¨×˜×™ ×”×™×œ×“
  </h3>

  <div class="child-grid">

    <div class="child-item">
      <mat-icon>badge</mat-icon>
      <div>
        <span class="label">×©×</span>
        <span class="value">
          {{ childDetails.first_name }} {{ childDetails.last_name }}
        </span>
      </div>
    </div>

    <div class="child-item" *ngIf="childDetails.birth_date">
      <mat-icon>cake</mat-icon>
      <div>
        <span class="label">×’×™×œ</span>
        <span class="value">
          {{ getChildAge(childDetails.birth_date) }}
        </span>
      </div>
    </div>

    <div class="child-item" *ngIf="childDetails.parent_name">
      <mat-icon>supervisor_account</mat-icon>
      <div>
        <span class="label">×”×•×¨×”</span>
        <span class="value">{{ childDetails.parent_name }}</span>
      </div>
    </div>

    <div class="child-item" *ngIf="childDetails.parent_phone">
      <mat-icon>phone</mat-icon>
      <div>
        <span class="label">×˜×œ×¤×•×Ÿ</span>
        <span class="value">{{ childDetails.parent_phone }}</span>
      </div>
    </div>

    <div class="child-item full-width" *ngIf="childDetails.parent_email">
      <mat-icon>email</mat-icon>
      <div>
        <span class="label">××™××™×™×œ</span>
        <span class="value">{{ childDetails.parent_email }}</span>
      </div>
    </div>

  </div>
</section>


        <!-- ================= TOP ================= -->
       <div class="inner-section top lesson-details">


          <!-- × ×•×›×—×•×ª -->
          <section *ngIf="occurrence && canEditNotes && !occurrence?.isCancelled">

            <h3>× ×•×›×—×•×ª</h3>

<div class="attendance-actions">

  <!-- ××–×”×¨×” -->
  <div
    class="presence-error top-warning"
    *ngIf="showEarlyAttendanceWarning">
    ×œ× × ×™×ª×Ÿ ×œ×”×›× ×™×¡ × ×•×›×—×•×ª ××•×§×“× ×›×œÖ¾×›×š
  </div>

  <!-- ×”×’×™×¢ -->
  <div (click)="onAttendanceAttempt()">
    <button
      mat-stroked-button
      [disabled]="!canMarkAttendanceNow()"
      [class.active]="attendanceStatus === 'present'"
      (click)="setAttendance('present')">
      ×”×’×™×¢
    </button>
  </div>

  <!-- ×œ× ×”×’×™×¢ -->
  <div (click)="onAttendanceAttempt()">
    <button
      mat-stroked-button
      class="absent"
      [disabled]="!canMarkAttendanceNow()"
      [class.active]="attendanceStatus === 'absent'"
      (click)="setAttendance('absent')">
      ×œ× ×”×’×™×¢
    </button>
  </div>

  <!-- × ×™×§×•×™ -->
  <button
    mat-icon-button
    *ngIf="attendanceStatus"
    (click)="clearAttendance()">
    <mat-icon>clear</mat-icon>
  </button>

</div>

</section> <!-- âœ… ×¡×’×™×¨×” ×©×œ × ×•×›×—×•×ª -->

<!-- ×¤×¨×˜×™ ×©×™×¢×•×¨ -->
<section *ngIf="lessonDetails">
            <h3>×¤×¨×˜×™ ×©×™×¢×•×¨</h3>

            <div class="lesson-meta-grid">
              <div class="detail-item">
                <span class="label">×ª××¨×™×š</span>
                <span class="value">
                  {{ occurrence?.occur_date | date:'dd/MM/yyyy' }}
                </span>
              </div>

          <div class="detail-item">
  <span class="label">×©×¢×”</span>
  <span class="value">
    {{ lessonDetails.start_time?.slice(0,5) }}
    â€“
    {{ lessonDetails.end_time?.slice(0,5) }}
  </span>
</div>


              <div class="detail-item">
                <span class="label">×¡×•×’ ×©×™×¢×•×¨</span>
                <span class="value">{{ lessonDetails.lesson_type || 'â€”' }}</span>
              </div>
<!-- ğŸ” ××–×›×™×¨×”: × ×™×ª×Ÿ ×œ×”×©×œ××” *ngIf="lessonDetails?.status === '×‘×•×˜×œ' && canEditMakeupAllowed"-->
 
<div
  class="makeup-card"
  *ngIf="lessonDetails?.status === '×‘×•×˜×œ' && canEditMakeupAllowed">

  <div class="makeup-header">
    <mat-icon>cached</mat-icon>
    <div class="makeup-text">
      <div class="title">×©×™×¢×•×¨ ××‘×•×˜×œ</div>
      <div class="subtitle">
        {{ lessonDetails.is_makeup_allowed
            ? '×©×™×¢×•×¨ ×–×” ××–×›×” ×‘×”×©×œ××”'
            : '×©×™×¢×•×¨ ×–×” ××™× ×• ××–×›×” ×‘×”×©×œ××”' }}
      </div>
    </div>
  </div>

  <!-- ğŸŸ¢ ×¨×§ ××–×›×™×¨×”/××“××™×Ÿ -->
  <mat-slide-toggle
    *ngIf="canEditMakeupAllowed"
    color="primary"
    [(ngModel)]="lessonDetails.is_makeup_allowed"
    (ngModelChange)="onMakeupAllowedChange($event)">
    × ×™×ª×Ÿ ×œ×”×©×œ××”
  </mat-slide-toggle>

  <!-- ğŸ”’ ××“×¨×™×š / ×”×•×¨×” â€“ ×ª×¦×•×’×” ×‘×œ×‘×“ -->
  <div
    *ngIf="!canEditMakeupAllowed"
    class="readonly-makeup">
    <mat-icon>
      {{ lessonDetails.is_makeup_allowed ? 'check_circle' : 'cancel' }}
    </mat-icon>
    {{ lessonDetails.is_makeup_allowed ? '×œ×”×©×œ××”' : '×œ× ×œ×”×©×œ××”' }}
  </div>

</div>

              <div class="detail-item">
                <span class="label">×¡×˜×˜×•×¡</span>
                <span class="value">{{ lessonDetails.status || 'â€”' }}</span>
              </div>
            </div>

            <div class="lesson-resources-row">
            <mat-form-field appearance="fill" class="resource-field no-floating">
  <mat-select
    placeholder="×¡×•×¡"
    [(ngModel)]="lessonDetails.horse_id"
    (selectionChange)="onHorseChange($event.value)"
    [disabled]="!canEditLessonResources">

                  <mat-option [value]="null">â€” ×œ×œ× ×¡×•×¡ â€”</mat-option>
                  <mat-option *ngFor="let h of horses" [value]="h.id">
                    {{ h.name }}
                  </mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="fill" class="resource-field">
                <mat-label>××’×¨×©</mat-label>
                <mat-select
  [(ngModel)]="lessonDetails.arena_id"
  (selectionChange)="onArenaChange($event.value)"
  [disabled]="!canEditLessonResources">

                  <mat-option [value]="null">â€” ×œ×œ× ××’×¨×© â€”</mat-option>
                  <mat-option *ngFor="let a of arenas" [value]="a.id">
                    {{ a.name }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </div>
          </section>
        </div>

        <!-- ================= BOTTOM ================= -->
        <div class="inner-section bottom">

          <!-- ×”×¢×¨×•×ª ×¨×¤×•××™×•×ª -->
          <section class="note-box medical-note">
            <h4>×”×¢×¨×•×ª ×¨×¤×•××™×•×ª</h4>
            <p *ngIf="!notesMedical?.length">××™×Ÿ ×”×¢×¨×•×ª ×¨×¤×•××™×•×ª.</p>
            <p *ngFor="let n of notesMedical">{{ n.display_text }}</p>
          </section>

          <!-- ×”×¢×¨×•×ª ×”×ª× ×”×’×•×ª×™×•×ª -->
          <section class="note-box behavioral-note">
            <h4>×”×¢×¨×•×ª ×”×ª× ×”×’×•×ª×™×•×ª</h4>
            <p *ngIf="!notesBehavioral?.length">××™×Ÿ ×”×¢×¨×•×ª ×”×ª× ×”×’×•×ª×™×•×ª.</p>
            <p *ngFor="let n of notesBehavioral">{{ n.display_text }}</p>
          </section>

          <!-- ===== ×”×¢×¨×•×ª ×©×™×¢×•×¨ (×¢× ×¢×¨×™×›×”/××—×™×§×”) ===== -->
          <section class="note-box general-note">
            <h4>×”×¢×¨×•×ª ×©×™×¢×•×¨×™×</h4>

            <p *ngIf="!notesGeneral?.length">××™×Ÿ ×”×¢×¨×•×ª ×©×™×¢×•×¨×™×.</p>

            <div
              *ngFor="let note of notesGeneral; trackBy: trackByNote"
              class="lesson-note-card">

              <div class="note-row">

                <div *ngIf="!note.isEditing; else editTpl" class="note-text">
                  {{ note.display_text }}
                </div>

                <ng-template #editTpl>
                  <textarea
                    [(ngModel)]="note.display_text"
                    rows="2">
                  </textarea>
                </ng-template>

                <div class="actions" *ngIf="canEditNotes">
                 <button class="icon-circle edit-btn" type="button">
  <mat-icon aria-hidden="true">edit</mat-icon>
</button>

                  <button
                    mat-icon-button
                    class="save-btn"
                    *ngIf="note.isEditing"
                    (click)="saveEdit(note)">
                    <mat-icon>check</mat-icon>
                  </button>

                  <button
                    mat-icon-button
                    class="delete-btn"
                    (click)="deleteNote(note.id)">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>

              <div class="note-meta">
                {{ note.instructor_name || '××–×›×™×¨×”' }} Â·
                {{ note.created_at | date:'dd.MM.yyyy HH:mm' }}
              </div>
            </div>
          </section>

          <!-- ×”×•×¡×¤×ª ×”×¢×¨×” -->
          <section class="note-box new-note" *ngIf="canEditNotes">
            <h4>×”×•×¡×£ ×”×¢×¨×” ×—×“×©×”</h4>

            <mat-form-field appearance="fill" class="full-width">
              <mat-label>×›×ª×•×‘ ×”×¢×¨×”</mat-label>
              <textarea matInput [(ngModel)]="newNote" rows="2"></textarea>
            </mat-form-field>

            <button mat-raised-button color="primary" (click)="addNote()">
              ×”×•×¡×£ ×”×¢×¨×”
            </button>
          </section>

          <!-- ×”×¢×¨×•×ª ××•×›× ×•×ª -->
          <section class="note-box prepared-notes" *ngIf="canEditNotes">
            <h4>×”×¢×¨×•×ª ××•×›× ×•×ª</h4>

            <button
              mat-stroked-button
              *ngFor="let rn of readyNotes"
              (click)="addReadyNote(rn.content)">
              {{ rn.content }}
            </button>
          </section>

        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>

<div class="note-wrapper">
  <div class="note-overlay" (click)="onBackdropClick($event)">
    <mat-card class="child-details-card" (click)="$event.stopPropagation()">

      <!-- HEADER -->
      <mat-card-header>
        <mat-card-title>
          <mat-icon>person</mat-icon>
          פרטי הילד –
          {{
            ((child?.first_name || '') + ' ' + (child?.last_name || '')) ||
            child?.name || '—'
          }}
        </mat-card-title>

        <button mat-icon-button class="close-button" (click)="onClose()">
          <mat-icon>close</mat-icon>
        </button>
      </mat-card-header>

      <mat-card-content class="scrollable-content">

        <!-- ================= TOP ================= -->
        <div class="inner-section top">

          <!-- נוכחות -->
          <section class="attendance-section" *ngIf="occurrence && canEditNotes">
            <h3>נוכחות</h3>

            <div class="attendance-actions">
              <button
                class="attendance-btn"
                [class.active]="attendanceStatus === 'present'"
                (click)="setAttendance('present')">
                הגיע
              </button>

              <button
                class="attendance-btn"
                [class.active]="attendanceStatus === 'absent'"
                (click)="setAttendance('absent')">
                לא הגיע
              </button>
            </div>
          </section>

          <!-- פרטי שיעור -->
          <section class="lesson-details" *ngIf="lessonDetails">
            <h3>פרטי שיעור</h3>

            <div class="lesson-meta-grid">
              <div class="meta-chip">
                <span class="label">תאריך</span>
                <span class="value">
                  {{ (occurrence?.occur_date || occurrence?.start) | date:'dd/MM/yyyy' }}
                </span>
              </div>

              <div class="meta-chip">
                <span class="label">שעה</span>
                <span class="value">
                  {{ getTimeString(lessonDetails.start_time) }} –
                  {{ getTimeString(lessonDetails.end_time) }}
                </span>
              </div>

              <div class="meta-chip">
                <span class="label">סוג שיעור</span>
                <span class="value">{{ lessonDetails.lesson_type || '—' }}</span>
              </div>

              <div class="meta-chip">
                <span class="label">סטטוס</span>
                <span class="value">{{ lessonDetails.status || '—' }}</span>
              </div>
            </div>

            <!-- סוס + מגרש -->
            <div class="resources-grid">

              <!-- סוס -->
              <div class="resource-box">
                <div class="resource-label">סוס</div>
                <div class="resource-select">
                  <mat-select
                    class="resource-select-inner"
                    [(ngModel)]="lessonDetails.horse_id"
                    (selectionChange)="onHorseChange($event.value)">
                    <mat-option [value]="null">— ללא סוס —</mat-option>
                    <mat-option *ngFor="let h of horses" [value]="h.id">
                      {{ h.name }}
                    </mat-option>
                  </mat-select>
                </div>
              </div>

              <!-- מגרש -->
              <div class="resource-box">
                <div class="resource-label">מגרש</div>
                <div class="resource-select">
                  <mat-select
                    class="resource-select-inner"
                    [(ngModel)]="lessonDetails.arena_id"
                    (selectionChange)="onArenaChange($event.value)">
                    <mat-option [value]="null">— ללא מגרש —</mat-option>
                    <mat-option *ngFor="let a of arenas" [value]="a.id">
                      {{ a.name }}
                    </mat-option>
                  </mat-select>
                </div>
              </div>

            </div>
          </section>
        </div>

        <!-- ================= BOTTOM ================= -->
        <div class="inner-section bottom">

          <section class="note-box medical-note">
            <h4>הערות רפואיות</h4>
            <p *ngIf="!notesMedical.length">אין הערות רפואיות.</p>
            <p *ngFor="let n of notesMedical">{{ n.display_text }}</p>
          </section>

          <section class="note-box behavioral-note">
            <h4>הערות התנהגותיות</h4>
            <p *ngIf="!notesBehavioral.length">אין הערות התנהגותיות.</p>
            <p *ngFor="let n of notesBehavioral">{{ n.display_text }}</p>
          </section>

         <!-- ================= BOTTOM ================= -->
<div class="inner-section bottom">

  <!-- הערות שיעור -->
  <section class="note-box general-note">
    <h4>הערות שיעור</h4>

    <div *ngIf="notesGeneral.length; else noGeneral">
      <div
        *ngFor="let n of notesGeneral"
        class="lesson-note-card"
      >
        <div class="note-row">
          <p class="note-text">{{ n.display_text }}</p>

          <div class="actions" *ngIf="canEditNotes">
            <button mat-icon-button class="edit-btn">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button class="delete-btn">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>

     <div class="note-meta">
    נכתב ע"י
    {{
      n.instructor_uid
        ? n.instructor_name
        : 'מזכירה'
    }}
    • {{ n.created_at | date:'dd.MM.yyyy HH:mm' }}
  </div>

      </div>
    </div>

    <ng-template #noGeneral>
      <p>אין הערות שיעור.</p>
    </ng-template>
  </section>

  <!-- הוספת הערה -->
  <section class="note-box new-note" *ngIf="canEditNotes">
    <h4>הוסף הערה חדשה</h4>

    <mat-form-field appearance="fill">
      <mat-label>כתוב הערה</mat-label>
      <textarea
        matInput
        [(ngModel)]="newNote"
        rows="3"
      ></textarea>
    </mat-form-field>

    <button mat-raised-button (click)="addNote()">
      הוסף הערה
    </button>
  </section>

  <!-- הערות מוכנות -->
  <section class="note-box prepared-notes" *ngIf="canEditNotes">
    <h4>הערות מוכנות</h4>

    <div class="filter-buttons">
      <button
        *ngFor="let rn of readyNotes"
        mat-stroked-button
        (click)="addReadyNote(rn.content)"
      >
        {{ rn.content }}
      </button>
    </div>
  </section>

</div>

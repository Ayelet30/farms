<div class="children-container" dir="rtl">
  <div *ngIf="loading">טוען...</div>
  <div *ngIf="!loading && children.length === 0">
    <button (click)="openAddChildWizard()" class="child-chip add-button" type="button">
  <svg class="icon" aria-hidden="true">
    <use href="assets/icons/feather-slim.svg#plus" />
  </svg>
  <span>הוסף ילד</span>
</button>
  </div>

  <div *ngIf="infoMessage" class="info-banner">{{ infoMessage }}</div>

  <!-- פס בחירה עליון + כפתור הוספה -->
  <div class="children-buttons" *ngIf="children.length > 0">
   <button *ngFor="let child of children"
        (click)="toggleChildSelection(child)"
        class="child-chip"
        [class.active]="hasSelected(child)"
        [class.status-disabled]="isDeletedStatus(child?.status)"
        [class.limit-disabled]="!hasSelected(child) && selectedIds.size >= maxSelected && canOpenCardByStatus(child?.status)"
        [attr.aria-disabled]="(!canOpenCardByStatus(child?.status) || (selectedIds.size >= maxSelected && !hasSelected(child))) ? 'true' : null"
        [attr.title]="
          isDeletedStatus(child?.status) ? 'הילד במצב Deleted' :
          (selectedIds.size >= maxSelected && !hasSelected(child) ? 'מקסימום 4 כרטיסים פתוחים' : null)
        "
        type="button">
{{ child.first_name }} {{ child.last_name }}

</button>


<button (click)="openAddChildWizard()" class="child-chip add-button" type="button">
  <svg class="icon" aria-hidden="true">
    <use href="assets/icons/feather-slim.svg#plus" />
  </svg>
  <span>הוסף ילד</span>
</button>


  </div>

  <!-- גריד של עד 4 כרטיסים -->
  <div class="cards-grid" *ngIf="selectedChildren.length > 0">
    <div class="child-card" *ngFor="let c of selectedChildren; trackBy: trackByChild">
      <button class="card-close" type="button" (click)="closeCard(c)" title="סגירת כרטיס" aria-label="סגירת כרטיס">
        <svg class="icon" aria-hidden="true">
          <use href="assets/icons/feather-slim.svg#x" />
        </svg>
      </button>

      <div class="child-header">
        <div class="title-wrap">
          <h3 class="child-name">
            <svg class="icon" aria-hidden="true">
              <use href="assets/icons/feather-slim.svg#user" />
            </svg>
    {{ c.first_name }} {{ c.last_name }}
          </h3>
<span class="age-badge warn" *ngIf="isPendingDelete(c?.status)">
  ממתין לאישור מחיקה
</span>

          <span class="age-badge" *ngIf="c.birth_date">גיל: {{ getAge(c.birth_date) }} </span>
            <span class="age-badge" *ngIf="c.health_fund">
 {{ c.health_fund }}
  </span>
        </div>

        <div class="actions">
          <div class="actions">
            <button *ngIf="!editing[childId(c)]" class="icon-btn" type="button" (click)="startEdit(c)"
              aria-label="עריכה">
              <svg class="icon" aria-hidden="true">
                <use href="assets/icons/feather-slim.svg#edit" />
              </svg>
            </button>

            <button *ngIf="editing[childId(c)]" class="icon-btn" type="button" (click)="saveChild(c)"
              aria-label="שמירה">
              <svg class="icon" aria-hidden="true">
                <use href="assets/icons/feather-slim.svg#save" />
              </svg>
            </button>

            <button class="icon-btn danger" type="button" (click)="confirmDeleteChild(c)" aria-label="מחיקה">
              <svg class="icon" aria-hidden="true">
                <use href="assets/icons/feather-slim.svg#trash" />
              </svg>
            </button>
            <button *ngIf="editing[childId(c)]" class="icon-btn" type="button"
          (click)="cancelEdit(c)" aria-label="ביטול" title="ביטול">
    <svg class="icon" aria-hidden="true"><use href="assets/icons/feather-slim.svg#rotate-ccw" />
</svg>
  </button>
          </div>

        </div>
      </div>

      <p class="row"><span class="key">תחום רכיבה:</span><span class="val">רכיבה טיפולית</span></p>

      <!-- התור הבא -->
      <div class="card-section">
        <div class="section-title">התור הבא</div>
        <ng-container [ngTemplateOutlet]="nextTpl"
          [ngTemplateOutletContext]="{ $implicit: getNextAppointment(c) }"></ng-container>
      </div>

      <!-- פעילות אחרונה -->
      <div class="card-section">
        <div class="section-title">פעילות אחרונה</div>
        <ng-container [ngTemplateOutlet]="lastTpl"
          [ngTemplateOutletContext]="{ $implicit: getLastActivity(c) }"></ng-container>
      </div>

      <!-- פרטים ניתנים לעריכה -->
      <div class="editable-area" *ngIf="editing[childId(c)]">
       <div class="form-row">
       <label>שם פרטי</label>
       <input [(ngModel)]="editables[childId(c)].first_name" class="editable-input" />
       </div>

      <div class="form-row">
      <label>שם משפחה</label>
      <input [(ngModel)]="editables[childId(c)].last_name" class="editable-input" />
     </div>

    <div class="form-row">
    <label>תאריך לידה</label>
    <input type="date" [(ngModel)]="editables[c.child_uuid!].birth_date" class="editable-input" />
    </div>

        <div class="form-row">
          <label>קופת חולים</label>
          <select [(ngModel)]="editables[c.child_uuid!].health_fund" class="editable-input">
            <option value="" disabled hidden>בחר קופה</option>
            <option *ngFor="let fund of healthFunds" [value]="fund">{{ fund }}</option>
          </select>
        </div>
        <div class="form-row">
          <label>הערות רפואיות</label>
          <textarea [(ngModel)]="editables[c.child_uuid!].medical_notes" rows="3" class="editable-input"></textarea>
        </div>
      </div>

      <!-- קישורים נוספים -->
        <div class="links-row">
          <button class="cta-btn" type="button" (click)="openHistory(c)">
            <svg class="icon" aria-hidden="true">
              <use href="assets/icons/feather-slim.svg#book-open" />
            </svg>
            <span>היסטוריה</span>
          </button>
<button class="cta-btn warning-outline"
        *ngIf="isPendingDelete(c?.status)"
        type="button"
        (click)="cancelDeletionRequest(c)"
        [attr.aria-busy]="cancelDeletionRequestInFlight[childId(c)] ? 'true' : null"
        [title]="'ביטול בקשת מחיקה'">
  <svg class="icon" aria-hidden="true">
    <use href="assets/icons/feather-slim.svg#rotate-ccw" />
  </svg>
  <span>ביטול בקשת מחיקה</span>
</button>

        <button class="cta-btn primary"
        type="button"
        (click)="goToBooking(c)"
        [attr.aria-disabled]="isPendingAdd(c?.status) ? 'true' : null"
        [title]="isPendingAdd(c?.status) ? 'הוספת הילד טרם אושרה' : null">
  <svg class="icon" aria-hidden="true">
    <use href="assets/icons/feather-slim.svg#calendar" />
  </svg>
  <span>הזמן תור</span>
</button>
<span class="inline-note" *ngIf="bookingMsg[childId(c)]" dir="rtl">
  {{ bookingMsg[childId(c)] }}
</span>


        </div>

    </div>
  </div>

  <!-- History Modal -->
  <div class="dialog-overlay" *ngIf="showHistory">
    <div class="history-modal">
      <button class="card-close small" (click)="closeHistory()" aria-label="סגור">✕</button>

      <h3 class="history-title">היסטוריית שיעורים — {{ historyChildName }}</h3>

      <div *ngIf="historyLoading" class="history-loading">טוען…</div>

      <div *ngIf="!historyLoading && historyItems.length === 0" class="history-empty">
        אין היסטוריה להצגה
      </div>

      <ul class="history-list" *ngIf="!historyLoading && historyItems.length > 0">
        <li *ngFor="let h of historyItems; let i = index" class="history-item">
          <div class="line">
            <span class="when">{{ h.date }} • {{ h.time }}</span>
            <span class="sep" *ngIf="h.instructor">•</span>
            <span class="with" *ngIf="h.instructor">עם {{ h.instructor }}</span>
            <span class="badge" [ngClass]="statusClass(h.status)">{{ h.status }}</span>
          </div>
          <div class="muted" *ngIf="h.lesson_type">סוג שיעור: {{ h.lesson_type }}</div>
        </li>
      </ul>
    </div>
  </div>

 <div class="overlay" *ngIf="showDeleteConfirm">
  <div class="confirm-dialog" dir="rtl">
    <h3>אישור עזיבת ילד</h3>

    <p>
      מחיקת ילד מהחווה מתבצעת רק לאחר אישור המזכירות.
      מרגע שהמחיקה תאושר:
    </p>
    <ul>
      <li>כל השיעורים הקבועים ושיעורי ההשלמה של הילד החל מעוד שבועיים יבוטלו במערכת.</li>
      <li>השיעורים המתוכננים לשבועיים הקרובים יישארו בתוקף ותידרש עליהם תשלום כרגיל.</li>
    </ul>

    <p *ngIf="pendingDeleteLessonsCount !== null">
      לילד זה נותרו כעת
      <b>{{ pendingDeleteLessonsCount }}</b>
      שיעורים פעילים בחווה.
    </p>

    <p *ngIf="pendingDeleteChildName">
      האם ברצונך לשלוח בקשה למחיקת
      <b>{{ pendingDeleteChildName }}</b>?
    </p>

    <div class="dialog-actions">
      <button type="button" class="btn-cancel" (click)="cancelDelete()">לא</button>
      <button type="button" class="btn-ok" (click)="deleteChild()">כן, שלחי בקשה למחיקה</button>
    </div>
  </div>
</div>


<!-- תבניות להצגת "התור הבא" ו"פעילות אחרונה" -->
<ng-template #nextTpl let-next>
  <div class="row" *ngIf="next; else noNext">
    <span class="today-flag" *ngIf="next.isToday"><strong>היום!</strong>&nbsp;</span>
    <span class="val">
      {{ next.date }} • {{ next.time }}
      <ng-container *ngIf="next.instructor"> • עם {{ next.instructor }}</ng-container>
    </span>
  </div>
  <ng-template #noNext>
    <div class="muted">אין תורים להצגה</div>
  </ng-template>
</ng-template>


<ng-template #lastTpl let-last>
  <div class="row" *ngIf="last; else noLast">
    <span class="val">
      {{ last.date }} • {{ last.time }}
      <ng-container *ngIf="last.instructor"> • עם {{ last.instructor }}</ng-container>
      <span class="muted" *ngIf="last.pendingCompletion"> — טרם מעודכן כי הושלם</span>
    </span>
  </div>
  <ng-template #noLast>
    <div class="muted">אין פעילות להצגה</div>
  </ng-template>
</ng-template>

<app-add-child-wizard
  *ngIf="showAddChildWizard"
  (childAdded)="handleChildAddedFromWizard()"
  (closed)="handleWizardClosed()"
>
</app-add-child-wizard>

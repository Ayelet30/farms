<div class="children-container" dir="rtl">
  <div *ngIf="loading">טוען...</div>
  <div *ngIf="!loading && children.length === 0">אין ילדים להצגה.</div>

  <div *ngIf="infoMessage" class="info-banner">{{ infoMessage }}</div>

  <!-- פס בחירה עליון + כפתור הוספה -->
  <div class="children-buttons" *ngIf="children.length > 0">
    <button *ngFor="let child of children"
        (click)="toggleChildSelection(child)"
        class="child-chip"
        [class.active]="hasSelected(child)"
        [class.status-disabled]="isDeletedStatus(child?.status)"
        [class.limit-disabled]="!hasSelected(child) && selectedIds.size >= maxSelected && canOpenCardByStatus(child?.status)"
        [attr.aria-disabled]="(!canOpenCardByStatus(child?.status) || (selectedIds.size >= maxSelected && !hasSelected(child))) ? 'true' : null"
        [attr.title]="
          isDeletedStatus(child?.status) ? 'הילד במצב Deleted' :
          (selectedIds.size >= maxSelected && !hasSelected(child) ? 'מקסימום 4 כרטיסים פתוחים' : null)
        "
        type="button">
  {{ child.full_name }}
</button>




    <button (click)="addNewChild()" class="child-chip add-button" type="button">
      <svg class="icon" aria-hidden="true">
        <use href="assets/icons/feather-slim.svg#plus" />
      </svg>
      <span>הוסף ילד</span>
    </button>

  </div>

  <!-- גריד של עד 4 כרטיסים -->
  <div class="cards-grid" *ngIf="selectedChildren.length > 0">
    <div class="child-card" *ngFor="let c of selectedChildren; trackBy: trackByChild">
      <button class="card-close" type="button" (click)="closeCard(c)" title="סגירת כרטיס" aria-label="סגירת כרטיס">
        <svg class="icon" aria-hidden="true">
          <use href="assets/icons/feather-slim.svg#x" />
        </svg>
      </button>

      <div class="child-header">
        <div class="title-wrap">
          <h3 class="child-name">
            <svg class="icon" aria-hidden="true">
              <use href="assets/icons/feather-slim.svg#user" />
            </svg>
            {{ c.full_name }}
          </h3>

          <span class="age-badge" *ngIf="c.birth_date">גיל: {{ getAge(c.birth_date) }} </span>
            <span class="age-badge" *ngIf="c.health_fund">
 {{ c.health_fund }}
  </span>
        </div>

        <div class="actions">
          <div class="actions">
            <button *ngIf="!editing[childId(c)]" class="icon-btn" type="button" (click)="startEdit(c)"
              aria-label="עריכה">
              <svg class="icon" aria-hidden="true">
                <use href="assets/icons/feather-slim.svg#edit" />
              </svg>
            </button>

            <button *ngIf="editing[childId(c)]" class="icon-btn" type="button" (click)="saveChild(c)"
              aria-label="שמירה">
              <svg class="icon" aria-hidden="true">
                <use href="assets/icons/feather-slim.svg#save" />
              </svg>
            </button>

            <button class="icon-btn danger" type="button" (click)="confirmDeleteChild(c)" aria-label="מחיקה">
              <svg class="icon" aria-hidden="true">
                <use href="assets/icons/feather-slim.svg#trash" />
              </svg>
            </button>
            <button *ngIf="editing[childId(c)]" class="icon-btn" type="button"
          (click)="cancelEdit(c)" aria-label="ביטול" title="ביטול">
    <svg class="icon" aria-hidden="true"><use href="assets/icons/feather-slim.svg#rotate-ccw" />
</svg>
  </button>
          </div>

        </div>
      </div>

      <p class="row"><span class="key">תחום רכיבה:</span><span class="val">רכיבה טיפולית</span></p>

      <!-- התור הבא -->
      <div class="card-section">
        <div class="section-title">התור הבא</div>
        <ng-container [ngTemplateOutlet]="nextTpl"
          [ngTemplateOutletContext]="{ $implicit: getNextAppointment(c) }"></ng-container>
      </div>

      <!-- פעילות אחרונה -->
      <div class="card-section">
        <div class="section-title">פעילות אחרונה</div>
        <ng-container [ngTemplateOutlet]="lastTpl"
          [ngTemplateOutletContext]="{ $implicit: getLastActivity(c) }"></ng-container>
      </div>

      <!-- פרטים ניתנים לעריכה -->
      <div class="editable-area" *ngIf="editing[childId(c)]">
        <div class="form-row">
          <label>שם מלא</label>
          <input [(ngModel)]="editables[childId(c)].full_name" class="editable-input" />
        </div>
        <div class="form-row">
          <label>תאריך לידה</label>
          <input type="date" [(ngModel)]="editables[c.child_uuid!].birth_date" class="editable-input" />
        </div>
        <div class="form-row">
          <label>קופת חולים</label>
          <select [(ngModel)]="editables[c.child_uuid!].health_fund" class="editable-input">
            <option value="" disabled hidden>בחר קופה</option>
            <option *ngFor="let fund of healthFunds" [value]="fund">{{ fund }}</option>
          </select>
        </div>
        <div class="form-row">
          <label>הערות רפואיות</label>
          <textarea [(ngModel)]="editables[c.child_uuid!].medical_notes" rows="3" class="editable-input"></textarea>
        </div>
      </div>

      <!-- קישורים נוספים -->
        <div class="links-row">
          <button class="cta-btn" type="button" (click)="openHistory(c)">
            <svg class="icon" aria-hidden="true">
              <use href="assets/icons/feather-slim.svg#book-open" />
            </svg>
            <span>היסטוריה</span>
          </button>

         <button class="cta-btn primary"
        type="button"
        (click)="goToBooking(c)"
        [disabled]="!canBookByStatus(c?.status)"
        [attr.aria-disabled]="!canBookByStatus(c?.status) ? 'true' : null"
        [title]="!canBookByStatus(c?.status) ? (isPendingAdd(c?.status) ? 'ממתין לאישור הוספה – אי אפשר להזמין תור' : 'לא ניתן להזמין תור לסטטוס זה') : null">
  <svg class="icon" aria-hidden="true">
    <use href="assets/icons/feather-slim.svg#calendar" />
  </svg>
  <span>הזמן תור</span>
</button>


        </div>

    </div>
  </div>

  <!-- טופס הוספת ילד חדש -->
  <div class="child-card" *ngIf="newChild">
    <h3>הוספת ילד חדש</h3>

    <div class="form-field">
      <label>שם מלא</label>
      <input class="editable-input" [(ngModel)]="newChild.full_name" required />
      <div *ngIf="validationErrors['full_name']" class="error-msg">{{ validationErrors['full_name'] }}</div>
    </div>

    <div class="form-field">
      <label>תעודת זהות</label>
      <input class="editable-input" [(ngModel)]="newChild.gov_id" maxlength="9" pattern="[0-9]*" inputmode="numeric"
        required (keypress)="allowOnlyNumbers($event)" />
      <div *ngIf="validationErrors['gov_id']" class="error-msg">{{ validationErrors['gov_id'] }}</div>
    </div>

    <div class="form-field">
      <label>תאריך לידה</label>
      <input class="editable-input" type="date" [(ngModel)]="newChild.birth_date" required />
      <div *ngIf="validationErrors['birth_date']" class="error-msg">{{ validationErrors['birth_date'] }}</div>
    </div>

    <div class="form-field">
      <label>מין</label>
      <select class="editable-input" [(ngModel)]="newChild.gender" required>
        <option value="" disabled hidden>בחר מין</option>
        <option value="זכר">זכר</option>
        <option value="נקבה">נקבה</option>
      </select>
      <div *ngIf="validationErrors['gender']" class="error-msg">{{ validationErrors['gender'] }}</div>
    </div>

    <div class="form-field">
      <label>קופת חולים</label>
      <select class="editable-input" [(ngModel)]="newChild.health_fund" required>
        <option value="" disabled hidden>בחר קופה</option>
        <option *ngFor="let fund of healthFunds" [value]="fund">{{ fund }}</option>
      </select>
      <div *ngIf="validationErrors['health_fund']" class="error-msg">{{ validationErrors['health_fund'] }}</div>
    </div>

    <div class="form-field">
      <label>הערות רפואיות / רגישויות</label>
      <textarea class="editable-input" [(ngModel)]="newChild.medical_notes" rows="3" maxlength="4000"></textarea>
    </div>

    <child-consents tenantSchema="tenantSchema" parentUid = "parentUid" childId="childId" childName="childName"></child-consents>

    <div class="button-group">
      <button class="btn-save" (click)="saveNewChild()" type="button">שמור</button>
      <button class="btn-edit" (click)="cancelNewChild()" type="button">ביטול</button>
    </div>
  </div>
  <!-- History Modal -->
  <div class="dialog-overlay" *ngIf="showHistory">
    <div class="history-modal">
      <button class="card-close small" (click)="closeHistory()" aria-label="סגור">✕</button>

      <h3 class="history-title">היסטוריית שיעורים — {{ historyChildName }}</h3>

      <div *ngIf="historyLoading" class="history-loading">טוען…</div>

      <div *ngIf="!historyLoading && historyItems.length === 0" class="history-empty">
        אין היסטוריה להצגה
      </div>

      <ul class="history-list" *ngIf="!historyLoading && historyItems.length > 0">
        <li *ngFor="let h of historyItems; let i = index" class="history-item">
          <div class="line">
            <span class="when">{{ h.date }} • {{ h.time }}</span>
            <span class="sep" *ngIf="h.instructor">•</span>
            <span class="with" *ngIf="h.instructor">עם {{ h.instructor }}</span>
            <span class="badge" [ngClass]="statusClass(h.status)">{{ h.status }}</span>
          </div>
          <div class="muted" *ngIf="h.lesson_type">סוג שיעור: {{ h.lesson_type }}</div>
        </li>
      </ul>
    </div>
  </div>

  <!-- דיאלוג עזיבה/מחיקה -->
  <div class="dialog-overlay" *ngIf="showDeleteConfirm">
    <div class="dialog-box">
      <h3>האם את בטוחה שברצונך להסיר את הילד?</h3>
      <div class="dialog-buttons">
        <button class="btn-delete" (click)="deleteChild()" type="button">אישור</button>
        <button class="btn-edit" (click)="cancelDelete()" type="button">ביטול</button>
      </div>
    </div>
  </div>
</div>

<!-- תבניות להצגת "התור הבא" ו"פעילות אחרונה" -->
<ng-template #nextTpl let-next>
  <div class="row" *ngIf="next; else noNext">
    <span class="today-flag" *ngIf="next.isToday"><strong>היום!</strong>&nbsp;</span>
    <span class="val">
      {{ next.date }} • {{ next.time }}
      <ng-container *ngIf="next.instructor"> • עם {{ next.instructor }}</ng-container>
    </span>
  </div>
  <ng-template #noNext>
    <div class="muted">אין תורים להצגה</div>
  </ng-template>
</ng-template>


<ng-template #lastTpl let-last>
  <div class="row" *ngIf="last; else noLast">
    <span class="val">
      {{ last.date }} • {{ last.time }}
      <ng-container *ngIf="last.instructor"> • עם {{ last.instructor }}</ng-container>
      <span class="muted" *ngIf="last.pendingCompletion"> — טרם מעודכן כי הושלם</span>
    </span>
  </div>
  <ng-template #noLast>
    <div class="muted">אין פעילות להצגה</div>
  </ng-template>
</ng-template>
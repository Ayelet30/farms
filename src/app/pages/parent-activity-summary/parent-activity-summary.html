<div class="activity-summary" dir="rtl">
  <!-- Header + Actions -->
  <header class="head">
    <h1>סיכום פעילות</h1>
    <div class="actions">
      <button class="btn" (click)="exportCsv()">ייצוא CSV</button>
      <button class="btn primary" (click)="refresh()" [disabled]="loading()">רענון</button>
    </div>
  </header>

  <!-- Tabs -->
  <nav class="tabs">
    <button class="tab" [class.active]="tab()==='month'" (click)="tab.set('month')">📅 פרטי חודש</button>
    <button class="tab" [class.active]="tab()==='year'"  (click)="tab.set('year')">📈 פרטי שנה</button>
    <button class="tab" [class.active]="tab()==='all'"   (click)="tab.set('all')">📚 כל הפרטים</button>
  </nav>

  <!-- Filters bar (matches screenshots) -->
  <section class="filters">
    <!-- Child -->
   <div class="filter">
  <label>ילד</label>
 <select #childSel (change)="onChildChange(childSel.value)">
<option value="">כל הילדים</option>
<option *ngFor="let c of children()" [value]="c.child_uuid">
  {{ c.first_name }} {{ c.last_name }}
</option>

</select>




</div>

 <!-- Month -->
<div class="filter" *ngIf="tab()!=='year'">
  <label>חודש</label>
  <select [ngModel]="month()" (ngModelChange)="month.set($event)">
    <option *ngFor="let m of months" [ngValue]="m.value">{{ m.label }}</option>
  </select>
</div>


   <!-- Year -->
<div class="filter">
  <label>שנה</label>
  <select [ngModel]="year()" (ngModelChange)="onYearChange($event)">
    <option *ngFor="let y of years" [ngValue]="y">{{ y }}</option>
  </select>
</div>

  </section>

  <!-- MONTH VIEW -->
  <section *ngIf="tab()==='month'" class="panel">
    <div class="panel-head">
      <div class="title">סיכום חודשי – {{ monthLabel() }} / {{ year() }}</div>
      <div class="muted">פירוט מלא של השיעורים בחודש זה</div>
    </div>

    <!-- Stat cards row -->
    <div class="cards">
      <div class="stat">
        <div class="stat-title">שיעורים</div>
        <div class="stat-value">{{ monthLessonsCount() }}</div>
      </div>

      <div class="stat violet">
        <div class="stat-title">סבסוד כולל</div>
        <div class="stat-value">₪{{ monthSubsidies() | number:'1.0-0':'he-IL' }}</div>
      </div>

      <!-- <div class="stat pink">
        <div class="stat-title">הנחות</div>
        <div class="stat-value">₪{{ monthDiscounts() | number:'1.0-0':'he-IL' }}</div>
      </div> -->

      <div class="stat green">
        <div class="stat-title">סכום סופי</div>
        <div class="stat-value">₪{{ monthTotal() | number:'1.0-0':'he-IL' }}</div>
      </div>
    </div>

    <!-- Monthly list -->
    <div class="list">
      <div class="lesson" *ngFor="let r of monthRows()">
        <div class="row-head">
          <div class="date">{{ r.date | date:'d.M.yyyy' }}</div>
          <span class="badge success">רגיל</span>
          <span class="spacer"></span>
          <button class="icon-btn" title="צפייה">👁️</button>
        </div>
        <div class="row-body">
          <div class="line"><b>מדריך:</b> {{ r.instructor || '—' }}</div>
          <div class="line"><b>ילד:</b> {{ r.child }}</div>
          <div class="line note" *ngIf="r.note"><b>הערה:</b> {{ r.note }}</div>
        </div>
        <div class="row-meta">
          <span class="meta">מחיר בסיסי: ₪0</span>
          <span class="meta">סבסוד: ₪0</span>
          <!-- <span class="meta">הנחה: ₪0</span> -->
          <span class="meta bold">לתשלום: ₪0</span>
        </div>
      </div>
    </div>
  </section>

  <!-- YEAR VIEW -->
  <section *ngIf="tab()==='year'" class="panel">
    <div class="panel-head">
      <div class="title">סיכום שנתי – {{ year() }}</div>
      <div class="muted">סקירה כללית של כל השיעורים והפעילויות בשנה</div>
    </div>

    <div class="cards">
      <div class="stat"><div class="stat-title">שיעורים פעילים</div><div class="stat-value">{{ yearActive() }}</div></div>
      <div class="stat pink"><div class="stat-title">ביטולים בתשלום</div><div class="stat-value">{{ yearCancelPaid() }}</div></div>
      <div class="stat"><div class="stat-title">ביטולים ללא תשלום</div><div class="stat-value">{{ yearCancelFree() }}</div></div>
      <div class="stat green"><div class="stat-title">סכום לתשלום</div><div class="stat-value">₪{{ yearTotal() | number:'1.0-0':'he-IL' }}</div></div>
    </div>

       <!-- Bar chart – גרף עמודות אנכי -->
    <div class="bars bars-columns">
      <div class="bars-col" *ngFor="let b of yearBars()">
        <!-- מספר מעל העמודה (מופיע רק אם יש לפחות שיעור אחד) -->
        <div class="bars-value" *ngIf="b.count > 0">
          {{ b.count }}
        </div>

        <!-- העמודה עצמה -->
        <div class="bars-bar">
          <div
            class="bars-bar-fill"
            [style.height.%]="maxYearCount() ? (b.count / maxYearCount() * 100) : 0">
          </div>
        </div>

        <!-- תווית חודש -->
        <div class="bars-label">
          {{ b.label }}
        </div>
      </div>
    </div>

  </section>

  <!-- ALL DETAILS TABLE -->
  <section *ngIf="tab()==='all'" class="panel">
    <div class="panel-head space">
      <div>
        <div class="title">כל השיעורים</div>
        <div class="muted">טבלת פירוט מלאה עם אפשרויות חיפוש וסינון</div>
      </div>
      <!-- <div class="export">
        <button class="btn">📄 ייצוא PDF</button>
        <button class="btn">🧾 ייצוא Excel</button>
      </div> -->
    </div>

    <div class="table-wrap">
      <table class="summary">
        <thead>
          <tr>
            <th>תאריך</th>
            <th>ילד</th>
            <th>מדריך</th>
            <th>סוג שיעור</th>
            <th>מחיר בסיסי</th>
            <th>סבסוד</th>
            <!-- <th>הנחה</th> -->
            <th>סכום לתשלום</th>
            <th>סטטוס</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngIf="loading()">
            <td colspan="9" class="muted">טוען…</td>
          </tr>
          <tr *ngIf="!loading() && yearRows().length === 0">
            <td colspan="9" class="muted">אין נתונים</td>
          </tr>
          <tr *ngFor="let r of yearRows()">
            <td>{{ r.date | date:'dd.MM.yyyy' }}</td>
            <td>{{ r.child }}</td>
            <td>{{ r.instructor }}</td>
            <td>רגיל</td>
            <td>₪0</td>
            <td>₪0</td>
            <!-- <td>₪0</td> -->
            <td><b>₪0</b></td>
            <td>שולם</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>
</div>

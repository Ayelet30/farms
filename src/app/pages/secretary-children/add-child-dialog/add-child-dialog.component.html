<h3 dir="rtl">הוספת ילד/ה חדש/ה</h3>

<div *ngIf="loadingParents" class="hint">טוען רשימת הורים...</div>
<div *ngIf="parentsError" class="error-state">שגיאה: {{ parentsError }}</div>

<form [formGroup]="form" (ngSubmit)="submit()" dir="rtl" *ngIf="!loadingParents">

  <label>שם פרטי</label>
  <input formControlName="first_name" />
  <div class="err" *ngIf="form.controls['first_name']?.touched && form.controls['first_name']?.invalid">
    חובה להזין שם פרטי (לפחות 2 תווים)
  </div>

  <label>שם משפחה</label>
  <input formControlName="last_name" />
  <div class="err" *ngIf="form.controls['last_name']?.touched && form.controls['last_name']?.invalid">
    חובה להזין שם משפחה (לפחות 2 תווים)
  </div>

  <!-- הורה מקושר – נראה כמו שאר השדות -->
  <label>הורה מקושר</label>
  <mat-form-field appearance="outline" class="full-width parent-field">
    <input
      type="text"
      matInput
      [formControl]="parentSearchControl"
      [matAutocomplete]="parentAuto"
      placeholder="התחילי להקליד שם הורה" />

    <mat-autocomplete
      #parentAuto="matAutocomplete"
      [displayWith]="displayParent"
      (optionSelected)="onParentSelected($event)">
      <mat-option *ngFor="let p of filteredParents" [value]="p">
        {{ displayParent(p) }}
      </mat-option>
    </mat-autocomplete>
  </mat-form-field>

  <!-- השדה האמיתי ששומר רק uid -->
  <input type="hidden" formControlName="parent_uid" />
  <div class="err" *ngIf="form.controls['parent_uid']?.touched && form.controls['parent_uid']?.invalid">
    חובה לבחור הורה
  </div>

<label>תעודת זהות ילד/ה</label>
<input formControlName="gov_id" />

<div
  class="err"
  *ngIf="form.controls['gov_id']?.touched && form.controls['gov_id']?.errors as e"
>
  <span *ngIf="e['required']">חובה להזין תעודת זהות</span>
  <span *ngIf="!e['required'] && e['invalidIsraeliId']">
    תעודת זהות אינה תקינה
  </span>
</div>


<label>תאריך לידה</label>
<input
  formControlName="birth_date"
  placeholder="DD/MM/YYYY"
  (input)="onBirthDateInput($event)"
/>

<div class="err"
  *ngIf="
    form.controls['birth_date']?.touched &&
    form.controls['birth_date']?.invalid
  ">
  חובה להזין תאריך לידה
</div>

<label>מין</label>
<select formControlName="gender">
  <option value="">-- בחרי מין --</option>
  <option *ngFor="let g of genderOptions" [value]="g">
    {{ g }}
  </option>
</select>
<div class="err" *ngIf="form.controls['gender']?.touched && form.controls['gender']?.invalid">
  חובה לבחור מין
</div>

<label>קופת חולים</label>
<select formControlName="health_fund">
  <option value="">-- בחרי קופת חולים --</option>
  <option *ngFor="let h of healthFundOptions" [value]="h">
    {{ h }}
  </option>
</select>
<div class="err" *ngIf="form.controls['health_fund']?.touched && form.controls['health_fund']?.invalid">
  חובה לבחור קופת חולים
</div>
<label>סטטוס</label>
<select formControlName="status">
  <option value="">-- בחרי סטטוס --</option>
  <option *ngFor="let opt of statusOptions" [value]="opt.value">
    {{ opt.label }}
  </option>
</select>
<div class="err" *ngIf="form.controls['status']?.touched && form.controls['status']?.invalid">
  חובה לבחור סטטוס
</div>


  <label>הערות רפואיות</label>
  <textarea formControlName="medical_notes" rows="2"></textarea>

  <label>הערות התנהגות</label>
  <textarea formControlName="behavior_notes" rows="2"></textarea>
<div class="actions">
  <button
    type="button"
    class="cancel"
    (click)="cancel()"
    [disabled]="submitting"
  >
    ביטול
  </button>

  <button
    type="submit"
    class="save"
    [disabled]="submitting || form.invalid"
  >
    שמור
  </button>
</div>

</form>

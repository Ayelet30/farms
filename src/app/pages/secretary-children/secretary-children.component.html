<div class="children-header">
  <h2>רשימת ילדים</h2>

  <button
    type="button"
    class="add-child-btn"
    (click)="openAddChildDialog()"
    aria-label="הוספת ילד/ה חדש/ה"
  >
    +
  </button>
</div>

<!-- 🔍 חיפוש + סינון -->
<div class="search-shell">
  <div class="simple-search-bar" (click)="toggleSearchPanelFromBar()">
    <span
      class="search-icon"
      title="חיפוש"
      (click)="toggleFromSearchIcon($event)"
    >
      <svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" viewBox="0 0 24 24" fill="#6e7462">
        <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16a6.471 6.471 0 0 0 4.23-1.57l.27.28v.79l5 5L20.49 19l-5-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
      </svg>
    </span>

    <input
      type="text"
      class="simple-search-input"
      [(ngModel)]="searchText"
      placeholder="חיפוש"
      (click)="$event.stopPropagation()"
    />

    <span
      class="filter-icon"
      title="סינון"
      (click)="toggleFromFilterIcon($event)"
    >
      <svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" viewBox="0 0 24 24" fill="#6e7462">
        <path d="M10 18h4v-2h-4v2zm-7-8v2h18v-2H3zm3-6v2h12V4H6z"/>
      </svg>
    </span>
  </div>

  <div
    *ngIf="showSearchPanel"
    class="search-panel"
    (click)="$event.stopPropagation()"
  >
    <div class="panel-section" [class.active]="panelFocus === 'search'">
      <div class="panel-title">חיפוש</div>

      <label class="panel-option">
        <input
          type="radio"
          name="searchMode"
          value="name"
          [(ngModel)]="searchMode"
        />
        חיפוש חופשי לפי שם פרטי / משפחה
      </label>

      <label class="panel-option">
        <input
          type="radio"
          name="searchMode"
          value="id"
          [(ngModel)]="searchMode"
        />
        חיפוש לפי תעודת זהות
      </label>

      <div class="panel-hint">
        ההקלדה בשורת החיפוש למעלה עובדת בזמן אמת לפי האפשרות שנבחרה.
      </div>
    </div>

    <hr />

    <div class="panel-section" [class.active]="panelFocus === 'filter'">
      <div class="panel-title">סינון</div>

      <label class="panel-label">סטטוס ילד</label>
      <select [(ngModel)]="statusFilter">
        <option value="all">כל הילדים</option>
        <option value="active">ילדים פעילים</option>
        <option value="inactive">ילדים לא פעילים</option>
      </select>

      <label class="panel-label">שיוך להורה</label>
      <select [(ngModel)]="parentFilter">
        <option value="all">ללא סינון</option>
        <option value="withParent">עם הורה משויך</option>
        <option value="withoutParent">ללא הורה משויך</option>
      </select>
    </div>

    <button type="button" class="panel-clear" (click)="clearFilters()">
      איפוס חיפוש וסינון
    </button>
  </div>
</div>

<div *ngIf="isLoading" class="loading-state">טוען נתונים... ⏳</div>
<div *ngIf="error" class="error-state">שגיאה: {{ error }}</div>

<div *ngIf="!isLoading && !error && (children?.length ?? 0) > 0" class="table-container">
  <table>
    <thead>
      <tr>
        <th>שם פרטי</th>
        <th>שם משפחה</th>
        <th>תעודת זהות</th>
      </tr>
    </thead>
    <tbody>
      <tr
        *ngFor="let child of filteredChildren"
        class="clickable-row"
        (click)="openDetails(child.child_uuid || $any(child).id)"
      >
        <td>{{ child.first_name || '—' }}</td>
        <td>{{ child.last_name || '—' }}</td>
        <td dir="ltr">{{ $any(child).gov_id || '—' }}</td>
      </tr>
    </tbody>
  </table>
</div>

<div *ngIf="!isLoading && !error && (children?.length ?? 0) === 0" class="empty-state">
  לא נמצאו ילדים בחווה.
</div>

<!-- מגירה עם פרטי ילד -->
<mat-sidenav-container
  class="drawer-container"
  [class.drawer-open]="!!selectedId"
  dir="rtl"
  [hasBackdrop]="false"
>
  <mat-sidenav
    #drawer
    mode="side"
    position="end"
    class="drawer-pane"
    [opened]="!!selectedId"
  >
    <div class="drawer-header">
      <button class="close-btn" (click)="closeDetails()">✕</button>
      <h3>פרטי ילד</h3>

      <button
        *ngIf="drawerChild && !editMode"
        type="button"
        class="secondary"
        (click)="enterEditModeChild()"
      >
        עריכה
      </button>
    </div>

    <div *ngIf="drawerLoading" class="hint">טוען פרטים...</div>

    <form
      *ngIf="!drawerLoading && drawerChild && childForm"
      class="drawer-form"
      [formGroup]="childForm"
      (ngSubmit)="saveChildEdits()"
    >
      <section class="grid2">
        <div>
          <label>שם פרטי ושם משפחה</label>
          <div class="val">
            {{ (drawerChild.first_name || '') + ' ' + (drawerChild.last_name || '') || '—' }}
          </div>
        </div>

        <div>
          <label>תעודת זהות</label>
          <div class="val" dir="ltr">{{ drawerChild.gov_id || '—' }}</div>
        </div>

        <div>
          <label>תאריך לידה</label>
          <div class="val">{{ drawerChild.birth_date || '—' }}</div>
        </div>

        <div>
          <label>מין</label>
          <div class="val">{{ drawerChild.gender || '—' }}</div>
        </div>

        <div>
          <label>קופת חולים</label>
          <div class="val">{{ drawerChild.health_fund || '—' }}</div>
        </div>

        <div>
          <label>סטטוס</label>
          <div class="val">{{ drawerChild.status || '—' }}</div>
        </div>

        <div class="colspan">
          <h4 class="section-title">פרטי הורה</h4>

          <div class="parent-brief" *ngIf="drawerChild?.parent as p; else noParent">
            <div class="parent-grid parent-grid--head">
              <div>שם הורה</div>
              <div>טלפון</div>
              <div>אימייל</div>
            </div>

            <div class="parent-grid parent-grid--row">
              <div class="strong">
                {{ (p.first_name || '') + ' ' + (p.last_name || '') || '—' }}
              </div>
              <div dir="ltr">{{ p.phone || '—' }}</div>
              <div dir="ltr">{{ p.email || '—' }}</div>
            </div>
          </div>

          <ng-template #noParent>
            <div class="hint">לא נמצאו פרטי הורה לילד זה.</div>
          </ng-template>
        </div>

        <div class="colspan">
          <label>הערות רפואיות</label>

          <div *ngIf="!editMode" class="val prewrap">
            {{ drawerChild.medical_notes || '—' }}
          </div>

          <textarea
            *ngIf="editMode"
            class="val textarea"
            rows="3"
            formControlName="medical_notes"
          ></textarea>
        </div>

        <div class="colspan">
          <label>הערות התנהגות</label>

          <div *ngIf="!editMode" class="val prewrap">
            {{ drawerChild.behavior_notes || '—' }}
          </div>

          <textarea
            *ngIf="editMode"
            class="val textarea"
            rows="3"
            formControlName="behavior_notes"
          ></textarea>
        </div>

        <!-- סוסים מתאימים -->
        <div class="colspan" *ngIf="horses && horses.length > 0">
          <label>סוסים מתאימים</label>

          <!-- מצב תצוגה -->
          <div *ngIf="!editMode" class="val prewrap">
            {{ horseNamesForChild(drawerChild.child_uuid) || '—' }}
          </div>

          <!-- מצב עריכה -->
          <div *ngIf="editMode" class="horses-select">
            <label class="horse-option" *ngFor="let h of horses">
              <input
                type="checkbox"
                [checked]="childHasHorse(drawerChild.child_uuid, h.id)"
                (change)="toggleChildHorse(
                  drawerChild.child_uuid,
                  h.id,
                  $any($event.target).checked
                )"
                [disabled]="savingChildHorses[drawerChild.child_uuid || '']"
              />
              <span>{{ h.name }}</span>
            </label>
          </div>
        </div>

        <div class="colspan" *ngIf="horses && horses.length === 0">
          <label>סוסים מתאימים</label>
          <div class="hint">עדיין לא הוגדרו סוסים בחווה.</div>
        </div>

        <!-- כפתורי שמירה / ביטול -->
        <div class="colspan drawer-footer" *ngIf="editMode">
          <button
            type="button"
            class="secondary"
            (click)="cancelChildEdit()"
          >
            ביטול
          </button>

          <button type="submit" class="primary">
            שמירה
          </button>
        </div>
      </section>
    </form>
  </mat-sidenav>

  <div></div>
</mat-sidenav-container>

<app-add-child-wizard
  *ngIf="showAddChildWizard"
  mode="secretary"
  (closed)="closeWizard()"
  (childAdded)="handleChildAddedFromWizard()"
></app-add-child-wizard>

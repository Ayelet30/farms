<h2>רשימת ילדים</h2>

<div *ngIf="isLoading" class="loading-state">טוען נתונים... ⏳</div>
<div *ngIf="error" class="error-state">שגיאה: {{ error }}</div>

<div *ngIf="!isLoading && !error && (children?.length ?? 0) > 0" class="table-container">
  <table>
    <thead>
      <tr>
        <th>שם פרטי</th>
        <th>שם משפחה</th>
        <th>תעודת זהות</th>
        <th>מזהה הורה (UUID)</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let child of children"
          class="clickable-row"
          (click)="openDetails(child.child_uuid || $any(child).id)">
        <td>{{ child.first_name || '—' }}</td>
        <td>{{ child.last_name || '—' }}</td>
        <td dir="ltr">{{ $any(child).gov_id || '—' }}</td>
        <td dir="ltr">{{ $any(child).parent_uid || $any(child).parent_id || '—' }}</td>
      </tr>
    </tbody>
  </table>
</div>

<div *ngIf="!isLoading && !error && (children?.length ?? 0) === 0" class="empty-state">
  לא נמצאו ילדים בחווה.
</div>

<!-- מגירה עם פרטי ילד -->
<mat-sidenav-container
  class="drawer-container"
  [class.drawer-open]="!!selectedId"
  dir="rtl"
  [hasBackdrop]="false">
  <mat-sidenav
    #drawer
    mode="side"
    position="end"
    class="drawer-pane"
    [opened]="!!selectedId">

    <div class="drawer-header">
      <button class="close-btn" (click)="closeDetails()">✕</button>
      <h3>פרטי ילד</h3>
    </div>

    <div *ngIf="drawerLoading" class="hint">טוען פרטים...</div>

    <ng-container *ngIf="!drawerLoading && drawerChild">
      <section class="grid2">

        <div>
          <label>שם פרטי ושם משפחה</label>
          <div class="val">
            {{ (drawerChild.first_name || '') + ' ' + (drawerChild.last_name || '') || '—' }}
          </div>
        </div>

        <div>
          <label>תעודת זהות</label>
          <div class="val" dir="ltr">{{ drawerChild.gov_id || '—' }}</div>
        </div>

        <div>
          <label>תאריך לידה</label>
          <div class="val">{{ drawerChild.birth_date || '—' }}</div>
        </div>

        <div>
          <label>מין</label>
          <div class="val">{{ drawerChild.gender || '—' }}</div>
        </div>

        <div>
          <label>קופת חולים</label>
          <div class="val">{{ drawerChild.health_fund || '—' }}</div>
        </div>

        <div>
          <label>סטטוס</label>
          <div class="val">{{ drawerChild.status || '—' }}</div>
        </div>

        <div class="colspan">
          <h4 class="section-title">פרטי הורה</h4>

          <div class="parent-brief" *ngIf="drawerChild?.parent as p; else noParent">
            <div class="parent-grid parent-grid--head">
              <div>שם הורה</div>
              <div>טלפון</div>
              <div>אימייל</div>
            </div>

            <div class="parent-grid parent-grid--row">
              <div class="strong">
                {{ (p.first_name || '') + ' ' + (p.last_name || '') || '—' }}
              </div>
              <div dir="ltr">{{ p.phone || '—' }}</div>
              <div dir="ltr">{{ p.email || '—' }}</div>
            </div>
          </div>

          <ng-template #noParent>
            <div class="hint">לא נמצאו פרטי הורה לילד זה.</div>
          </ng-template>
        </div>

        <div class="colspan">
          <label>הערות רפואיות</label>
          <div class="val prewrap">{{ drawerChild.medical_notes || '—' }}</div>
        </div>

        <div class="colspan">
          <label>הערות התנהגות</label>
          <div class="val prewrap">{{ drawerChild.behavior_notes || '—' }}</div>
        </div>

      </section>
    </ng-container>
  </mat-sidenav>
  <div></div>
</mat-sidenav-container>

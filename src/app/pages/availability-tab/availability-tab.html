<div class="availability-page">

  <!-- טוסט -->
  <div class="toast" *ngIf="toastMessage">
    {{ toastMessage }}
  </div>

  <!-- ⭐ פופאפ אישור זמינות ⭐ -->
  <div class="confirm-modal" *ngIf="confirmData">
    <div class="dialog">

      <button class="close-btn" (click)="cancelUpdate()">×</button>

      <div class="header-row">
        <img src="assets/icons/warning.svg" class="warn-icon" />
        <div>
          <h2 class="title">אישור שינויים בזמינות</h2>
          <p class="subtitle">ייתכן ששיעורים קיימים ייפגעו</p>
        </div>
      </div>

    <div class="yellow-box">
  נמצאו <strong>{{ confirmData?.parents?.length || 0 }}</strong>
  הורים שהשינוי ישפיע עליהם.
</div>

<div class="parent-list">
  <div class="parent-card" 
       *ngFor="let p of (confirmData?.parents || []); let i = index">
    <div class="index">{{ i + 1 }}</div>
    <div>
      <div class="parent-name">{{ p.name }}</div>
      <div class="parent-sub">הורה של: {{ p.child }}</div>
    </div>
  </div>
</div>


      <div class="note-box">
        <img src="assets/icons/lightbulb.svg" class="note-icon" />
        המזכירה תקבל התראה ותתאם מול ההורים תאריכים חלופיים.
      </div>

      <div class="actions">
        <button class="cancel" (click)="cancelUpdate()">ביטול</button>
        <button class="approve" (click)="approveUpdate()">
          <img src="assets/icons/save.svg" class="approve-icon" />
          אישור ושמירה
        </button>
      </div>

    </div>
  </div>

  <!-- ===== תוכן העמוד ===== -->

  <h1 class="page-title">העדפות זמינות והתראות</h1>
  <p class="page-subtitle">
    הגדרת ימי עבודה, טווחי שעות, סוג שיעור והפסקות.
  </p>

  <div class="cards-layout">

    <!-- זמינות שבועית -->
    <section class="card availability-card">

      <div class="card-header">
        <h2>זמינות שבועית</h2>
        <p class="card-subtitle">
          יש לבחור ימים פעילים ולהגדיר טווחי שעות, סוג שיעור והפסקות.
        </p>
      </div>

      <div class="days-list">

        <div class="day-block" *ngFor="let day of days">

          <!-- כותרת יום -->
          <div class="day-header">

            <div class="day-main">
              <span class="day-name">{{ day.label }}</span>

              <mat-slide-toggle
                [(ngModel)]="day.active"
                (change)="toggleDay(day)">
              </mat-slide-toggle>
            </div>

            <span class="badge" *ngIf="day.active">
              {{ day.slots.length }} טווחים
            </span>
          </div>

          <!-- טווחי זמן + הפסקות -->
          <div class="slots-wrapper" *ngIf="day.active">

            <!-- טווחי השיעור -->
            <div class="slot-row" *ngFor="let slot of day.slots; let i = index">

              <button class="delete-btn" (click)="removeSlot(day, i)">
                <mat-icon>delete</mat-icon>
              </button>

              <div class="slot-box">

                <div class="slot-field">
                  <label>שעת התחלה</label>
                  <div class="time-input">
                    <mat-icon class="clock-icon">schedule</mat-icon>
                    <input
                      type="time"
                      [(ngModel)]="slot.start"
                      (change)="onSlotChange(day, slot)"
                    />
                  </div>
                </div>

                <span class="dash">־</span>

                <div class="slot-field">
                  <label>שעת סיום</label>
                  <div class="time-input">
                    <mat-icon class="clock-icon">schedule</mat-icon>
                    <input
                      type="time"
                      [(ngModel)]="slot.end"
                      (change)="onSlotChange(day, slot)"
                    />
                  </div>
                </div>

                <!-- ⭐ סוג שיעור -->
                <div class="slot-field lesson-type">
                  <label>סוג שיעור</label>
                  <select
                    class="lesson-type-select"
                    [(ngModel)]="slot.lessonType"
                    (change)="onSlotChange(day, slot)"
                  >
                    <option *ngFor="let opt of lessonTypeOptions" [value]="opt.value">
                      {{ opt.label }}
                    </option>
                  </select>
                </div>

              </div>
            </div>

            <!-- כפתור הוספת טווח זמן -->
            <button class="add-slot-btn" (click)="addSlot(day)">
              <mat-icon>add</mat-icon>
              הוסף טווח זמן
            </button>

            <hr />

            <!-- ⭐ הפסקות -->
            <div class="break-row" *ngFor="let br of day.breaks; let j = index">

              <button class="delete-btn" (click)="removeBreak(day, j)">
                <mat-icon>delete</mat-icon>
              </button>

              <div class="break-box">

                <div class="slot-field">
                  <label>הפסקה מתחילה</label>
                  <div class="time-input">
                    <mat-icon class="clock-icon">schedule</mat-icon>
                    <input
                      type="time"
                      [(ngModel)]="br.start"
                      (change)="onBreakChange(day, br)"
                    />
                  </div>
                </div>

                <span class="dash">־</span>

                <div class="slot-field">
                  <label>הפסקה מסתיימת</label>
                  <div class="time-input">
                    <mat-icon class="clock-icon">schedule</mat-icon>
                    <input
                      type="time"
                      [(ngModel)]="br.end"
                      (change)="onBreakChange(day, br)"
                    />
                  </div>
                </div>

              </div>

            </div>

            <!-- כפתור הוספת הפסקה -->
            <button class="add-slot-btn" (click)="addBreak(day)">
              <mat-icon>add</mat-icon>
              הוסף הפסקה
            </button>

          </div>
        </div>

      </div>

      <div class="card-footer">
        <button class="primary-btn" (click)="saveAvailability()" [disabled]="!isDirty">
          שמור זמינות
        </button>
      </div>
    </section>

    <!-- התראות -->
    <section class="card notifications-card">

      <div class="card-header">
        <h2>העדפות התראות</h2>
      </div>

      <div class="notif-list">

        <div class="notif-row">
          <div class="notif-texts">
            <div class="notif-title">ביטול שיעור</div>
            <div class="notif-desc">התראה כאשר שיעור מבוטל.</div>
          </div>

          <label class="custom-toggle">
            <input type="checkbox" [(ngModel)]="notif.cancelLesson" />
            <span class="slider"></span>
          </label>
        </div>

        <div class="notif-row">
          <div class="notif-texts">
            <div class="notif-title">תזכורת</div>
            <div class="notif-desc">התראה לפני שיעור.</div>
          </div>

          <label class="custom-toggle">
            <input type="checkbox" [(ngModel)]="notif.reminder" />
            <span class="slider"></span>
          </label>
        </div>

        <div class="notif-row">
          <div class="notif-texts">
            <div class="notif-title">דוח חודשי</div>
            <div class="notif-desc">נשלח אלייך במייל.</div>
          </div>

          <label class="custom-toggle">
            <input type="checkbox" [(ngModel)]="notif.monthlyReport" />
            <span class="slider"></span>
          </label>
        </div>

      </div>

      <div class="card-footer">
        <button class="primary-btn" (click)="saveNotifications()">
          שמור העדפות התראות
        </button>
      </div>

    </section>

  </div>

</div>

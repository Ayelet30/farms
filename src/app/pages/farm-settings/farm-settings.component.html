<div class="farm-settings-page">
  <div class="farm-settings-card">
    <div class="card-header">
      <h1>הגדרות חווה</h1>

      <div class="status-area">
        <span *ngIf="loading()" class="status-chip">טוען נתונים…</span>
        <span *ngIf="saving()" class="status-chip saving">שומר…</span>
        <span *ngIf="success()" class="status-chip success">{{ success() }}</span>
        <span *ngIf="error()" class="status-chip error">{{ error() }}</span>
      </div>
    </div>

    <form *ngIf="settings() as s" class="settings-form" (ngSubmit)="saveSettings()" autocomplete="off">
      <!-- שעות פעילות -->
      <section class="settings-section">
        <div class="subsection-header">
          <h2>שעות פעילות החווה</h2>

          <button type="button" class="icon-btn" (click)="openSpecialDays()">
            <span class="plus-icon">+</span>
            <span>ימים מיוחדים</span>
          </button>
        </div>

        <div class="fields-grid two-cols">
          <label class="field">
            <span class="field-label">שעת פתיחה</span>
            <input type="time" [(ngModel)]="s.operating_hours_start" name="operating_hours_start" required />
          </label>

          <label class="field">
            <span class="field-label">שעת סגירה</span>
            <input type="time" [(ngModel)]="s.operating_hours_end" name="operating_hours_end" required />
          </label>
        </div>
        <!-- שעות פעילות המשרד -->
        <div class="subsection-header" style="margin-top: 14px;">
          <h2 style="margin: 0;">שעות פעילות המשרד</h2>
        </div>

        <div class="fields-grid two-cols">
          <label class="field">
            <span class="field-label">שעת פתיחה (משרד)</span>
            <input type="time" [(ngModel)]="s.office_hours_start" name="office_hours_start"
              (ngModelChange)="onOfficeHoursChanged()" />
          </label>

          <label class="field">
            <span class="field-label">שעת סגירה (משרד)</span>
            <input type="time" [(ngModel)]="s.office_hours_end" name="office_hours_end"
              (ngModelChange)="onOfficeHoursChanged()" />
          </label>
        </div>
        <div class="inline-error" *ngIf="officeHoursError()">
          {{ officeHoursError() }}
        </div>



        <!-- ===== ימי עבודה בשבוע (NEW) ===== -->
        <div class="subsection-header" style="margin-top: 14px;">
          <h2 style="margin: 0;">ימי עבודה בשבוע</h2>

          <div class="inline-actions">
            <button type="button" class="ghost-btn" (click)="setWorkingDaysWeekdaysOnly()">
              א–ה
            </button>
            <button type="button" class="ghost-btn" (click)="setWorkingDaysAllWeek()">
              כל השבוע
            </button>
          </div>
        </div>

        <div class="working-days">
          <label class="day-pill">
            <input type="checkbox" [checked]="isWorkingDayChecked(1)"
              (change)="toggleWorkingDay(1, $any($event.target).checked)" />
            <span class="pill-label">א׳</span>
          </label>

          <label class="day-pill">
            <input type="checkbox" [checked]="isWorkingDayChecked(2)"
              (change)="toggleWorkingDay(2, $any($event.target).checked)" />
            <span class="pill-label">ב׳</span>
          </label>

          <label class="day-pill">
            <input type="checkbox" [checked]="isWorkingDayChecked(3)"
              (change)="toggleWorkingDay(3, $any($event.target).checked)" />
            <span class="pill-label">ג׳</span>
          </label>

          <label class="day-pill">
            <input type="checkbox" [checked]="isWorkingDayChecked(4)"
              (change)="toggleWorkingDay(4, $any($event.target).checked)" />
            <span class="pill-label">ד׳</span>
          </label>

          <label class="day-pill">
            <input type="checkbox" [checked]="isWorkingDayChecked(5)"
              (change)="toggleWorkingDay(5, $any($event.target).checked)" />
            <span class="pill-label">ה׳</span>
          </label>

          <!-- אופציונלי -->
          <label class="day-pill">
            <input type="checkbox" [checked]="isWorkingDayChecked(6)"
              (change)="toggleWorkingDay(6, $any($event.target).checked)" />
            <span class="pill-label">ו׳</span>
          </label>

          <label class="day-pill">
            <input type="checkbox" [checked]="isWorkingDayChecked(7)"
              (change)="toggleWorkingDay(7, $any($event.target).checked)" />
            <span class="pill-label">ש׳</span>
          </label>
        </div>

        <small class="field-hint">
          ימים אלו קובעים מתי ניתן לקבוע שיעורים, ולידציות בלו״ז וחישובי מערכת.
        </small>
        <!-- ===== סוף ימי עבודה בשבוע ===== -->

        <section class="settings-section" *ngIf="settings() as s">
          <h2>לוח שנה ושעות</h2>

          <div class="fields-grid three-cols">
            <label class="field">
              <span class="field-label">גרנולריות זמן (דקות)</span>
              <input type="number" min="5" step="5" [(ngModel)]="s.time_slot_minutes" name="time_slot_minutes" />
              <small class="field-hint">לדוגמה 15 כדי ליישר שעות בלו״ז ובוולידציות.</small>
            </label>

            <label class="field">
              <span class="field-label">אזור זמן</span>
              <input type="text" [(ngModel)]="s.timezone" name="timezone" placeholder="Asia/Jerusalem" />
              <small class="field-hint">חשוב ל-cron / Cloud Functions.</small>
            </label>
          </div>
        </section>


        <!-- רשימת ימים מיוחדים קיימים -->
        <div class="special-days-list" *ngIf="daysOff().length">
          <div class="special-days-title">ימים מיוחדים שהוגדרו</div>

          <div class="special-days-row" *ngFor="let d of daysOff()">
            <div class="special-days-main">
              <div class="special-days-dates">
                {{ d.start_date | date:'dd/MM/yyyy' }} -
                {{ d.end_date | date:'dd/MM/yyyy' }}
                <span class="meta-chip">
                  {{
                  d.all_day
                  ? 'כל היום'
                  : ('החווה עובדת: ' + d.start_time + ' - ' + d.end_time)
                  }}
                </span>
              </div>

              <div class="special-days-reason">{{ d.reason }}</div>
            </div>

            <button type="button" class="text-btn danger" (click)="deactivateDayOff(d)">
              ביטול
            </button>
          </div>
        </div>
      </section>

      <!-- שיעורים -->
      <section class="settings-section">
        <h2>הגדרות שיעורים</h2>

        <div class="fields-grid three-cols">
          <label class="field">
            <span class="field-label">מס' שיעורים בסדרה</span>
            <input type="number" min="1" [(ngModel)]="s.default_lessons_per_series" name="default_lessons_per_series" />
          </label>

          <label class="field">
            <span class="field-label">אורך שיעור (דקות)</span>
            <input type="number" min="10" [(ngModel)]="s.lesson_duration_minutes" name="lesson_duration_minutes" />
          </label>

          <label class="field">
            <span class="field-label">מחיר שיעור רגיל (₪)</span>
            <input type="number" min="0" step="0.5" [(ngModel)]="s.default_lesson_price" name="default_lesson_price" />
          </label>
        </div>

        <div class="fields-grid three-cols">
          <label class="field">
            <span class="field-label">מקס' רוכבים בשיעור קבוצתי</span>
            <input type="number" min="1" [(ngModel)]="s.max_group_size" name="max_group_size" />
          </label>

          <!-- מקס שיעורים בשבוע + ללא הגבלה -->
          <div class="field">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
              <span class="field-label">מקס' שיעורים בשבוע לילד</span>

              <label style="display:flex; align-items:center; gap:8px; font-size:13px;">
                <input type="checkbox" [checked]="isUnlimitedLessonsPerWeek()"
                  (change)="setUnlimitedLessonsPerWeek($any($event.target).checked)" />
                <span>ללא הגבלה</span>
              </label>
            </div>

            <input type="number" min="1" [(ngModel)]="s.max_lessons_per_week_per_child"
              name="max_lessons_per_week_per_child" [disabled]="isUnlimitedLessonsPerWeek()"
              [placeholder]="isUnlimitedLessonsPerWeek() ? 'ללא הגבלה' : ''" />
          </div>

          <label class="field toggle">
            <span class="field-label">אפשר זימון שיעורים ע&quot;י הורים</span>
            <input type="checkbox" [(ngModel)]="s.allow_online_booking" name="allow_online_booking" />
          </label>
        </div>
      </section>


      <!-- השלמות וביטולים -->
      <section class="settings-section" *ngIf="settings() as s">
        <h2>ביטולים / השלמות / נוכחות</h2>

        <div class="fields-grid three-cols">
          <label class="field">
            <span class="field-label">ימי אחורה להשלמות</span>
            <input type="number" min="0" [(ngModel)]="s.makeup_allowed_days_back" name="makeup_allowed_days_back" />
          </label>

          <label class="field">
            <span class="field-label">מקס' השלמות בתקופה</span>
            <input type="number" min="0" [(ngModel)]="s.max_makeups_in_period" name="max_makeups_in_period" />
          </label>

          <label class="field">
            <span class="field-label">גודל תקופה (ימים)</span>
            <input type="number" min="1" [(ngModel)]="s.makeups_period_days" name="makeups_period_days" />
          </label>
        </div>

        <div class="fields-grid two-cols">
          <label class="field">
            <span class="field-label">מס' שיעורי השלמה להצגה</span>
            <input type="number" min="1" [(ngModel)]="s.displayed_makeup_lessons_count"
              name="displayed_makeup_lessons_count" />
          </label>

          <label class="field">
            <span class="field-label">הפרש מינימלי בין ביטולים (שעות:דקות)</span>
            <input type="time" [(ngModel)]="s.min_time_between_cancellations" name="min_time_between_cancellations" />
          </label>
        </div>



        <div class="fields-grid three-cols">
          <label class="field">
            <span class="field-label">ביטול עד (שעות לפני)</span>
            <input type="number" min="0" [(ngModel)]="s.cancel_before_hours" name="cancel_before_hours" />
          </label>

          <label class="field">
            <span class="field-label">מדיניות ביטול מאוחר</span>
            <select [(ngModel)]="s.late_cancel_policy" name="late_cancel_policy">
              <option [ngValue]="'CHARGE_FULL'">חיוב מלא</option>
              <option [ngValue]="'CHARGE_PARTIAL'">חיוב חלקי</option>
              <option [ngValue]="'NO_CHARGE'">ללא חיוב</option>
              <option [ngValue]="'NO_MAKEUP'">אין השלמה</option>
            </select>
          </label>

          <label class="field">
            <span class="field-label">ימי השלמה קדימה</span>
            <input type="number" min="0" [(ngModel)]="s.makeup_allowed_days_ahead" name="makeup_allowed_days_ahead" />
          </label>
        </div>

        <div class="fields-grid three-cols">
          <label class="field">
            <span class="field-label">קנס ביטול מאוחר (₪)</span>
            <input type="number" min="0" step="0.5" [(ngModel)]="s.late_cancel_fee_amount"
              name="late_cancel_fee_amount" />
          </label>

          <label class="field">
            <span class="field-label">קנס ביטול מאוחר (%)</span>
            <input type="number" min="0" max="100" step="0.5" [(ngModel)]="s.late_cancel_fee_percent"
              name="late_cancel_fee_percent" />
          </label>

          <label class="field">
            <span class="field-label">ברירת מחדל לנוכחות</span>
            <select [(ngModel)]="s.attendance_default" name="attendance_default">
              <option [ngValue]="'ASSUME_ATTENDED'">נחשב “הגיע” אם לא סומן</option>
              <option [ngValue]="'ASSUME_ABSENT'">נחשב “לא הגיע” אם לא סומן</option>
              <option [ngValue]="'REQUIRE_MARKING'">חובה סימון</option>
            </select>
          </label>
        </div>
      </section>

      <section class="settings-section" *ngIf="settings() as s">
        <h2>תזכורות והתראות</h2>

        <div class="fields-grid three-cols">
          <label class="field toggle">
            <span class="field-label">שליחת תזכורת לשיעור</span>
            <input type="checkbox" [(ngModel)]="s.send_lesson_reminder" name="send_lesson_reminder" />
          </label>

          <label class="field">
            <span class="field-label">כמה שעות לפני</span>
            <input type="number" min="0" [(ngModel)]="s.reminder_hours_before" name="reminder_hours_before"
              [disabled]="!s.send_lesson_reminder" />
          </label>

          <label class="field">
            <span class="field-label">ערוץ תזכורת</span>
            <select [(ngModel)]="s.reminder_channel" name="reminder_channel" [disabled]="!s.send_lesson_reminder">
              <option [ngValue]="null">ללא</option>
              <option [ngValue]="'APP'">אפליקציה</option>
              <option [ngValue]="'EMAIL'">אימייל</option>
              <option [ngValue]="'SMS'">SMS</option>
              <option [ngValue]="'WHATSAPP'">וואטסאפ</option>
            </select>
          </label>
        </div>

        <div class="fields-grid two-cols">
          <label class="field">
            <span class="field-label">שעת שקט – התחלה</span>
            <input type="time" [(ngModel)]="s.quiet_hours_start" name="quiet_hours_start" />
          </label>

          <label class="field">
            <span class="field-label">שעת שקט – סיום</span>
            <input type="time" [(ngModel)]="s.quiet_hours_end" name="quiet_hours_end" />
          </label>
        </div>
      </section>

      <section class="settings-section" *ngIf="settings() as s">
        <h2>חיובים / הנחות / קנסות</h2>

        <div class="fields-grid three-cols">
          <label class="field">
            <span class="field-label">יום חיוב חודשי (1–28)</span>
            <input type="number" min="1" max="28" [(ngModel)]="s.monthly_billing_day" name="monthly_billing_day" />
          </label>

          <label class="field toggle">
            <span class="field-label">אפשר הנחות</span>
            <input type="checkbox" [(ngModel)]="s.enable_discounts" name="enable_discounts" />
          </label>
        </div>

        <div class="fields-grid three-cols">
          <label class="field">
            <span class="field-label">קנס פיגור (₪)</span>
            <input type="number" min="0" step="0.5" [(ngModel)]="s.late_payment_fee" name="late_payment_fee" />
          </label>

          <label class="field">
            <span class="field-label">ריבית חודשית (%)</span>
            <input type="number" min="0" max="100" step="0.1" [(ngModel)]="s.interest_percent_monthly"
              name="interest_percent_monthly" />
          </label>
        </div>
      </section>



      <!-- תשלומים ודמי רישום -->
      <section class="settings-section">
        <h2>תשלומים ודמי רישום</h2>

        <div class="fields-grid three-cols">
          <label class="field">
            <span class="field-label">דמי רישום (₪)</span>
            <input type="number" min="0" step="0.5" [(ngModel)]="s.registration_fee" name="registration_fee" />
          </label>

          <label class="field">
            <span class="field-label">ביטוח תלמידים (₪ לשנה)</span>
            <input type="number" min="0" step="0.5" [(ngModel)]="s.student_insurance_premiums"
              name="student_insurance_premiums" />
          </label>

          <div class="field readonly" *ngIf="s.updated_at">
            <span class="field-label">עודכן לאחרונה</span>
            <span class="readonly-value">{{ s.updated_at | date:'dd.MM.yyyy HH:mm' }}</span>
          </div>
        </div>
      </section>

      <div class="actions">
        <button type="submit" class="primary-btn" [disabled]="saving() || loading()">שמירת הגדרות</button>
      </div>
    </form>

    <!-- ========== מסלולי תשלום ========== -->
    <section class="settings-section">
      <div class="subsection-header">
        <h2>מסלולי תשלום</h2>

        <button type="button" class="icon-btn" (click)="toggleNewPlanForm()">
          <span class="plus-icon">+</span>
          <span>הוספת מסלול חדש</span>
        </button>
      </div>

      <!-- חלון נפתח – טופס מסלול חדש -->
      <div class="inline-panel" *ngIf="showNewPlanForm()">
        <div class="fields-grid three-cols">
          <div class="field">
            <label class="field-label">שם המסלול</label>
            <input type="text" name="newPlanName" [(ngModel)]="newPlan.name" />
          </div>

          <div class="field">
            <label class="field-label">מחיר לשיעור (₪)</label>
            <input type="number" name="newPlanLessonPrice" [(ngModel)]="newPlan.lesson_price" />
          </div>

          <div class="field">
            <label class="field-label">סבסוד (₪)</label>
            <input type="number" name="newPlanSubsidy" [(ngModel)]="newPlan.subsidy_amount" />
          </div>

          <div class="field">
            <label class="field-label">גורם מימון</label>
            <select name="newPlanFunding" [(ngModel)]="newPlan.funding_source_id">
              <option [ngValue]="null">ללא</option>
              <option *ngFor="let fs of fundingSources()" [ngValue]="fs.id" [disabled]="!fs.is_active">
                {{ fs.name }}<ng-container *ngIf="!fs.is_active"> (לא פעיל)</ng-container>
              </option>
            </select>
          </div>

          <div class="field">
            <label class="field-label">דרישת מסמכים</label>
            <textarea rows="3" name="newPlanDocs" [ngModel]="getDocsText(newPlan)"
              (ngModelChange)="onNewPlanDocsChange($event)"></textarea>
            <small class="field-hint">כל שורה = סוג קובץ (למשל: התחייבות קופה, אישור זכאות)</small>
          </div>

          <div class="field toggle">
            <span class="field-label">חובה מסמכים בזמן קביעת סדרה</span>
            <input type="checkbox" name="newPlanRequireDocs" [(ngModel)]="newPlan.require_docs_at_booking" />
          </div>
        </div>

        <div class="panel-actions">
          <button type="button" class="primary-btn" (click)="addPaymentPlan()">שמירת מסלול חדש</button>
          <button type="button" class="ghost-btn" (click)="toggleNewPlanForm()">ביטול</button>
        </div>
      </div>

      <!-- רשימת מסלולים קיימים -->
      <div class="list-block" *ngIf="paymentPlans().length; else noPlans">
        <div class="list-header-row">
          <span class="col-main">מסלול</span>
          <span class="col-secondary">מחירים</span>
          <span class="col-secondary">גורם מימון</span>
          <span class="col-secondary">מסמכים</span>
          <span class="col-actions">פעולות</span>
        </div>

        <div class="list-row" *ngFor="let p of paymentPlans()" [class.inactive]="p.is_active === false">
          <div class="col-main">
            <div class="list-title">{{ p.name }}</div>
            <div class="list-sub" *ngIf="p.is_active === false">
              <span class="status-tag danger">לא פעיל</span>
            </div>
          </div>

          <div class="col-secondary">
            <span class="meta-chip">מחיר שיעור: {{ (p.lesson_price || 0) | number:'1.0-0' }} ₪</span>
            <span class="meta-chip" *ngIf="(p.subsidy_amount || 0) > 0">
              סבסוד: {{ p.subsidy_amount | number:'1.0-0' }} ₪
            </span>
            <span class="meta-chip highlight">
              לקוח משלם: {{ getCustomerAmount(p) | number:'1.0-0' }} ₪
            </span>
          </div>

          <div class="col-secondary">
            <span class="meta-chip">{{ getFundingName(p.funding_source_id || null) }}</span>
          </div>

          <div class="col-secondary">
            <span class="meta-chip" *ngIf="p.required_docs?.length; else noDocs">
              {{ p.required_docs.length }} סוגי מסמכים
            </span>
            <ng-template #noDocs>
              <span class="meta-chip muted">אין מסמכים נדרשים</span>
            </ng-template>
          </div>

          <div class="col-actions">
            <button type="button" class="text-btn" (click)="startEditPlan(p)">עריכה</button>
            <button type="button" class="text-btn danger" (click)="deletePaymentPlan(p)">מחיקה</button>
          </div>
        </div>

        <!-- פנל עריכה למסלול נבחר -->
        <ng-container *ngFor="let p of paymentPlans()">
          <div class="inline-panel" *ngIf="editingPlanId() === p.id">
            <div class="panel-title">עריכת מסלול – {{ p.name }}</div>

            <div class="fields-grid three-cols">
              <div class="field">
                <label class="field-label">שם המסלול</label>
                <input type="text" name="editPlanName_{{p.id}}" [(ngModel)]="p.name" />
              </div>

              <div class="field">
                <label class="field-label">מחיר נוכחי לשיעור (₪)</label>
                <input type="number" name="editPlanLessonPrice_{{p.id}}" [(ngModel)]="p.lesson_price" />
              </div>

              <div class="field">
                <label class="field-label">סבסוד נוכחי (₪)</label>
                <input type="number" name="editPlanSubsidy_{{p.id}}" [(ngModel)]="p.subsidy_amount" />
              </div>

              <div class="field">
                <label class="field-label">גורם מימון</label>
                <select name="editPlanFunding_{{p.id}}" [(ngModel)]="p.funding_source_id">
                  <option [ngValue]="null">ללא</option>
                  <option *ngFor="let fs of fundingSources()" [ngValue]="fs.id" [disabled]="!fs.is_active">
                    {{ fs.name }}<ng-container *ngIf="!fs.is_active"> (לא פעיל)</ng-container>
                  </option>
                </select>
              </div>

              <div class="field">
                <label class="field-label">מסמכים נדרשים</label>
                <textarea rows="3" name="editPlanDocs_{{p.id}}" [ngModel]="getDocsText(p)"
                  (ngModelChange)="onDocsTextChange(p, $event)"></textarea>
                <small class="field-hint">כל שורה = סוג קובץ נדרש</small>
              </div>

              <div class="field toggle">
                <span class="field-label">חובה מסמכים בזמן קביעת סדרה</span>
                <input type="checkbox" name="editPlanRequireDocs_{{p.id}}" [(ngModel)]="p.require_docs_at_booking" />
              </div>

              <div class="field toggle">
                <span class="field-label">מסלול פעיל</span>
                <input type="checkbox" name="editPlanIsActive_{{p.id}}" [(ngModel)]="p.is_active" />
              </div>
            </div>

            <div class="fields-grid three-cols">
              <div class="field">
                <label class="field-label">תאריך תחולה לשינוי מחיר</label>
                <input type="date" name="planVersionDate_{{p.id}}" [(ngModel)]="p.newVersionDate" />
                <small class="field-hint">השינוי יחול על שיעורים מתאריך זה והלאה.</small>
              </div>

              <div class="field">
                <label class="field-label">מחיר חדש לשיעור (₪)</label>
                <input type="number" name="planVersionPrice_{{p.id}}" [(ngModel)]="p.newVersionPrice" />
              </div>

              <div class="field">
                <label class="field-label">סבסוד חדש (₪)</label>
                <input type="number" name="planVersionSubsidy_{{p.id}}" [(ngModel)]="p.newVersionSubsidy" />
              </div>
            </div>

            <div class="history-block" *ngIf="p.versions?.length">
              <div class="history-title">היסטוריית מחירים</div>

              <div class="history-row" *ngFor="let v of p.versions">
                <span class="history-date">מ־{{ v.valid_from | date:'dd/MM/yyyy' }}:</span>
                <span class="history-chip">מחיר: {{ v.lesson_price | number:'1.0-0' }} ₪</span>
                <span class="history-chip" *ngIf="(v.subsidy_amount || 0) > 0">
                  סבסוד: {{ v.subsidy_amount | number:'1.0-0' }} ₪
                </span>
                <span class="history-chip highlight">
                  לקוח משלם: {{ v.customer_amount | number:'1.0-0' }} ₪
                </span>
              </div>
            </div>

            <div class="panel-actions">
              <button type="button" class="primary-btn" (click)="savePlanPriceVersion(p)">
                שמירת שינוי מחיר עם היסטוריה
              </button>
              <button type="button" class="ghost-btn" (click)="updatePaymentPlan(p)">
                שמירת שינויים כלליים במסלול
              </button>
              <button type="button" class="ghost-btn" (click)="cancelEditPlan()">ביטול</button>
            </div>
          </div>
        </ng-container>
      </div>

      <ng-template #noPlans>
        <div class="empty-state">
          עדיין אין מסלולי תשלום מוגדרים.
          <button type="button" class="text-btn" (click)="toggleNewPlanForm()">הוספת מסלול ראשון</button>
        </div>
      </ng-template>
    </section>

    <!-- ========== גורמי מימון ========== -->
    <section class="settings-section">
      <div class="subsection-header">
        <h2>גורמי מימון</h2>

        <button type="button" class="icon-btn" (click)="toggleNewFundingForm()">
          <span class="plus-icon">+</span>
          <span>הוספת גורם מימון</span>
        </button>
      </div>

      <div class="inline-panel" *ngIf="showNewFundingForm()">
        <div class="fields-grid two-cols">
          <div class="field">
            <label class="field-label">שם גורם המימון</label>
            <input type="text" name="newFundingName" [ngModel]="newFundingSourceName()"
              (ngModelChange)="newFundingSourceName.set($event)" />
          </div>
        </div>

        <div class="panel-actions">
          <button type="button" class="primary-btn" (click)="addFundingSource()">שמירת גורם מימון</button>
          <button type="button" class="ghost-btn" (click)="toggleNewFundingForm()">ביטול</button>
        </div>
      </div>

      <div class="list-block" *ngIf="fundingSources().length; else noFunding">
        <div class="list-header-row">
          <span class="col-main">שם גורם מימון</span>
          <span class="col-secondary">סוג</span>
          <span class="col-secondary">סטטוס</span>
          <span class="col-actions">פעולות</span>
        </div>

        <div class="list-row" *ngFor="let fs of fundingSources()" [class.inactive]="!fs.is_active">
          <div class="col-main">
            <div class="list-title">{{ fs.name }}</div>
          </div>

          <div class="col-secondary">
            <span class="status-tag" [class.info]="fs.is_system" [class.neutral]="!fs.is_system">
              {{ fs.is_system ? 'גורם מערכת' : 'מותאם לחווה' }}
            </span>
          </div>

          <div class="col-secondary">
            <span class="status-tag" [class.success]="fs.is_active" [class.danger]="!fs.is_active">
              {{ fs.is_active ? 'פעיל' : 'לא פעיל' }}
            </span>
          </div>

          <div class="col-actions" *ngIf="!fs.is_system">
            <button type="button" class="text-btn" (click)="startEditFunding(fs)">עריכה</button>
            <button type="button" class="text-btn danger" (click)="deleteFundingSource(fs)">מחיקה</button>
          </div>

          <div class="col-actions" *ngIf="fs.is_system">
            <span class="meta-chip muted">לא ניתן לעריכה</span>
          </div>
        </div>

        <ng-container *ngFor="let fs of fundingSources()">
          <div class="inline-panel" *ngIf="editingFundingId() === fs.id">
            <div class="panel-title">עריכת גורם מימון – {{ fs.name }}</div>

            <div class="fields-grid two-cols">
              <div class="field">
                <label class="field-label">שם גורם מימון</label>
                <input type="text" name="editFundingName_{{fs.id}}" [(ngModel)]="fs.name" />
              </div>

              <div class="field toggle">
                <span class="field-label">פעיל</span>
                <input type="checkbox" name="editFundingIsActive_{{fs.id}}" [(ngModel)]="fs.is_active" />
              </div>
            </div>

            <div class="panel-actions">
              <button type="button" class="primary-btn" (click)="updateFundingSource(fs)">שמירת שינויים</button>
              <button type="button" class="ghost-btn" (click)="cancelEditFunding()">ביטול</button>
            </div>
          </div>
        </ng-container>
      </div>

      <ng-template #noFunding>
        <div class="empty-state">
          עדיין לא הוגדרו גורמי מימון.
          <button type="button" class="text-btn" (click)="toggleNewFundingForm()">הוספת גורם ראשון</button>
        </div>
      </ng-template>
    </section>

    <!-- ===== מודאל ימים מיוחדים ===== -->
    <div class="modal-backdrop" *ngIf="showSpecialDaysModal()" (click)="closeSpecialDaysModal()">
      <div class="modal-card" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <div class="modal-title">ימים מיוחדים</div>
          <button type="button" class="x-btn" (click)="closeSpecialDaysModal()">✕</button>
        </div>

        <div class="fields-grid two-cols">
          <label class="field">
            <span class="field-label">מתאריך</span>
            <input type="date" [ngModel]="specialDayForm().start_date"
              (ngModelChange)="patchSpecialDayForm({ start_date: $event })" />
          </label>

          <label class="field">
            <span class="field-label">עד תאריך</span>
            <input type="date" [ngModel]="specialDayForm().end_date"
              (ngModelChange)="patchSpecialDayForm({ end_date: $event })" />
          </label>

          <label class="field toggle">
            <span class="field-label">כל היום</span>
            <input type="checkbox" [ngModel]="specialDayForm().all_day" (ngModelChange)="onToggleAllDay($event)" />
          </label>
        </div>

        <div class="inline-panel inline-panel-open" *ngIf="!specialDayForm().all_day">
          <div class="panel-title">החווה עובדת</div>

          <div class="fields-grid two-cols">
            <label class="field">
              <span class="field-label">משעה</span>
              <input type="time" [ngModel]="specialDayForm().start_time"
                (ngModelChange)="patchSpecialDayForm({ start_time: $event })" />
            </label>

            <label class="field">
              <span class="field-label">עד שעה</span>
              <input type="time" [ngModel]="specialDayForm().end_time"
                (ngModelChange)="patchSpecialDayForm({ end_time: $event })" />
            </label>
          </div>
        </div>

        <label class="field">
          <span class="field-label">סיבה</span>
          <input type="text" placeholder="לדוגמה: חופשת פסח" [ngModel]="specialDayForm().reason"
            (ngModelChange)="patchSpecialDayForm({ reason: $event })" />
        </label>

        <div class="panel-actions">
          <button type="button" class="primary-btn" (click)="saveSpecialDay()" [disabled]="saving()">
            שמירה
          </button>
          <button type="button" class="ghost-btn" (click)="closeSpecialDaysModal()">
            ביטול
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
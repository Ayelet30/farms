<!-- src/app/pages/farm-settings/farm-settings.component.html -->
<div class="farm-settings-page" dir="rtl">
  <div class="farm-settings-card">
    <div class="card-header">
      <h1>הגדרות חווה</h1>

      <div class="status-area">
        <span *ngIf="loading()" class="status-chip">טוען נתונים…</span>
        <span *ngIf="saving()" class="status-chip saving">שומר…</span>
        <span *ngIf="success()" class="status-chip success">{{ success() }}</span>
        <span *ngIf="error()" class="status-chip error">{{ error() }}</span>
      </div>
    </div>

    <!-- =================== FORM SETTINGS =================== -->
    <form *ngIf="settings() as s" class="settings-form" (ngSubmit)="saveSettings()" autocomplete="off">
      <!-- =================== שעות פעילות לפי יום =================== -->
      <section class="settings-section">
        <div class="subsection-header accordion">
          <button type="button" class="accordion-toggle" (click)="toggleWorkingHoursExpanded()"
            [attr.aria-expanded]="workingHoursExpanded()">
            <span class="chev" [class.open]="workingHoursExpanded()">▾</span>
            <h2>שעות פעילות לפי יום</h2>
          </button>

          <div class="fields-grid three-cols">
            <label class="field">
              <span class="field-label">אזור זמן</span>
              <label type="text" [(ngModel)]="s.timezone" name="timezone">Asia/Jerusalem</label>
            </label>
          </div>

          <div class="inline-actions">
            <button type="button" class="primary-btn" (click)="saveWorkingHours()"
              [disabled]="saving() || loading() || !!workingHoursError() || !canSaveWorkingHours()">
              שמירת שעות לפי יום
            </button>
          </div>
        </div>

        <small class="field-hint">
          כאן מגדירים בפועל שעות פעילות חווה/משרד לכל יום.
        </small>

        <div class="inline-error" *ngIf="workingHoursError()">
          {{ workingHoursError() }}
        </div>

        <div *ngIf="workingHoursExpanded()">
          <div class="list-block" *ngIf="workingHours().length; else noWorkingHours">
            <div class="list-header-row">
              <span class="col-main">יום</span>
              <span class="col-secondary">פתוח</span>
              <span class="col-secondary">חווה</span>
              <span class="col-secondary">משרד פתוח</span>
              <span class="col-secondary">משרד</span>
            </div>

            <!-- ✅ trackBy -->
            <div class="list-row" *ngFor="let r of workingHours(); trackBy: trackByDay">
              <!-- יום -->
              <div class="col-main">
                {{ getHebDayLabel(r.day_of_week) }}
              </div>

              <!-- פתוח (חווה) -->
              <div class="col-secondary mini-toggle">
                <input type="checkbox" class="wh-check" [(ngModel)]="r.is_open" name="whOpen{{ r.day_of_week }}"
                  (ngModelChange)="onFarmOpenToggle(r); onWorkingHoursChanged()" />
              </div>

              <!-- שעות חווה -->
              <div class="col-secondary">
                <input type="time" class="wh-time" [(ngModel)]="r.farm_start" name="whFarmStart{{ r.day_of_week }}"
                  [disabled]="!r.is_open" (ngModelChange)="onWorkingHoursTimeChanged()" />
                <span class="sep">–</span>
                <input type="time" class="wh-time" [(ngModel)]="r.farm_end" name="whFarmEnd{{ r.day_of_week }}"
                  [disabled]="!r.is_open" (ngModelChange)="onWorkingHoursTimeChanged()" />

              </div>
              <!-- משרד פתוח -->
              <div class="col-secondary mini-toggle">
                <input type="checkbox" class="wh-check" [(ngModel)]="r.is_offical_open"
                  name="whOfficeOpen{{ r.day_of_week }}"
                  (ngModelChange)="onOfficeOpenToggle(r); onWorkingHoursChanged()" />
              </div>

              <!-- שעות משרד (לא תלוי ב־is_open של החווה) -->
              <div class="col-secondary">
                <input type="time" class="wh-time" [(ngModel)]="r.office_start" name="whOfficeStart{{ r.day_of_week }}"
                  [disabled]="!r.is_offical_open" (ngModelChange)="onWorkingHoursTimeChanged()" />
                <span class="sep">–</span>
                <input type="time" class="wh-time" [(ngModel)]="r.office_end" name="whOfficeEnd{{ r.day_of_week }}"
                  [disabled]="!r.is_offical_open" (ngModelChange)="onWorkingHoursTimeChanged()" />

              </div>
            </div>
          </div>

          <ng-template #noWorkingHours>
            <div class="empty-state">
              לא נמצאו שעות לפי יום. ודאי שקיימת טבלה farm_working_hours (או הריצי seed).
              <button type="button" class="text-btn" (click)="loadWorkingHours()">רענון</button>
            </div>
          </ng-template>
        </div>
      </section>
      <!-- ימים מיוחדים -->
      <section class="settings-section">
        <div class="subsection-header">
          <h2>ימים מיוחדים</h2>

          <button type="button" class="icon-btn" (click)="openSpecialDays()">
            <span class="plus-icon">+</span>
            <span>הוספה</span>
          </button>
        </div>

        <div class="special-days-list" *ngIf="daysOff().length; else noDaysOff">
          <div class="special-days-row" *ngFor="let d of daysOff()">
            <div class="special-days-main">
              <div class="special-days-dates">
                {{ d.start_date | date:'dd/MM/yyyy' }} -
                {{ d.end_date | date:'dd/MM/yyyy' }}

                <span class="meta-chip">
                  {{ d.recurrence === 'YEARLY' ? 'שנתי' : 'חד פעמי' }}
                </span>

                <span class="meta-chip">
                  {{
                  d.all_day
                  ? 'כל היום'
                  : ('החווה עובדת: ' + d.start_time + ' - ' + d.end_time)
                  }}
                </span>

                <span class="meta-chip" *ngIf="d.notify_parents_before">
                  הודעה להורים: {{ d.notify_days_before ?? 1 }} ימים לפני
                </span>
              </div>

              <div class="special-days-reason">{{ d.reason }}</div>
            </div>

            <button type="button" class="text-btn danger" (click)="deactivateDayOff(d)">ביטול</button>
          </div>
        </div>

        <ng-template #noDaysOff>
          <div class="empty-state">עדיין אין ימים מיוחדים.</div>
        </ng-template>
      </section>

      <!-- שיעורים -->
      <section class="settings-section">
        <h2>הגדרות שיעורים</h2>

        <div class="fields-grid three-cols">
          <!-- מס' שיעורים בסדרה + ללא הגבלה -->
          <div class="field">
            <div class="row-between">
              <span class="field-label">מס' שיעורים בסדרה (ברירת מחדל)</span>

              <label class="mini-toggle">
                <input type="checkbox" [checked]="isUnlimitedDefaultLessonsPerSeries()"
                  (change)="setUnlimitedDefaultLessonsPerSeries($any($event.target).checked)" />
                <span>ללא הגבלה</span>
              </label>
            </div>

            <input type="number" min="1" [(ngModel)]="s.default_lessons_per_series" name="default_lessons_per_series"
              [disabled]="isUnlimitedDefaultLessonsPerSeries()"
              [placeholder]="isUnlimitedDefaultLessonsPerSeries() ? 'ללא הגבלה' : ''" />
          </div>

          <label class="field">
            <span class="field-label">אורך שיעור (דקות)</span>
            <input type="number" min="10" [(ngModel)]="s.lesson_duration_minutes" name="lesson_duration_minutes" />
          </label>

          <label class="field">
            <span class="field-label">מחיר שיעור רגיל (₪)</span>
            <input type="number" min="0" step="0.5" [(ngModel)]="s.default_lesson_price" name="default_lesson_price" />
          </label>
        </div>

        <div class="fields-grid three-cols">
          <label class="field">
            <span class="field-label">מקס' רוכבים בשיעור קבוצתי</span>
            <input type="number" min="1" [(ngModel)]="s.max_group_size" name="max_group_size" />
          </label>

          <!-- מקס שיעורים בשבוע + ללא הגבלה -->
          <div class="field">
            <div class="row-between">
              <span class="field-label">מקס' שיעורים בשבוע לילד</span>

              <label class="mini-toggle">
                <input type="checkbox" [checked]="isUnlimitedLessonsPerWeek()"
                  (change)="setUnlimitedLessonsPerWeek($any($event.target).checked)" />
                <span>ללא הגבלה</span>
              </label>
            </div>

            <input type="number" min="1" [(ngModel)]="s.max_lessons_per_week_per_child"
              name="max_lessons_per_week_per_child" [disabled]="isUnlimitedLessonsPerWeek()"
              [placeholder]="isUnlimitedLessonsPerWeek() ? 'ללא הגבלה' : ''" />
          </div>

          <label class="field toggle">
            <span class="field-label">אפשר זימון שיעורים ע&quot;י הורים</span>
            <input type="checkbox" [(ngModel)]="s.allow_online_booking" name="allow_online_booking" />
          </label>
        </div><label class="field compact">
  <span class="field-label">
    כמה ימים קדימה הורים יכולים לקבוע שיעור
  </span>

  <input
    type="number"
    min="0"
    [(ngModel)]="s.parent_booking_days_ahead"
    name="parent_booking_days_ahead"
    [disabled]="!s.allow_online_booking"
    placeholder="0 = ללא הגבלה"
    class="small-number"
  />

  <small class="field-hint">
    מגביל עד כמה ימים קדימה הורה יכול לקבוע שיעור בעצמו.
  </small>
</label>

      </section>

      <!-- ביטולים / השלמות / נוכחות -->
      <section class="settings-section">
        <h2>ביטולים / השלמות / נוכחות</h2>

        <div class="fields-grid three-cols">
          <label class="field">
            <span class="field-label">ימי אחורה להשלמות</span>
            <input type="number" min="0" [(ngModel)]="s.makeup_allowed_days_back" name="makeup_allowed_days_back" />
          </label>

          <label class="field">
            <span class="field-label">ימי השלמה קדימה</span>
            <input type="number" min="0" [(ngModel)]="s.makeup_allowed_days_ahead" name="makeup_allowed_days_ahead" />
          </label>

          <label class="field">
            <span class="field-label">מקס' השלמות בתקופה</span>
            <input type="number" min="0" [(ngModel)]="s.max_makeups_in_period" name="max_makeups_in_period" />
          </label>
        </div>

        <div class="fields-grid three-cols">
          <label class="field">
            <span class="field-label">גודל תקופה (ימים)</span>
            <input type="number" min="1" [(ngModel)]="s.makeups_period_days" name="makeups_period_days" />
          </label>

          <label class="field">
            <span class="field-label">מס' שיעורי השלמה להצגה</span>
            <input type="number" min="1" [(ngModel)]="s.displayed_makeup_lessons_count"
              name="displayed_makeup_lessons_count" />
          </label>

          <label class="field">
            <span class="field-label">הפרש מינימלי בין ביטולים (שעות:דקות)</span>
            <input type="time" [(ngModel)]="s.min_time_between_cancellations" name="min_time_between_cancellations" />
          </label>
        </div>

        <div class="fields-grid three-cols">
          <label class="field">
            <span class="field-label">ביטול עד (שעות לפני)</span>
            <input type="number" min="0" [(ngModel)]="s.cancel_before_hours" name="cancel_before_hours" />
          </label>

          <label class="field">
            <span class="field-label">מדיניות ביטול מאוחר</span>
            <select [(ngModel)]="s.late_cancel_policy" name="late_cancel_policy">
              <option [ngValue]="'CHARGE_FULL'">חיוב מלא</option>
              <option [ngValue]="'CHARGE_PARTIAL'">חיוב חלקי</option>
              <option [ngValue]="'NO_CHARGE'">ללא חיוב</option>
              <option [ngValue]="'NO_MAKEUP'">אין השלמה</option>
            </select>
          </label>

          <label class="field">
            <span class="field-label">ברירת מחדל לנוכחות</span>
            <select [(ngModel)]="s.attendance_default" name="attendance_default">
              <option [ngValue]="'ASSUME_ATTENDED'">נחשב “הגיע” אם לא סומן</option>
              <option [ngValue]="'ASSUME_ABSENT'">נחשב “לא הגיע” אם לא סומן</option>
              <option [ngValue]="'REQUIRE_MARKING'">חובה סימון</option>
            </select>
          </label>
        </div>

        <div class="fields-grid three-cols">
          <label class="field">
            <span class="field-label">קנס ביטול מאוחר (₪)</span>
            <input type="number" min="0" step="0.5" [(ngModel)]="s.late_cancel_fee_amount"
              name="late_cancel_fee_amount" />
          </label>

          <label class="field">
            <span class="field-label">קנס ביטול מאוחר (%)</span>
            <input type="number" min="0" max="100" step="0.5" [(ngModel)]="s.late_cancel_fee_percent"
              name="late_cancel_fee_percent" />
          </label>
        </div>
      </section>

      <!-- תזכורות והתראות -->
      <section class="settings-section">
        <h2>תזכורות והתראות</h2>

        <div class="fields-grid three-cols">
          <label class="field toggle">
            <span class="field-label">שליחת תזכורת לשיעור</span>
            <input type="checkbox" [(ngModel)]="s.send_lesson_reminder" name="send_lesson_reminder" />
          </label>

          <label class="field">
            <span class="field-label">כמה שעות לפני</span>
            <input type="number" min="0" [(ngModel)]="s.reminder_hours_before" name="reminder_hours_before"
              [disabled]="!s.send_lesson_reminder" />
          </label>

          <label class="field">
            <span class="field-label">ערוץ תזכורת</span>
            <select [(ngModel)]="s.reminder_channel" name="reminder_channel" [disabled]="!s.send_lesson_reminder">
              <option [ngValue]="null">ללא</option>
              <option [ngValue]="'APP'">אפליקציה</option>
              <option [ngValue]="'EMAIL'">אימייל</option>
              <option [ngValue]="'SMS'">SMS</option>
              <option [ngValue]="'WHATSAPP'">וואטסאפ</option>
            </select>
          </label>
        </div>

        <div class="fields-grid two-cols">
          <label class="field">
            <span class="field-label">שעת שקט – התחלה</span>
            <input type="time" [(ngModel)]="s.quiet_hours_start" name="quiet_hours_start" />
          </label>

          <label class="field">
            <span class="field-label">שעת שקט – סיום</span>
            <input type="time" [(ngModel)]="s.quiet_hours_end" name="quiet_hours_end" />
          </label>
        </div>
      </section>

      <!-- התראות מערכת -->
      <section class="settings-section">
        <h2>התראות מערכת</h2>

        <div class="fields-grid three-cols">
          <label class="field toggle">
            <span class="field-label">להציע שיעור השלמה כשיש ביטול</span>
            <input type="checkbox" [(ngModel)]="s.suggest_makeup_on_cancel" name="suggest_makeup_on_cancel" />
          </label>

          <label class="field toggle">
            <span class="field-label">תזכורת עם אישור הגעה</span>
            <input type="checkbox" [(ngModel)]="s.reminder_require_confirmation" name="reminder_require_confirmation"
              [disabled]="!s.send_lesson_reminder" />
          </label>

          <label class="field toggle">
            <span class="field-label">לאפשר ביטול מתוך תזכורת</span>
            <input type="checkbox" [(ngModel)]="s.reminder_allow_cancel_link" name="reminder_allow_cancel_link"
              [disabled]="!s.send_lesson_reminder" />
          </label>
        </div>

        <div class="fields-grid three-cols" style="margin-top:10px;">
          <label class="field toggle">
            <span class="field-label">לשלוח הודעה להורים לפני חופש חווה</span>
            <input type="checkbox" [(ngModel)]="s.notify_before_farm_closure" name="notify_before_farm_closure" />
          </label>

          <label class="field">
            <span class="field-label">כמה שעות לפני</span>
            <input type="number" min="1" step="1" [(ngModel)]="s.notify_before_farm_closure_hours"
              name="notify_before_farm_closure_hours" [disabled]="!s.notify_before_farm_closure" />
          </label>
        </div>
      </section>

      <!-- חיובים / הנחות / קנסות -->
      <section class="settings-section">
        <h2>חיובים / הנחות / קנסות</h2>

        <div class="fields-grid three-cols">
          <label class="field">
            <span class="field-label">יום חיוב חודשי (1–28)</span>
            <input type="number" min="1" max="28" [(ngModel)]="s.monthly_billing_day" name="monthly_billing_day" />
          </label>

          <label class="field toggle">
            <span class="field-label">אפשר הנחות</span>
            <input type="checkbox" [(ngModel)]="s.enable_discounts" name="enable_discounts" />
          </label>
        </div>

        <div class="fields-grid three-cols">
          <label class="field">
            <span class="field-label">קנס פיגור (₪)</span>
            <input type="number" min="0" step="0.5" [(ngModel)]="s.late_payment_fee" name="late_payment_fee" />
          </label>

          <label class="field">
            <span class="field-label">אחרי כמה ימים נחשב פיגור</span>
            <input type="number" min="0" step="1" [(ngModel)]="s.late_payment_grace_days"
              name="late_payment_grace_days" />
            <small class="field-hint">0 = פיגור מיידי, 7 = שבוע חסד.</small>
          </label>

          <label class="field">
            <span class="field-label">ריבית חודשית (%)</span>
            <input type="number" min="0" max="100" step="0.1" [(ngModel)]="s.interest_percent_monthly"
              name="interest_percent_monthly" />
          </label>
        </div>
      </section>

      <!-- תשלומים ודמי רישום -->
      <section class="settings-section">
        <h2>תשלומים ודמי רישום</h2>

        <div class="fields-grid three-cols">
          <label class="field">
            <span class="field-label">דמי רישום (₪)</span>
            <input type="number" min="0" step="0.5" [(ngModel)]="s.registration_fee" name="registration_fee" />
          </label>

          <label class="field">
            <span class="field-label">ביטוח תלמידים (₪ לשנה)</span>
            <input type="number" min="0" step="0.5" [(ngModel)]="s.student_insurance_premiums"
              name="student_insurance_premiums" />
          </label>

          <div class="field readonly" *ngIf="s.updated_at">
            <span class="field-label">עודכן לאחרונה</span>
            <span class="readonly-value">{{ s.updated_at | date:'dd.MM.yyyy HH:mm' }}</span>
          </div>
        </div>
      </section>

      <div class="actions">
        <button type="submit" class="primary-btn" [disabled]="saving() || loading()">שמירת הגדרות</button>
      </div>
    </form>

    <!-- =================== מסלולי תשלום =================== -->
    <div class="settings-form">
      <section class="settings-section">
        <div class="subsection-header accordion section-acc">
          <button type="button" class="accordion-toggle" (click)="togglePaymentPlansExpanded()"
            [attr.aria-expanded]="paymentPlansExpanded()">
            <span class="chev" [class.open]="paymentPlansExpanded()">▾</span>
            <span class="accordion-title">מסלולי תשלום</span>
          </button>

          <button type="button" class="icon-btn" (click)="toggleNewPlanForm()" [disabled]="!paymentPlansExpanded()">
            <span class="plus-icon">+</span>
            <span>הוספת מסלול חדש</span>
          </button>
        </div>

        <ng-container *ngIf="paymentPlansExpanded()">
          <div class="inline-panel" *ngIf="showNewPlanForm()">
            <div class="fields-grid three-cols">
              <div class="field">
                <label class="field-label">שם המסלול</label>
                <input type="text" name="newPlanName" [(ngModel)]="newPlan.name" />
              </div>

              <div class="field">
                <label class="field-label">מחיר לשיעור (₪)</label>
                <input type="number" name="newPlanLessonPrice" [(ngModel)]="newPlan.lesson_price" />
              </div>

              <div class="field">
                <label class="field-label">סבסוד (₪)</label>
                <input type="number" name="newPlanSubsidy" [(ngModel)]="newPlan.subsidy_amount" />
              </div>

              <div class="field">
                <label class="field-label">גורם מימון</label>
                <select name="newPlanFunding" [(ngModel)]="newPlan.funding_source_id">
                  <option [ngValue]="null">ללא</option>
                  <option *ngFor="let fs of fundingSources()" [ngValue]="fs.id" [disabled]="!fs.is_active">
                    {{ fs.name }}<ng-container *ngIf="!fs.is_active"> (לא פעיל)</ng-container>
                  </option>
                </select>
              </div>

              <div class="field">
                <label class="field-label">דרישת מסמכים</label>
                <textarea rows="3" name="newPlanDocs" [ngModel]="getDocsText(newPlan)"
                  (ngModelChange)="onNewPlanDocsChange($event)"></textarea>
                <small class="field-hint">כל שורה = סוג קובץ</small>
              </div>

              <div class="field toggle">
                <span class="field-label">חובה מסמכים בזמן קביעת סדרה</span>
                <input type="checkbox" name="newPlanRequireDocs" [(ngModel)]="newPlan.require_docs_at_booking" />
              </div>
            </div>

            <div class="panel-actions">
              <button type="button" class="primary-btn" (click)="addPaymentPlan()">שמירת מסלול חדש</button>
              <button type="button" class="ghost-btn" (click)="toggleNewPlanForm()">ביטול</button>
            </div>
          </div>

          <div class="list-block" *ngIf="paymentPlans().length; else noPlans">
            <div class="list-header-row">
              <span class="col-main">מסלול</span>
              <span class="col-secondary">מחירים</span>
              <span class="col-secondary">לקוח משלם</span>
              <span class="col-secondary">גורם מימון</span>
              <span class="col-secondary">מסמכים</span>
              <span class="col-actions">פעולות</span>
            </div>

            <div class="list-row" *ngFor="let p of paymentPlans()" [class.inactive]="p.is_active === false">
              <div class="col-main">
                <div class="list-title">{{ p.name }}</div>
                <div class="list-sub" *ngIf="p.is_active === false">
                  <span class="status-tag danger">לא פעיל</span>
                </div>
              </div>

              <div class="col-secondary prices-col">
                <div class="price-grid">
                  <span class="meta-chip">
                    מחיר שיעור: {{ (p.lesson_price || 0) | number:'1.0-0' }} ₪
                  </span>

                  <span class="meta-chip" *ngIf="(p.subsidy_amount || 0) > 0; else noSubsidy">
                    סבסוד: {{ p.subsidy_amount | number:'1.0-0' }} ₪
                  </span>
                  <ng-template #noSubsidy>
                    <span class="meta-chip muted">סבסוד: 0 ₪</span>
                  </ng-template>
                </div>
                <div class="col-secondary funding-col">
                  <span class="meta-chip highlight">
                    לקוח משלם: {{ getCustomerAmount(p) | number:'1.0-0' }} ₪
                  </span>
                </div>
              </div>

              <div class="col-secondary funding-col">
                <span class="meta-chip">{{ getFundingName(p.funding_source_id || null) }}</span>
              </div>

              <div class="col-secondary">
                <span class="meta-chip" *ngIf="p.required_docs?.length; else noDocs">
                  {{ p.required_docs.length }} סוגי מסמכים
                </span>
                <ng-template #noDocs>
                  <span class="meta-chip muted">אין מסמכים נדרשים</span>
                </ng-template>
              </div>

              <div class="col-actions">
                <button type="button" class="text-btn" (click)="startEditPlan(p)">עריכה</button>
                <button type="button" class="text-btn danger" (click)="deletePaymentPlan(p)">מחיקה</button>
              </div>
            </div>

            <ng-container *ngFor="let p of paymentPlans()">
              <div class="inline-panel" *ngIf="editingPlanId() === p.id">
                <div class="panel-title">עריכת מסלול – {{ p.name }}</div>

                <div class="fields-grid three-cols">
                  <div class="field">
                    <label class="field-label">שם המסלול</label>
                    <input type="text" name="editPlanName_{{p.id}}" [(ngModel)]="p.name" />
                  </div>

                  <div class="field">
                    <label class="field-label">מחיר נוכחי לשיעור (₪)</label>
                    <input type="number" name="editPlanLessonPrice_{{p.id}}" [(ngModel)]="p.lesson_price" />
                  </div>

                  <div class="field">
                    <label class="field-label">סבסוד נוכחי (₪)</label>
                    <input type="number" name="editPlanSubsidy_{{p.id}}" [(ngModel)]="p.subsidy_amount" />
                  </div>

                  <div class="field">
                    <label class="field-label">גורם מימון</label>
                    <select name="editPlanFunding_{{p.id}}" [(ngModel)]="p.funding_source_id">
                      <option [ngValue]="null">ללא</option>
                      <option *ngFor="let fs of fundingSources()" [ngValue]="fs.id" [disabled]="!fs.is_active">
                        {{ fs.name }}<ng-container *ngIf="!fs.is_active"> (לא פעיל)</ng-container>
                      </option>
                    </select>
                  </div>

                  <div class="field">
                    <label class="field-label">מסמכים נדרשים</label>
                    <textarea rows="3" name="editPlanDocs_{{p.id}}" [ngModel]="getDocsText(p)"
                      (ngModelChange)="onDocsTextChange(p, $event)"></textarea>
                    <small class="field-hint">כל שורה = סוג קובץ נדרש</small>
                  </div>

                  <div class="field toggle">
                    <span class="field-label">חובה מסמכים בזמן קביעת סדרה</span>
                    <input type="checkbox" name="editPlanRequireDocs_{{p.id}}"
                      [(ngModel)]="p.require_docs_at_booking" />
                  </div>

                  <div class="field toggle">
                    <span class="field-label">מסלול פעיל</span>
                    <input type="checkbox" name="editPlanIsActive_{{p.id}}" [(ngModel)]="p.is_active" />
                  </div>
                </div>

                <div class="fields-grid three-cols">
                  <div class="field">
                    <label class="field-label">תאריך תחולה לשינוי מחיר</label>
                    <input type="date" name="planVersionDate_{{p.id}}" [(ngModel)]="p.newVersionDate" />
                    <small class="field-hint">השינוי יחול על שיעורים מתאריך זה והלאה.</small>
                  </div>

                  <div class="field">
                    <label class="field-label">מחיר חדש לשיעור (₪)</label>
                    <input type="number" name="planVersionPrice_{{p.id}}" [(ngModel)]="p.newVersionPrice" />
                  </div>

                  <div class="field">
                    <label class="field-label">סבסוד חדש (₪)</label>
                    <input type="number" name="planVersionSubsidy_{{p.id}}" [(ngModel)]="p.newVersionSubsidy" />
                  </div>
                </div>

                <div class="history-block" *ngIf="p.versions?.length">
                  <div class="history-title">היסטוריית מחירים</div>

                  <div class="history-row" *ngFor="let v of p.versions">
                    <span class="history-date">מ־{{ v.valid_from | date:'dd/MM/yyyy' }}:</span>
                    <span class="history-chip">מחיר: {{ v.lesson_price | number:'1.0-0' }} ₪</span>
                    <span class="history-chip" *ngIf="(v.subsidy_amount || 0) > 0">
                      סבסוד: {{ v.subsidy_amount | number:'1.0-0' }} ₪
                    </span>
                    <span class="history-chip highlight">
                      לקוח משלם: {{ v.customer_amount | number:'1.0-0' }} ₪
                    </span>
                  </div>
                </div>

                <div class="panel-actions">
                  <button type="button" class="primary-btn" (click)="savePlanPriceVersion(p)">
                    שמירת שינוי מחיר עם היסטוריה
                  </button>
                  <button type="button" class="ghost-btn" (click)="updatePaymentPlan(p)">
                    שמירת שינויים כלליים במסלול
                  </button>
                  <button type="button" class="ghost-btn" (click)="cancelEditPlan()">
                    ביטול
                  </button>
                </div>
              </div>
            </ng-container>
          </div>

          <ng-template #noPlans>
            <div class="empty-state">
              עדיין אין מסלולי תשלום מוגדרים.
              <button type="button" class="text-btn" (click)="toggleNewPlanForm()">הוספת מסלול ראשון</button>
            </div>
          </ng-template>
        </ng-container>
      </section>

      <!-- =================== גורמי מימון =================== -->
      <section class="settings-section">
        <div class="subsection-header accordion section-acc">
          <button type="button" class="accordion-toggle" (click)="toggleFundingSourcesExpanded()"
            [attr.aria-expanded]="fundingSourcesExpanded()">
            <span class="chev" [class.open]="fundingSourcesExpanded()">▾</span>
            <span class="accordion-title">גורמי מימון</span>
          </button>

          <button type="button" class="icon-btn" (click)="toggleNewFundingForm()"
            [disabled]="!fundingSourcesExpanded()">
            <span class="plus-icon">+</span>
            <span>הוספת גורם מימון</span>
          </button>
        </div>

        <ng-container *ngIf="fundingSourcesExpanded()">
          <div class="inline-panel" *ngIf="showNewFundingForm()">
            <div class="fields-grid two-cols">
              <div class="field">
                <label class="field-label">שם גורם המימון</label>
                <input type="text" name="newFundingName" [ngModel]="newFundingSourceName()"
                  (ngModelChange)="newFundingSourceName.set($event)" />
              </div>
            </div>

            <div class="panel-actions">
              <button type="button" class="primary-btn" (click)="addFundingSource()">שמירת גורם מימון</button>
              <button type="button" class="ghost-btn" (click)="toggleNewFundingForm()">ביטול</button>
            </div>
          </div>

          <div class="list-block" *ngIf="fundingSources().length; else noFunding">
            <div class="list-header-row">
              <span class="col-main">שם גורם מימון</span>
              <span class="col-secondary">סוג</span>
              <span class="col-secondary">סטטוס</span>
              <span class="col-actions">פעולות</span>
            </div>

            <div class="list-row" *ngFor="let fs of fundingSources()" [class.inactive]="!fs.is_active">
              <div class="col-main">
                <div class="list-title">{{ fs.name }}</div>
              </div>

              <div class="col-secondary">
                <span class="status-tag" [class.info]="fs.is_system" [class.neutral]="!fs.is_system">
                  {{ fs.is_system ? 'גורם מערכת' : 'מותאם לחווה' }}
                </span>
              </div>

              <div class="col-secondary">
                <span class="status-tag" [class.success]="fs.is_active" [class.danger]="!fs.is_active">
                  {{ fs.is_active ? 'פעיל' : 'לא פעיל' }}
                </span>
              </div>

              <div class="col-actions" *ngIf="!fs.is_system">
                <button type="button" class="text-btn" (click)="startEditFunding(fs)">עריכה</button>
                <button type="button" class="text-btn danger" (click)="deleteFundingSource(fs)">מחיקה</button>
              </div>

              <div class="col-actions" *ngIf="fs.is_system">
                <span class="meta-chip muted">לא ניתן לעריכה</span>
              </div>
            </div>

            <ng-container *ngFor="let fs of fundingSources()">
              <div class="inline-panel" *ngIf="editingFundingId() === fs.id">
                <div class="panel-title">עריכת גורם מימון – {{ fs.name }}</div>

                <div class="fields-grid two-cols">
                  <div class="field">
                    <label class="field-label">שם גורם מימון</label>
                    <input type="text" name="editFundingName_{{fs.id}}" [(ngModel)]="fs.name" />
                  </div>

                  <div class="field toggle">
                    <span class="field-label">פעיל</span>
                    <input type="checkbox" name="editFundingIsActive_{{fs.id}}" [(ngModel)]="fs.is_active" />
                  </div>
                </div>

                <div class="panel-actions">
                  <button type="button" class="primary-btn" (click)="updateFundingSource(fs)">שמירת שינויים</button>
                  <button type="button" class="ghost-btn" (click)="cancelEditFunding()">ביטול</button>
                </div>
              </div>
            </ng-container>
          </div>

          <ng-template #noFunding>
            <div class="empty-state">
              עדיין לא הוגדרו גורמי מימון.
              <button type="button" class="text-btn" (click)="toggleNewFundingForm()">הוספת גורם ראשון</button>
            </div>
          </ng-template>
        </ng-container>
      </section>
      <!-- הערות מובנות -->
      <section class="settings-section">
        <div class="subsection-header accordion">
          <button type="button" class="accordion-toggle" (click)="toggleListNotesExpanded()"
            [attr.aria-expanded]="listNotesExpanded()">
            <span class="chev" [class.open]="listNotesExpanded()">❯</span>
            <span class="accordion-title">הערות מובנות</span>
          </button>

          <button type="button" class="icon-btn" (click)="toggleNewListNoteForm()" [disabled]="!listNotesExpanded()">
            <span class="plus-icon">+</span>
            <span>הוספת הודעה</span>
          </button>
        </div>

        <ng-container *ngIf="listNotesExpanded()">
          <!-- טופס הוספה -->
          <div class="inline-panel" *ngIf="showNewListNoteForm()">
            <div class="panel-title">הוספת הודעה חדשה</div>

            <label class="field">
              <span class="field-label">תוכן ההודעה</span>
              <input type="text" [ngModel]="newListNoteText()" (ngModelChange)="newListNoteText.set($event)"
                name="new_list_note" placeholder="לדוגמה: התקדמת יפה" maxlength="250" />
              <small class="field-hint">עד 250 תווים</small>
            </label>

            <div class="panel-actions">
              <button type="button" class="primary-btn" (click)="addListNote()">שמירה</button>
              <button type="button" class="ghost-btn" (click)="toggleNewListNoteForm()">ביטול</button>
            </div>
          </div>

          <!-- רשימה -->
          <div class="list-block" *ngIf="listNotes().length; else noListNotes">
            <div class="list-header-row notes-header">
              <span class="col-main">הודעה</span>
            </div>

            <div class="list-row notes-row" *ngFor="let n of listNotes()">
              <ng-container *ngIf="editingListNoteId() !== n.id; else editNoteRow">
                <div class="col-main">
                  <div class="list-title">{{ n.note }}</div>
                </div>

                <div class="col-actions">
                  <button type="button" class="text-btn" (click)="startEditListNote(n)">עריכה</button>
                  <button type="button" class="text-btn danger" (click)="deleteListNote(n)">מחיקה</button>
                </div>
              </ng-container>

              <ng-template #editNoteRow>
                <div class="col-main">
                  <input class="note-edit-input" type="text" [(ngModel)]="n.note" name="edit_note_{{n.id}}"
                    maxlength="250" />
                </div>

                <div class="col-actions">
                  <button type="button" class="text-btn" (click)="updateListNote(n)">שמירה</button>
                  <button type="button" class="text-btn" (click)="cancelEditListNote()">ביטול</button>
                </div>
              </ng-template>
            </div>
          </div>

          <ng-template #noListNotes>
            <div class="empty-state">
              עדיין אין הודעות מובנות.
              <button type="button" class="text-btn" (click)="toggleNewListNoteForm()">הוספת הודעה ראשונה</button>
            </div>
          </ng-template>
        </ng-container>
      </section>
    </div>

    <!-- =================== מודאל ימים מיוחדים (לועזי בלבד) =================== -->
    <div class="modal-backdrop" *ngIf="showSpecialDaysModal()" (click)="closeSpecialDaysModal()">
      <div class="modal-card" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <div class="modal-title">יום מיוחד</div>
          <button type="button" class="x-btn" (click)="closeSpecialDaysModal()">✕</button>
        </div>

        <div class="fields-grid two-cols">
          <label class="field">
            <span class="field-label">סוג תאריך</span>
            <select [ngModel]="specialDayForm().calendar_kind" (ngModelChange)="setCalendarKind($event)">
              <option [ngValue]="'GREGORIAN'">לועזי</option>
              <option [ngValue]="'HEBREW'">עברי</option>
            </select>
          </label>

          <label class="field">
            <span class="field-label">חזרתיות</span>
            <select [ngModel]="specialDayForm().recurrence"
              (ngModelChange)="patchSpecialDayForm({ recurrence: $event })">
              <option [ngValue]="'ONCE'">חד פעמי</option>
              <option [ngValue]="'YEARLY'">שנתי</option>
            </select>
          </label>
        </div>

        <label class="field toggle">
          <span class="field-label">כל היום</span>
          <input type="checkbox" [ngModel]="specialDayForm().all_day"
            (ngModelChange)="patchSpecialDayForm({ all_day: $event })" />
        </label>

        <div class="fields-grid two-cols" *ngIf="specialDayForm().calendar_kind !== 'HEBREW'">
          <label class="field">
            <span class="field-label">מתאריך</span>
            <input type="date" [ngModel]="specialDayForm().start_date"
              (ngModelChange)="patchSpecialDayForm({ start_date: $event })" />
          </label>

          <label class="field">
            <span class="field-label">עד תאריך</span>
            <input type="date" [ngModel]="specialDayForm().end_date"
              (ngModelChange)="patchSpecialDayForm({ end_date: $event })" />
          </label>
        </div>

        <div class="fields-grid two-cols" *ngIf="specialDayForm().calendar_kind === 'HEBREW'">
          <label class="field">
            <span class="field-label">מתאריך (עברי)</span>
            <div class="row-between" style="gap:10px;">
              <select style="flex:1" [ngModel]="specialDayForm().hebrew_month"
                (ngModelChange)="patchSpecialDayForm({ hebrew_month: $event }); syncHebrewToGregorianDates()">
                <option [ngValue]="null">חודש</option>
                <option *ngFor="let m of hebrewMonths" [ngValue]="m.value">{{ m.label }}</option>
              </select>

              <select style="width:110px" [ngModel]="specialDayForm().hebrew_day"
                (ngModelChange)="patchSpecialDayForm({ hebrew_day: $event }); syncHebrewToGregorianDates()">
                <option [ngValue]="null">יום</option>
                <option *ngFor="let d of hebrewDays" [ngValue]="d">{{ d }}</option>
              </select>
            </div>

            <small class="field-hint">לועזי (מחושב): {{ specialDayForm().start_date }}</small>
          </label>

          <label class="field">
            <span class="field-label">עד תאריך (עברי)</span>
            <div class="row-between" style="gap:10px;">
              <select style="flex:1" [ngModel]="specialDayForm().hebrew_end_month"
                (ngModelChange)="patchSpecialDayForm({ hebrew_end_month: $event }); syncHebrewToGregorianDates()">
                <option [ngValue]="null">חודש</option>
                <option *ngFor="let m of hebrewMonths" [ngValue]="m.value">{{ m.label }}</option>
              </select>

              <select style="width:110px" [ngModel]="specialDayForm().hebrew_end_day"
                (ngModelChange)="patchSpecialDayForm({ hebrew_end_day: $event }); syncHebrewToGregorianDates()">
                <option [ngValue]="null">יום</option>
                <option *ngFor="let d of hebrewDays" [ngValue]="d">{{ d }}</option>
              </select>
            </div>

            <small class="field-hint">לועזי (מחושב): {{ specialDayForm().end_date }}</small>
          </label>
        </div>

        <div class="inline-error" *ngIf="dateRangeError()">{{ dateRangeError() }}</div>

        <div class="inline-panel inline-panel-open" *ngIf="!specialDayForm().all_day">
          <div class="panel-title">החווה עובדת</div>

          <div class="fields-grid two-cols">
            <label class="field">
              <span class="field-label">משעה</span>
              <input type="time" [ngModel]="specialDayForm().start_time"
                (ngModelChange)="patchSpecialDayForm({ start_time: $event })" />
            </label>

            <label class="field">
              <span class="field-label">עד שעה</span>
              <input type="time" [ngModel]="specialDayForm().end_time"
                (ngModelChange)="patchSpecialDayForm({ end_time: $event })" />
            </label>
          </div>
        </div>

        <label class="field">
          <span class="field-label">סיבה</span>
          <input type="text" placeholder="לדוגמה: חופשת פסח" [ngModel]="specialDayForm().reason"
            (ngModelChange)="patchSpecialDayForm({ reason: $event })" />
        </label>

        <div class="fields-grid two-cols" style="margin-top:10px;">
          <label class="field toggle">
            <span class="field-label">לשלוח הודעה להורים לפני החופש</span>
            <input type="checkbox" [ngModel]="specialDayForm().notify_parents_before"
              (ngModelChange)="patchSpecialDayForm({ notify_parents_before: $event })" />
          </label>

          <label class="field">
            <span class="field-label">כמה ימים לפני</span>
            <input type="number" min="0" step="1" [ngModel]="specialDayForm().notify_days_before"
              (ngModelChange)="patchSpecialDayForm({ notify_days_before: $event })"
              [disabled]="!specialDayForm().notify_parents_before" />
          </label>
        </div>


        <div class="panel-actions">
          <button type="button" class="primary-btn" (click)="saveSpecialDay()" [disabled]="saving()">
            שמירה
          </button>
          <button type="button" class="ghost-btn" (click)="closeSpecialDaysModal()">
            ביטול
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
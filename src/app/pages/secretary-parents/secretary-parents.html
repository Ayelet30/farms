<div class="parents-header">
  <h2>רשימת הורים</h2>

  <button class="fab" (click)="openAddParentDialog()" title="הוספת הורה">
    +
  </button>
</div>

<!-- עטיפה לשורת החיפוש -->
<div class="search-shell">
  <!-- שורת החיפוש עצמה -->
  <div class="simple-search-bar" (click)="toggleSearchPanelFromBar()">
    <!-- זכוכית מגדלת (ימין) -->
    <span class="search-icon" title="חיפוש" (click)="toggleSearchPanel($event); $event.stopPropagation()">
      <svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" viewBox="0 0 24 24" fill="#6e7462">
        <path
          d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16a6.471 6.471 0 0 0 4.23-1.57l.27.28v.79l5 5L20.49 19l-5-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
      </svg>
    </span>

    <!-- אינפוט חיפוש – Live Search -->
    <input type="text" class="simple-search-input" [(ngModel)]="searchText" placeholder="חיפוש"
      (click)="$event.stopPropagation()" />

    <!-- פילטר (שמאל) -->
    <span class="filter-icon" title="סינון" (click)="toggleSearchPanel($event); $event.stopPropagation()">
      <svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" viewBox="0 0 24 24" fill="#6e7462">
        <path d="M10 18h4v-2h-4v2zm-7-8v2h18v-2H3zm3-6v2h12V4H6z" />
      </svg>
    </span>
  </div>

  <!-- חלונית חיפוש+סינון -->
  <div *ngIf="showSearchPanel" class="search-panel" (click)="$event.stopPropagation()">
    <!-- חלק החיפוש -->
    <div class="panel-section" [class.active]="panelFocus === 'search'">
      <div class="panel-title">חיפוש</div>

      <label class="panel-option">
        <input type="radio" name="searchMode" value="name" [(ngModel)]="searchMode" />
        חיפוש חופשי לפי שם פרטי / משפחה
      </label>

      <label class="panel-option">
        <input type="radio" name="searchMode" value="id" [(ngModel)]="searchMode" />
        חיפוש מדויק לפי תעודת זהות (ת״ז)
      </label>

      <div class="panel-hint">
        ההקלדה בשורת החיפוש למעלה עובדת בזמן אמת לפי האפשרות שנבחרה.
      </div>
    </div>

    <hr />

    <!-- חלק הסינון -->
    <div class="panel-section" [class.active]="panelFocus === 'filter'">
      <div class="panel-title">סינון</div>

      <label class="panel-label">סטטוס הורה</label>
      <select [(ngModel)]="statusFilter">
        <option value="all">כל ההורים</option>
        <option value="active">הורים פעילים</option>
        <option value="inactive">הורים לא פעילים</option>
      </select>

      <label class="panel-label">ילדים</label>
      <select [(ngModel)]="childrenFilter">
        <option value="all">ללא סינון</option>
        <option value="active">עם ילדים פעילים</option>
        <option value="inactive">עם ילדים לא פעילים</option>
      </select>
    </div>

    <button type="button" class="panel-clear" (click)="clearFilters()">
      איפוס חיפוש וסינון
    </button>
  </div>
</div>

<div *ngIf="isLoading" class="loading-state">
  טוען נתונים... ⏳
</div>

<div *ngIf="error" class="error-state">
  שגיאה: {{ error }}
</div>

<div *ngIf="!isLoading && !error && parents.length > 0">
  <table>
    <thead>
      <tr>
        <th>שם פרטי</th>
        <th>שם משפחה</th>
        <th>טלפון</th>
        <th>אימייל</th>
      </tr>
    </thead>
    <tbody>
      <!-- בלחיצה נפתח את מגירת הפרטים -->
      <tr *ngFor="let parent of filteredParents" (click)="openDetails(parent.uid!)" class="clickable-row">
        <td>{{ parent.first_name }}</td>
        <td>{{ parent.last_name }}</td>
        <td>{{ parent.phone }}</td>
        <td>{{ parent.email }}</td>
      </tr>
    </tbody>
  </table>
</div>

<div *ngIf="!isLoading && !error && (parents?.length ?? 0) === 0" class="empty-state">
  לא נמצאו הורים בחוות הנתונים.
</div>

<!-- מגירה עם פרטי ההורה הנבחר -->
<mat-sidenav-container class="drawer-container" dir="rtl" [hasBackdrop]="false" [class.drawer-open]="!!selectedUid">
  <mat-sidenav #drawer mode="side" position="end" class="drawer-pane" [opened]="!!selectedUid">
    <div class="drawer-header">
      <button class="close-btn" (click)="closeDetails()">✕</button>
      <h3>פרטי הורה</h3>

      <button class="primary" *ngIf="!editMode && drawerParent" (click)="enterEditMode()">
        עריכה
      </button>
    </div>


    <div *ngIf="drawerLoading" class="hint">טוען פרטים...</div>

    <ng-container *ngIf="!drawerLoading && drawerParent as parent">

      <!-- מצב תצוגה בלבד -->
      <ng-container *ngIf="!editMode; else editModeTemplate">
        <section class="grid2">
          <div>
            <label>שם פרטי ושם משפחה</label>
            <div class="val">
              {{
              (parent.first_name || parent.last_name)
              ? (parent.first_name || '') + ' ' + (parent.last_name || '')
              : '—'
              }}
            </div>
          </div>

          <div>
            <label>תעודת זהות</label>
            <div class="val">{{ parent.id_number || '—' }}</div>
          </div>

          <div>
            <label>טלפון</label>
            <div class="val">{{ parent.phone || '—' }}</div>
          </div>

          <div>
            <label>אימייל</label>
            <div class="val">{{ parent.email || '—' }}</div>
          </div>

          <div class="colspan">
            <label>כתובת</label>
            <div class="val">{{ parent.address || '—' }}</div>
          </div>

          <div>
            <label>יום חיוב בחודש</label>
            <div class="val">
              {{ parent.billing_day_of_month }}
            </div>
          </div>

          <div class="colspan">
            <label>הערות רפואיות / התנהגותיות</label>
            <div class="val prewrap">{{ parent.extra_notes || '—' }}</div>
          </div>
        </section>

        <hr />

        <!-- העדפות תקשורת – קריאה בלבד -->
        <section class="prefs">
          <h4>העדפות תקשורת</h4>
          <div class="chips">
            <span class="chip" *ngIf="parent.message_preferences?.includes('inapp')">
              אפליקציה
            </span>
            <span class="chip" *ngIf="parent.message_preferences?.includes('voice')">
              הודעה קולית
            </span>
            <span class="chip" *ngIf="parent.message_preferences?.includes('whatsapp')">
              וואטסאפ
            </span>
            <span class="chip" *ngIf="parent.message_preferences?.includes('email')">
              אימייל
            </span>
            <span class="chip" *ngIf="parent.message_preferences?.includes('sms')">
              SMS
            </span>

            <span class="chip muted" *ngIf="!(parent.message_preferences?.length)">
              ברירת מחדל: אפליקציה
            </span>
          </div>
        </section>
      </ng-container>

      <!-- 🌟 מצב עריכה inline -->
      <ng-template #editModeTemplate>
        <form class="grid2" [formGroup]="parentForm" (ngSubmit)="saveParentEdits()">
          <div>
            <label>שם מלא</label>
            <input class="val" formControlName="full_name" readonly />
          </div>

          <div>
            <label>תעודת זהות</label>
            <input class="val" formControlName="id_number" readonly />
          </div>

          <div>
  <label>טלפון *</label>

  <input
    class="val"
    type="tel"
    inputmode="numeric"
    autocomplete="tel"
    formControlName="phone"
    (input)="parentForm.get('phone')?.markAsTouched()"
  />

  <div class="field-error"
       *ngIf="parentForm.get('phone')?.touched && parentForm.get('phone')?.invalid">

    <span *ngIf="parentForm.get('phone')?.errors?.['required']">
      שדה חובה
    </span>

    <span *ngIf="parentForm.get('phone')?.errors?.['phoneDigitsOnly']">
      מותר להזין ספרות בלבד
    </span>

    <span *ngIf="parentForm.get('phone')?.errors?.['ilPhone']">
      מספר טלפון לא תקין בישראל (לדוגמה: 05XXXXXXXX)
    </span>
  </div>
</div>


          <div>
            <label>אימייל</label>
            <input class="val" type="email" formControlName="email" />
          </div>

          <div class="colspan">
            <label>כתובת</label>
            <input class="val" type="text" formControlName="address" />
          </div>

          <div>
            <label>יום חיוב בחודש *</label>
           <select class="val" formControlName="billing_day">
           <option *ngFor="let d of [].constructor(28); let i = index" [value]="i+1">{{ i+1 }}</option>
           </select>

            <div class="hint">מומלץ 1–28 כדי לא להיתקע בחודשים קצרים.</div>
          </div>

          <div class="colspan">
            <label>הערות רפואיות / התנהגותיות</label>
            <textarea class="val" rows="3" formControlName="extra_notes"></textarea>
          </div>

          <div class="colspan">
            <label>העדפות תקשורת (ברירת מחדל In-app)</label>
            <select class="val" multiple formControlName="message_preferences">
              <option *ngFor="let opt of COMM_PREF_OPTIONS" [value]="opt.value">
                {{ opt.label }}
              </option>
            </select>
            <div class="hint">אפשר לבחור כמה ערוצים יחד (Ctrl/Command + קליק).</div>
          </div>



          <!-- כפתורי שמירה / ביטול -->
          <div class="colspan drawer-actions">
            <button type="button" class="secondary-btn" (click)="cancelEdit()">
              ביטול
            </button>
           <button type="submit" class="primary" [disabled]="parentForm.invalid"> שמירה</button>
          </div>
        </form>
      </ng-template>

      <hr />

      <!-- 🧒 רשימת ילדים – קריאה בלבד (גם במצב עריכה) -->
      <section class="children-list" *ngIf="drawerChildren.length > 0">
        <h4>ילדים</h4>
        <ul>
          <li *ngFor="let child of drawerChildren">
            👶 {{ child.first_name }} {{ child.last_name }}
            <span class="muted">
              ({{ child.gender || 'לא צויין' }}, {{ child.status || '—' }})
            </span>
          </li>
        </ul>
      </section>

      <section *ngIf="!drawerLoading && drawerChildren.length === 0">
        <div class="hint">אין ילדים משויכים להורה זה.</div>
      </section>
    </ng-container>

  </mat-sidenav>

  <div></div>
</mat-sidenav-container>
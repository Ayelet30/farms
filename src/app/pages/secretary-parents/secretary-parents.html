<h2>רשימת הורים</h2>

<div *ngIf="isLoading" class="loading-state">
  טוען נתונים... ⏳
</div>

<div *ngIf="error" class="error-state">
  שגיאה: {{ error }}
</div>

<div *ngIf="!isLoading && !error && parents.length > 0">
  <table>
    <thead>
      <tr>
        <th>שם מלא</th>
        <th>טלפון</th>
        <th>אימייל</th>
      </tr>
    </thead>
    <tbody>
      <!-- בלחיצה נפתח את מגירת הפרטים -->
      <tr *ngFor="let parent of parents"
          (click)="openDetails(parent.uid)"
          class="clickable-row">
        <td>{{ parent.full_name }}</td>
        <td>{{ parent.phone }}</td>
        <td>{{ parent.email }}</td>
      </tr>
    </tbody>
  </table>
</div>

<div *ngIf="!isLoading && !error && (parents?.length ?? 0) === 0" class="empty-state">
  לא נמצאו הורים בחוות הנתונים.
</div>

<!-- מגירה עם פרטי ההורה הנבחר -->
<mat-sidenav-container
  class="drawer-container"
  dir="rtl"
  [hasBackdrop]="false"
  [class.drawer-open]="!!selectedUid">

  <mat-sidenav
    #drawer
    mode="side"
    position="end"
    class="drawer-pane"
    [opened]="!!selectedUid">

    <div class="drawer-header">
      <button class="close-btn" (click)="closeDetails()">✕</button>
      <h3>פרטי הורה</h3>
    </div>

    <div *ngIf="drawerLoading" class="hint">טוען פרטים...</div>

    <ng-container *ngIf="!drawerLoading && drawerParent">

      <!-- פרטים אישיים -->
      <section class="grid2">
        <div>
          <label>שם מלא</label>
          <div class="val">{{ drawerParent.full_name || '—' }}</div>
        </div>
        <div>
          <label>תעודת זהות</label>
          <div class="val">{{ drawerParent.id_number || '—' }}</div>
        </div>
        <div>
          <label>טלפון</label>
          <div class="val">{{ drawerParent.phone || '—' }}</div>
        </div>
        <div>
          <label>אימייל</label>
          <div class="val">{{ drawerParent.email || '—' }}</div>
        </div>
        <div class="colspan">
          <label>כתובת</label>
          <div class="val">{{ drawerParent.address || '—' }}</div>
        </div>
        <div class="colspan">
          <label>הערות</label>
          <div class="val prewrap">{{ drawerParent.extra_notes || '—' }}</div>
        </div>
      </section>

      <hr>

      <!-- העדפות תקשורת -->
      <section class="prefs">
        <h4>העדפות תקשורת</h4>
        <div class="chips">
          <span class="chip" *ngIf="drawerParent?.message_preferences?.includes('inapp')">אפליקציה</span>
          <span class="chip" *ngIf="drawerParent?.message_preferences?.includes('email')">אימייל</span>
          <span class="chip" *ngIf="drawerParent?.message_preferences?.includes('sms')">SMS</span>
          <span class="chip" *ngIf="drawerParent?.message_preferences?.includes('whatsapp')">וואטסאפ</span>
          <span class="chip muted" *ngIf="!(drawerParent?.message_preferences?.length)">
            ברירת מחדל: אפליקציה
          </span>
        </div>
      </section>

      <!-- 🧒 רשימת ילדים -->
      <hr>
      <section class="children-list" *ngIf="drawerChildren.length > 0">
        <h4>ילדים</h4>
        <ul>
          <li *ngFor="let child of drawerChildren">
            👶 {{ child.full_name }}
            <span class="muted">
              ({{ child.gender || 'לא צויין' }}, {{ child.status || '—' }})
            </span>
          </li>
        </ul>
      </section>

      <section *ngIf="!drawerLoading && drawerChildren.length === 0">
        <div class="hint">אין ילדים משויכים להורה זה.</div>
      </section>

    </ng-container>
  </mat-sidenav>
  <div></div>
</mat-sidenav-container>

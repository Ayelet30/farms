<!-- Toast -->
<div class="toast" [class.open]="toastOpen()" [class.success]="toastKind()==='success'"
  [class.error]="toastKind()==='error'" [class.info]="toastKind()==='info'">
  <div class="toast-inner">
    <span class="toast-text">{{ toastText() }}</span>
  </div>
</div>

<div class="approvals-wrapper" dir="rtl">
  <mat-sidenav-container class="approvals-shell">

    <mat-sidenav *ngIf="isMobile()" #detailsDrawer class="details-drawer" position="start" mode="over" [opened]="false">

      <div class="drawer-head">
        <button class="icon-btn" type="button" (click)="detailsDrawer.close()">
          <mat-icon>close</mat-icon>
        </button>
        <div class="drawer-title">פרטי בקשה</div>
      </div>

      <div class="drawer-body">
        <div *ngIf="selectedRequest as r; else noSelectionMobile" class="details-card">
          <ng-container *ngIf="getDetailsComponent(r.requestType) as cmp; else fallbackMobile">
            <ng-container *ngComponentOutlet="cmp; inputs: {
                request: r,
                decidedByUid: curentUser?.uid,
                onApproved: onChildApprovedBound,
                onRejected: onChildRejectedBound,
                onError: onChildErrorBound
              }" (ngComponentOutletActivate)="onDetailsActivate($event)">
            </ng-container>
          </ng-container>

          <ng-template #fallbackMobile>
            <pre class="json-pre">{{ r.payload | json }}</pre>
          </ng-template>
        </div>

        <ng-template #noSelectionMobile>
          <div class="details-card empty-card">
            <p>בחר/י בקשה מהרשימה כדי לראות פרטים.</p>
          </div>
        </ng-template>
      </div>
    </mat-sidenav>

    <!-- MAIN -->
    <mat-sidenav-content>

      <div class="approvals-grid">

        <!-- צד רשימה + פילטרים -->
        <div class="appt-wrapper">
          <div class="appt-card">

            <h2 *ngIf="isSecretary; else myRequestsTitle">בקשות לאישור</h2>
            <ng-template #myRequestsTitle>
              <h2>הבקשות שלי</h2>
            </ng-template>

            <!-- טאבים -->
            <div class="appt-tabs">
              <button type="button" class="appt-tab" [class.active]="statusFilter() === 'PENDING'"
                (click)="statusFilter.set('PENDING')">
                ממתינים
              </button>

              <button type="button" class="appt-tab" [class.active]="statusFilter() === 'ALL'"
                (click)="statusFilter.set('ALL')">
                הכל
              </button>

              <button type="button" class="appt-tab" [class.active]="statusFilter() === 'APPROVED'"
                (click)="statusFilter.set('APPROVED')">
                מאושרים
              </button>

              <button type="button" class="appt-tab" [class.active]="statusFilter() === 'REJECTED'"
                (click)="statusFilter.set('REJECTED')">
                נדחו
              </button>

              <button type="button" class="appt-tab" [class.active]="statusFilter() === 'CANCELLED_BY_REQUESTER'"
                (click)="statusFilter.set('CANCELLED_BY_REQUESTER')">
                מבוטלות
              </button>
            </div>

            <!-- פילטרים -->
            <div class="appt-header-row">

              <div class="appt-field-group">
                <span class="appt-field-label">
                  {{ dateFilterMode === 'CREATED_AT' ? 'עד תאריך (יצירה)' : 'עד תאריך (בקשה)' }}
                </span>
                <input class="appt-input" type="date" [(ngModel)]="dateTo" />
              </div>

              <div class="appt-field-group">
                <span class="appt-field-label">
                  {{ dateFilterMode === 'CREATED_AT' ? 'מתאריך (יצירה)' : 'מתאריך (בקשה)' }}
                </span>
                <input class="appt-input" type="date" [(ngModel)]="dateFrom" />
              </div>

              <div class="appt-field-group">
                <span class="appt-field-label">סינון לפי</span>
                <select class="appt-select" [(ngModel)]="dateFilterMode">
                  <option value="CREATED_AT">תאריך יצירת בקשה</option>
                  <option value="REQUEST_WINDOW">תאריך הבקשה (מתאריך/עד תאריך)</option>
                </select>
              </div>

              <div class="appt-field-group search-wide">
                <span class="appt-field-label">חיפוש חופשי</span>
                <input class="appt-input" type="text" [(ngModel)]="searchTerm"
                  placeholder="שם ילד, מדריך או טקסט חופשי..." />
              </div>

              <div class="appt-field-group">
                <span class="appt-field-label">סוג בקשה</span>
                <select class="appt-select" [(ngModel)]="typeFilter">
                  <option value="ALL">כל הסוגים</option>
                  <option value="CANCEL_OCCURRENCE">ביטול שיעור</option>
                  <option value="INSTRUCTOR_DAY_OFF">יום חופש מדריך</option>
                  <option value="NEW_SERIES">סדרת שיעורים</option>
                  <option value="ADD_CHILD">הוספת ילד/ה</option>
                  <option value="DELETE_CHILD">מחיקת ילד/ה</option>
                  <option value="MAKEUP_LESSON">שיעור פיצוי</option>
                  <option value="OTHER_REQUEST">אחר</option>
                </select>
              </div>

              <div class="appt-actions">
                <button type="button" class="appt-cta" (click)="clearFilters()">
                  איפוס
                </button>
              </div>

            </div>

            <!-- רשימה -->
            <div class="requests-list" *ngIf="filteredRequestsList.length; else emptyTpl">
              <div class="details-actions">
                <h4>רשימת בקשות</h4>

                <div class="bulk-actions" *ngIf="isSecretary && selectedCount() > 0">
                  <span class="bulk-count">נבחרו {{ selectedCount() }}</span>

                  <button type="button" class="appt-cta" (click)="bulkApproveSelected()" [disabled]="bulkBusy()">
                    אשרי מסומנים
                  </button>

                  <button type="button" class="appt-cta danger" (click)="bulkRejectSelected()" [disabled]="bulkBusy()">
                    דחי מסומנים
                  </button>

                  <button type="button" class="appt-cta" (click)="clearSelection()" [disabled]="bulkBusy()">
                    נקה בחירה
                  </button>
                </div>

                <button type="button" class="appt-cta" (click)="reloadRequests()" [disabled]="loading()">
                  רענן
                </button>
              </div>


              <!-- דסקטופ: טבלה (קיים רק בדסקטופ) -->
              <div class="table-wrap" *ngIf="!isMobile()">
                <table>
                  <thead>
                    <tr>
                      <th class="col-check" *ngIf="isSecretary">
                        <input type="checkbox" class="row-check" [checked]="isAllSelectableChecked()"
                          [indeterminate]="isSomeSelectableChecked()" (click)="$event.stopPropagation()"
                          (change)="toggleSelectAll($event)" />
                      </th>


                      <th>סוג</th>
                      <th>מבקש/ת</th>
                      <th>פירוט</th>
                      <th>נוצר</th>
                      <th>סטטוס</th>
                    </tr>
                  </thead>


                  <tbody>
                    <tr *ngFor="let row of filteredRequestsList" class="clickable-row" (click)="openDetails(row)">

                      <td class="col-check" *ngIf="isSecretary">
                        <input type="checkbox" class="row-check" [disabled]="!isRowSelectable(row)"
                          [checked]="isSelected(row)" (click)="$event.stopPropagation()"
                          (change)="toggleRowSelection(row, $event)" />
                      </td>

                      <td>
                        <div class="type-cell">
                          <mat-icon class="type-icon">{{ getRequestTypeIcon(row.requestType) }}</mat-icon>
                          <span>{{ getRequestTypeLabel(row.requestType) }}</span>
                        </div>
                      </td>

                      <td>{{ row.requestedByName }}</td>

                      <td>
                        <div class="summary-cell">
                          <div class="summary-text">{{ row.summary }}</div>
                          <div class="summary-meta">
                            <span *ngIf="row.childName">· ילד/ה: {{ row.childName }}</span>
                            <span *ngIf="row.instructorName"> · מדריך/ה: {{ row.instructorName }}</span>
                          </div>
                        </div>
                      </td>

                      <td>
                        <div>{{ row.createdAt | date:'dd/MM/yyyy' }}</div>
                        <div>{{ row.createdAt | date:'HH:mm' }}</div>
                      </td>

                      <td>
                        <span [ngClass]="getStatusClass(row.status)">{{ getStatusLabel(row.status) }}</span>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- מובייל: כרטיסיות (קיים רק במובייל) -->
              <div class="requests-cards" *ngIf="isMobile()">
                <button type="button" class="req-card" *ngFor="let row of filteredRequestsList"
                  (click)="openDetails(row)">

                  <div class="req-top">
                    <div class="req-type">
                      <mat-icon class="type-icon">{{ getRequestTypeIcon(row.requestType) }}</mat-icon>
                      <span class="req-type-text">{{ getRequestTypeLabel(row.requestType) }}</span>
                    </div>

                    <div class="req-right">
                      <input *ngIf="isSecretary" type="checkbox" class="row-check" [disabled]="!isRowSelectable(row)"
                        [checked]="isSelected(row)" (click)="$event.stopPropagation()"
                        (change)="toggleRowSelection(row, $event)" />

                      <span [ngClass]="getStatusClass(row.status)">{{ getStatusLabel(row.status) }}</span>
                    </div>
                  </div>

                  <div class="req-summary">{{ row.summary }}</div>

                  <div class="req-meta">
                    <div class="meta-line">
                      <span class="k">מבקש/ת:</span>
                      <span class="v">{{ row.requestedByName }}</span>
                    </div>

                    <div class="meta-line">
                      <span class="k">נוצר:</span>
                      <span class="v">{{ row.createdAt | date:'dd/MM/yyyy HH:mm' }}</span>
                    </div>

                    <div class="meta-line" *ngIf="row.childName">
                      <span class="k">ילד/ה:</span>
                      <span class="v">{{ row.childName }}</span>
                    </div>

                    <div class="meta-line" *ngIf="row.instructorName">
                      <span class="k">מדריך/ה:</span>
                      <span class="v">{{ row.instructorName }}</span>
                    </div>
                  </div>

                  <div class="req-cta-row">
                    <span class="req-open">פתח/י פרטים</span>
                    <mat-icon>chevron_left</mat-icon>
                  </div>

                </button>
              </div>

            </div>

            <ng-template #emptyTpl>
              <div class="empty-state">אין בקשות מתאימות לסינון הנוכחי.</div>
            </ng-template>

          </div>
        </div>

        <!-- פרטים בדסקטופ: קיים רק בדסקטופ -->
        <div class="approvals-details" *ngIf="!isMobile()">
          <div *ngIf="selectedRequest as r; else noSelectionDesktop" class="details-card">

            <ng-container *ngIf="getDetailsComponent(r.requestType) as cmp; else fallbackDesktop">
              <ng-container *ngComponentOutlet="cmp; inputs: {
                  request: r,
                  decidedByUid: curentUser?.uid,
                  onApproved: onChildApprovedBound,
                  onRejected: onChildRejectedBound,
                  onError: onChildErrorBound
                }" (ngComponentOutletActivate)="onDetailsActivate($event)">
              </ng-container>
            </ng-container>

            <ng-template #fallbackDesktop>
              <pre class="json-pre">{{ r.payload | json }}</pre>
            </ng-template>

          </div>

          <ng-template #noSelectionDesktop>
            <div class="details-card empty-card">
              <p>בחר/י בקשה מהרשימה כדי לראות פרטים.</p>
            </div>
          </ng-template>
        </div>

      </div>

      <!-- host נסתר ליצירת קומפוננטות בבאלק -->
      <ng-template #bulkHost></ng-template>

    </mat-sidenav-content>

  </mat-sidenav-container>
</div>
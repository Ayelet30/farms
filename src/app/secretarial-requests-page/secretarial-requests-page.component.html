<div class="details-actions">
    <button type="button" class="appt-cta" (click)="reloadRequests()" [disabled]="loading()">
        רענן
    </button>
</div>
<div class="approvals-wrapper" dir="rtl">
    <div class="approvals-grid">
        <!-- צד שמאל: כרטיס בקשות (מה שיש לך היום) -->
        <div class="appt-wrapper">
            <div class="appt-card">
                <h2 *ngIf="isSecretary; else myRequestsTitle">
                    בקשות לאישור
                </h2>
                <ng-template #myRequestsTitle>
                    <h2>הבקשות שלי</h2>
                </ng-template>


                <!-- טאבים של סטטוס -->
                <div class="appt-tabs">
                    <!-- ממתינים -->
                    <button type="button" class="appt-tab" [class.active]="statusFilter() === 'PENDING'"
                        (click)="statusFilter.set('PENDING')">
                        ממתינים
                    </button>

                    <!-- הכל – אפשרי גם להורים/מדריכים, פשוט יראו רק את שלהם -->
                    <button type="button" class="appt-tab" [class.active]="statusFilter() === 'ALL'"
                        (click)="statusFilter.set('ALL')">
                        הכל
                    </button>

                    <!-- מאושרים -->
                    <button type="button" class="appt-tab" [class.active]="statusFilter() === 'APPROVED'"
                        (click)="statusFilter.set('APPROVED')">
                        מאושרים
                    </button>

                    <!-- נדחו -->
                    <button type="button" class="appt-tab" [class.active]="statusFilter() === 'REJECTED'"
                        (click)="statusFilter.set('REJECTED')">
                        נדחו
                    </button>

                    <!-- מבוטלות ע"י המבקש/ת -->
                    <button type="button" class="appt-tab" [class.active]="statusFilter() === 'CANCELLED_BY_REQUESTER'"
                        (click)="statusFilter.set('CANCELLED_BY_REQUESTER')">
                        מבוטלות
                    </button>
                </div>


                <!-- פילטרים -->
                <div class="appt-header-row">

                    <div class="appt-field-group">
                        <span class="appt-field-label">
                            {{ dateFilterMode === 'CREATED_AT' ? 'עד תאריך (יצירה)' : 'עד תאריך (בקשה)' }}
                        </span>
                        <input class="appt-input" type="date" [(ngModel)]="dateTo" />
                    </div>

                    <!-- תאריך יעד (משתנה בהתאם למצב) -->
                    <div class="appt-field-group">
                        <span class="appt-field-label">
                            {{ dateFilterMode === 'CREATED_AT' ? 'מתאריך (יצירה)' : 'מתאריך (בקשה)' }}
                        </span>
                        <input class="appt-input" type="date" [(ngModel)]="dateFrom" />
                    </div>

                    <!-- מצב סינון לפי: זמן יצירה / זמן הבקשה -->
                    <div class="appt-field-group">
                        <span class="appt-field-label">סינון לפי</span>
                        <select class="appt-select" [(ngModel)]="dateFilterMode">
                            <option value="CREATED_AT">תאריך יצירת בקשה</option>
                            <option value="REQUEST_WINDOW">תאריך הבקשה (מתאריך/עד תאריך)</option>
                        </select>
                    </div>

                    <!-- חיפוש חופשי -->
                    <div class="appt-field-group" style="flex:1 1 260px; min-width:260px">
                        <span class="appt-field-label">חיפוש חופשי</span>
                        <input class="appt-input" type="text" [(ngModel)]="searchTerm"
                            placeholder="שם ילד, מדריך או טקסט חופשי..." />
                    </div>

                    <!-- סוג בקשה -->
                    <div class="appt-field-group">
                        <span class="appt-field-label">סוג בקשה</span>
                        <select class="appt-select" [(ngModel)]="typeFilter">
                            <option value="ALL">כל הסוגים</option>
                            <option value="CANCEL_OCCURRENCE">ביטול שיעור</option>
                            <option value="INSTRUCTOR_DAY_OFF">יום חופש מדריך</option>
                            <option value="NEW_SERIES">סדרת שיעורים</option>
                            <option value="ADD_CHILD">הוספת ילד/ה</option>
                            <option value="DELETE_CHILD">מחיקת ילד/ה</option>
                            <option value="MAKEUP_LESSON">שיעור פיצוי</option>
                            <option value="OTHER_REQUEST">אחר</option>
                        </select>
                    </div>

                    <!-- כפתור איפוס -->
                    <div class="appt-actions">
                        <button type="button" class="appt-cta" (click)="clearFilters()">
                            איפוס
                        </button>
                    </div>


                    <!-- רשימת בקשות -->
                    <div class="slots-list requests-list" *ngIf="filteredRequestsList.length; else emptyTpl">
                        <h4>רשימת בקשות</h4>

                        <table>
                            <thead>
                                <tr>
                                    <th>סוג</th>
                                    <th>מבקש/ת</th>
                                    <th>פירוט</th>
                                    <th>נוצר</th>
                                    <th>סטטוס</th>
                                    <th></th>
                                </tr>
                            </thead>

                            <tbody>
                                <tr *ngFor="let row of filteredRequestsList" class="clickable-row"
                                    (click)="openDetails(row)">
                                    <!-- סוג -->
                                    <td>
                                        <div class="type-cell">
                                            <mat-icon class="type-icon">
                                                {{ getRequestTypeIcon(row.requestType) }}
                                            </mat-icon>
                                            <span>{{ getRequestTypeLabel(row.requestType) }}</span>
                                        </div>
                                    </td>
                                    <td>{{ row.requestedByName }}</td>

                                    <!-- פירוט -->
                                    <td>
                                        <div class="summary-cell">
                                            <div class="summary-text">
                                                {{ row.summary }}
                                            </div>
                                            <div class="summary-meta">
                                                <span>מבקש/ת: {{ row.requestedByName }}</span>
                                                <span *ngIf="row.childName">
                                                    · ילד/ה: {{ row.childName }}
                                                </span>
                                                <span *ngIf="row.instructorName">
                                                    · מדריך/ה: {{ row.instructorName }}
                                                </span>
                                            </div>
                                        </div>
                                    </td>

                                    <!-- נוצר -->
                                    <td>
                                        {{ row.createdAt | date: 'dd/MM/yyyy HH:mm' }}
                                    </td>

                                    <!-- סטטוס -->
                                    <td>
                                        <span [ngClass]="getStatusClass(row.status)">
                                            {{ getStatusLabel(row.status) }}
                                        </span>
                                    </td>

                                    <!-- כפתור פרטים -->
                                    <td>
                                        <button type="button" class="appt-cta"
                                            (click)="openDetails(row); $event.stopPropagation()">
                                            פרטים
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- מצב ריק -->
                    <ng-template #emptyTpl>
                        <div class="empty-state">
                            אין בקשות מתאימות לסינון הנוכחי.
                        </div>
                    </ng-template>
                </div>
            </div>
        </div>

        <!-- צד ימין: כרטיס פרטים -->
        <div class="approvals-details">
            <div *ngIf="selectedRequest as r; else noSelection" class="details-card">

                <ng-container *ngIf="selectedRequest as r">
                    <ng-container *ngIf="getDetailsComponent(r.requestType) as cmp; else fallback">
                        <ng-container *ngComponentOutlet="cmp; inputs: { request: r, decidedByUid: curentUser?.uid }">
                        </ng-container>
                    </ng-container>

                    <ng-template #fallback>
                        <pre>{{ r.payload | json }}</pre>
                    </ng-template>
                </ng-container>



                <!-- הורה/מדריך: ביטול -->
                <ng-template #requesterActions>
                    <button type="button" class="appt-cta danger" (click)="cancelSelected()"
                        [disabled]="r.status !== 'PENDING'|| loading() ">
                        ביטול בקשה
                    </button>
                </ng-template>
            </div>
        </div>

        <ng-template #noSelection>
            <div class="details-card empty-card">
                <p>בחרי בקשה מהרשימה כדי לראות פרטים.</p>
            </div>
        </ng-template>
    </div>
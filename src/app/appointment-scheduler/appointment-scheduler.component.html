<div class="appt-wrapper" dir="rtl">
  <!-- בחירת ילד + אישורים -->
  <div class="appt-card">
    <h2>זימון תורים</h2>

    <div class="appt-header-row">

      <!-- טור ימין: בחירת ילד -->
      <div class="appt-field-group child-group">
        <span class="appt-field-label">ילד/ה</span>

        <mat-select #childSelect class="appt-select" [(ngModel)]="selectedChildId" (selectionChange)="onChildChange()"
          [disabled]="!children.length" placeholder="בחר/י ילד">
          <!-- שורת חיפוש -->
          <mat-option class="search-option" (click)="$event.stopPropagation()" (mousedown)="$event.stopPropagation()">
            <input matInput type="text" placeholder="חיפוש לפי שם ילד/ה..." [(ngModel)]="childSearchTerm"
              (ngModelChange)="filterChildren()" (keydown.enter)="selectFirstChildFromSearch($event)"
              (click)="$event.stopPropagation()" class="search-input" />
          </mat-option>

          <!-- אופציות -->
          <mat-option *ngFor="let child of filteredChildren" [value]="child.child_uuid">
            {{ child.first_name }} {{ child.last_name }}
          </mat-option>
        </mat-select>

      </div>

      <div class="appt-field-group instructor-group">
        <span class="appt-field-label">מדריך</span>
<div
  class="field-wrap"
  [class.is-disabled]="!selectedChildId"
  (click)="!selectedChildId && showUiHint('instructor', missingInstructorMsg)"
>
        <mat-select #instructorSelect class="appt-select" [ngClass]="{ disabled: !selectedChildId }"
          [(ngModel)]="selectedInstructorId" (selectionChange)="onInstructorChange()" [disabled]="!selectedChildId"
          placeholder="בחר/י מדריך">
          <!-- שורת חיפוש -->
          <mat-option class="search-option" (click)="$event.stopPropagation()" (mousedown)="$event.stopPropagation()">
            <input matInput type="text" placeholder="חיפוש לפי שם מדריך..." [(ngModel)]="instructorSearchTerm"
              (ngModelChange)="filterInstructors()" (keydown.enter)="selectFirstInstructorFromSearch($event)"
              (click)="$event.stopPropagation()" class="search-input" />
          </mat-option>

          <!-- אופציה של "כל המדריכים" -->
          <mat-option value="any">
            כל המדריכים
          </mat-option>

          <!-- אופציות – רשימה מסוננת -->
          <mat-option *ngFor="let ins of filteredInstructors" [value]="ins.instructor_uid">
            {{ ins.full_name }}
          </mat-option>
        </mat-select>
          <small class="hint" *ngIf="uiHint['instructor']">{{ uiHint['instructor'] }}</small>

      </div>


    </div>
  </div>

  <!-- כרטיס מידע על המדריך שנבחר -->
  <div *ngIf="selectedInstructor && !noInstructorPreference && showInstructorDetails" class="instructor-card">
    <!-- כפתור איקס לסגירה -->
    <button type="button" class="instructor-close" (click)="showInstructorDetails = false"
      aria-label="סגירת פרטי מדריך">
      ✕
    </button>

    <div class="instructor-card-header">
      <div class="instructor-name">
        {{ selectedInstructor.full_name }}
      </div>
    </div>

    <div class="instructor-card-body">
      <!-- עמודת מידע טקסטואלי -->
      <div class="instructor-info-col">
        <div class="instructor-line" *ngIf="selectedInstructor.gender">
          <span class="label">מין:</span>
          <span class="value">{{ selectedInstructor.gender }}</span>
        </div>
      </div>

      <div class="instructor-about" *ngIf="selectedInstructor.about">
        <span class="label">אודות:</span>
        <p class="about-text">
          {{ selectedInstructor.about }}
        </p>
      </div>

      <!-- עמודת תעודה -->

      <div class="instructor-cert-col" *ngIf="selectedInstructor.certificate">
        <div class="label">תעודה:</div>

        <a [href]="selectedInstructor.certificate" target="_blank" rel="noopener noreferrer">
          <img [src]="selectedInstructor.certificate" alt="תעודת מדריך" class="certificate-thumb" />
        </a>
      </div>
    </div>

  </div>

 <div class="appt-tabs">

  <!-- Series -->
  <div class="tab-wrap" (click)="onTabClick('series')">
    <button
      type="button"
      class="appt-tab"
      [class.active]="selectedTab === 'series'"
      [class.tab-disabled]="tabsLocked"
      matTooltip="קביעת סדרת טיפולים קבועה באותו יום ושעה (למשל כל חמישי 16:00)"
      matTooltipPosition="above"
      matTooltipClass="custom-tooltip"
      [matTooltipDisabled]="tabsLocked"
    >
      סדרת טיפולים
    </button>
  </div>

  <!-- Makeup -->
  <div class="tab-wrap" (click)="onTabClick('makeup')">
    <button
      type="button"
      class="appt-tab"
      [class.active]="selectedTab === 'makeup'"
      [class.tab-disabled]="tabsLocked"
      matTooltip="מציאת חורים פנויים לשיעורי השלמה על חשבון שיעורים שבוטלו לפי הגדרות החווה"
      matTooltipPosition="above"
      [matTooltipDisabled]="tabsLocked"
    >
      שיעור השלמה
    </button>
  </div>

  <!-- Occupancy -->
  <div class="tab-wrap" (click)="onTabClick('occupancy')">
    <button
      type="button"
      class="appt-tab"
      [class.active]="selectedTab === 'occupancy'"
      [class.tab-disabled]="tabsLocked"
      matTooltip="שיעורים שבוטלו על ידי מדריך וזמינים למילוי מקום"
      matTooltipPosition="above"
      [matTooltipDisabled]="tabsLocked"
    >
      מילוי מקום
    </button>
  </div>

</div>

<!-- הודעה רק אחרי ניסיון לחיצה על טאבים נעולים -->
<small class="hint" *ngIf="uiHint['tab']">{{ uiHint['tab'] }}</small>

</div>


  <!-- ======== טאב: סדרת טיפולים ======== -->
  <div *ngIf="selectedTab === 'series'" class="appt-card">
    <h3>סדרת טיפולים קבועה</h3>
    <ng-template #confirmSeriesDialog let-dialogRef="dialogRef">
      <div dir="rtl" style="padding: 10px; max-width: 350px;">
        <h3>אישור בקשת סדרה</h3>

        <p>
          האם את בטוחה שברצונך לקבוע
          סדרה שמתחילה בתאריך <b>{{ seriesConfirmData.startDate }}</b><br>
          מסתיימת בתאריך <b>{{ seriesConfirmData.endDate }}</b><br>
          ביום <b>{{ seriesConfirmData.dayLabel }}</b><br>
          בשעה <b>{{ seriesConfirmData.startTime }}–{{ seriesConfirmData.endTime }}</b><br>
          עם המדריך <b>{{ seriesConfirmData.instructorName }}</b>?
          ניתן לבטל שיעור עד {{ hoursBeforeCancel }} שעות לפני מועד השיעור ללא חיוב.

        </p>


        <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:20px;">
          <button class="btn-cancel" (click)="dialogRef.close(false)">לא</button>
          <button class="btn-ok" (click)="dialogRef.close(true)">כן</button>
        </div>
      </div>
    </ng-template>
    <div class="appt-form-row">
      <div class="appt-field-group">
        <span class="appt-field-label">כמות שיעורים בסדרה</span>
        <div
  class="field-wrap"
  [class.is-disabled]="!canChooseSeriesCount"
  (click)="!canChooseSeriesCount && showUiHint('seriesCount', missingSeriesCountMsg)"
>
        <select class="appt-select" [(ngModel)]="seriesLessonCount" (ngModelChange)="onSeriesLessonCountChange($event)"
          [disabled]="!canChooseSeriesCount">
          <option [ngValue]="null" disabled hidden>
            בחר/י כמות מפגשים
          </option>

          <option *ngFor="let n of seriesLessonCountOptions" [ngValue]="n">
            {{ n }} מפגשים
          </option>
        </select>

        <small class="hint" *ngIf="uiHint['seriesCount']">{{ uiHint['seriesCount'] }}</small>

      </div>
      
      <div class="appt-form-row">
        <div class="appt-form-row">
          <div class="appt-field-group">
         <span class="appt-field-label">מסלול תשלום</span>

<div
  class="field-wrap"
  [class.is-disabled]="paymentLocked"
  (click)="paymentLocked && showUiHint('payment', missingPaymentPlanMsg)"
>
  <select
    class="appt-select"
    [(ngModel)]="selectedPaymentPlanId"
    [disabled]="paymentLocked"
  >
    <option [ngValue]="null" disabled hidden>
      בחר/י מסלול תשלום
    </option>

    <option *ngFor="let plan of paymentPlans" [ngValue]="plan.id">
      {{ plan.name }}
      <ng-container *ngIf="plan.customer_amount != null">
        – {{ plan.customer_amount | number:'1.0-0' }} ₪ לשיעור
      </ng-container>
    </option>
  </select>

  <!-- ההודעה תופיע רק אחרי ניסיון לחיצה על נעול -->
  <small class="hint" *ngIf="uiHint['payment']">{{ uiHint['payment'] }}</small>

  <!-- זה נשאר רגיל: מסמכים נדרשים למסלול (זה כן יכול להופיע אחרי שבחרו מסלול) -->
  <small
    *ngIf="selectedPaymentPlan?.require_docs_at_booking"
    style="color:#888; display:block; margin-top:4px;"
  >
    למסלול זה נדרשים מסמכים:
    {{ selectedPaymentPlan?.required_docs?.join(', ') || 'ע״פ הנחיות החווה' }}
  </small>
</div>

          </div>
        </div>

        <!-- העלאת מסמך רק אם המסלול דורש -->
        <div class="appt-form-row" *ngIf="selectedPaymentPlan?.require_docs_at_booking">
          <div class="appt-field-group">
            <span class="appt-field-label">העלאת מסמך למסלול</span>
            <input type="file" class="appt-input" (change)="onReferralFileSelected($event)" accept=".pdf,image/*" />
            <div *ngIf="referralFile" class="file-name">
              הקובץ שנבחר: <b>{{ referralFile.name }}</b>
            </div>
            <p class="error" *ngIf="referralUploadError">{{ referralUploadError }}</p>
          </div>
        </div>
      </div>
    </div>
    <div class="appt-form-row">
      <div class="appt-field-group">
        <span class="appt-field-label">יום תחילת סדרה בשבוע</span>

          <!-- פריסה דו-עמודתית: ימין קלנדר, שמאל שעות -->
          <div class="series-layout">
            <!-- קלנדר קטן לחיפוש סדרות -->
            <div class="series-calendar">
              <div class="calendar-header">
                <button type="button" (click)="goToPrevMonth()">&lt;</button>
                <span>
                  {{ currentCalendarMonth + 1 }}/{{ currentCalendarYear }}
                </span>
                <button type="button" (click)="goToNextMonth()">&gt;</button>
              </div>

              <div class="calendar-grid">
                <!-- כותרות ימים -->
                <div class="calendar-day-name">א'</div>
                <div class="calendar-day-name">ב'</div>
                <div class="calendar-day-name">ג'</div>
                <div class="calendar-day-name">ד'</div>
                <div class="calendar-day-name">ה'</div>
                <div class="calendar-day-name">ו'</div>
                <div class="calendar-day-name">ש'</div>

                <!-- הימים עצמם -->
                <div *ngFor="let d of seriesCalendarDays" class="calendar-day" [ngClass]="{
              'not-current': !d.isCurrentMonth,
              'has-slots': d.hasSlots,
              'selected-day': d.date === selectedSeriesDate
            }" (click)="onSeriesCalendarDayClick(d)">
                  <span class="day-label" *ngIf="d.label">{{ d.label }}</span>
                  <span class="day-dot" *ngIf="d.hasSlots"></span>
                </div>
              </div>
            </div>

            <!-- שעות זמינות ביום שנבחר -->
            <div class="slots-list series-slots" *ngIf="selectedSeriesDate && selectedSeriesDaySlots.length">
              <h4>שעות זמינות ליום {{ selectedSeriesDate }}</h4>

              <table>
                <thead>
                  <tr>
                    <th>שעה</th>
                    <th>מדריך</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let s of selectedSeriesDaySlots">
                    <td>{{ s.start_time | slice:0:5 }}–{{ s.end_time | slice:0:5 }}</td>
                    <td>{{ s.instructor_name || s.instructor_id }}</td>
                    <td>
                      <button type="button" class="appt-cta" (click)="onSeriesSlotChosen(s, confirmSeriesDialog)"
                        [disabled]="!canRequestSeries" [attr.aria-disabled]="!canRequestSeries ? 'true' : null">
                        בקש סדרה במועד זה
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

          </div> <!-- /series-layout -->
        </div>
      </div>

    </div>


    <p class="error" *ngIf="seriesError">{{ seriesError }}</p>
    <p class="success" *ngIf="seriesCreatedMessage">
      {{ seriesCreatedMessage }}
    </p>

    <!-- <div *ngIf="recurringSlots.length > 0" class="slots-list">
      <h4>זמנים אפשריים</h4>
      <table>
        <thead>
          <tr>
            <th>תאריך ראשון</th>
            <th>שעה</th>
            <th>מדריך</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let s of recurringSlots">
            <td>{{ s.lesson_date }}</td>
            <td>
              {{ s.start_time | slice: 0:5 }}–{{
                s.end_time | slice: 0:5
              }}
            </td>
            <td>{{ s.instructor_id }}</td>
            <td>
              <button
                type="button"
                class="appt-cta"
                (click)="createSeriesFromSlot(s)"
              >
                קבע סדרה
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div> -->
</div>

<!-- ======== טאב: מילוי מקום ======== -->
<div *ngIf="selectedTab === 'occupancy'" class="appt-card">
  <h3>שיעורים שמחפשים מילוי מקום</h3>

  <div class="slots-list">
    <ng-container *ngIf="loadingOccupancyCandidates">
      <p>טוען שיעורים שמחפשים מילוי מקום...</p>
    </ng-container>

    <ng-container *ngIf="!loadingOccupancyCandidates && occupancyCandidates.length > 0">
      <table class="appt-table occupancy-table">
  <thead>
    <tr>
      <th>תאריך</th>
      <th>יום</th>
      <th>שעה</th>
      <th>מדריך</th>
      <th>סטטוס</th>
      <th></th>
    </tr>
  </thead>

  <tbody>
    <tr
      *ngFor="let o of occupancyCandidates"
      [ngClass]="{
        'occupancy-row-selected':
          selectedOccupancyCandidate?.lesson_id === o.lesson_id &&
          selectedOccupancyCandidate?.occur_date === o.occur_date
      }"
    >
      <td>{{ o.occur_date }}</td>
      <td>{{ o.day_of_week }}</td>
      <td>{{ o.start_time | slice: 0:5 }}–{{ o.end_time | slice: 0:5 }}</td>
      <td>{{ o.instructor_name || o.instructor_id }}</td>
      <td>{{ o.status }}</td>
      <td>
        <button
          type="button"
          class="appt-cta"
          (click)="openOccupancySlotsForCandidate(o)"
        >
          להשלמת שיעור זה
        </button>
      </td>
    </tr>
  </tbody>
</table>

    </ng-container>

    <p
      class="empty-text"
      *ngIf="!loadingOccupancyCandidates && !occupancyCandidates.length"
    >
      אין כרגע שיעורים שמחפשים מילוי מקום.
    </p>
  </div>
</div>
<div
  class="slots-list occupancy-slots"
  *ngIf="selectedOccupancyCandidate && occupancySlots.length > 0"
>
  <h4>
    שיעורים זמינים למילוי מקום עבור
    {{ selectedOccupancyCandidate.occur_date }}
  </h4>

  <table>
    <thead>
      <tr>
        <th>תאריך</th>
        <th>יום</th>
        <th>שעה</th>
        <th>מדריך</th>
        <th>סוג שיעור</th>
        <th>יתרה ב-slot</th>
        <th></th>
      </tr>
    </thead>

  <tbody>
    <tr *ngFor="let s of occupancySlots">
      <td>{{ s.occur_date }}</td>
      <td>{{ getSlotDayLabel(s.occur_date) }}</td>
      <td>{{ s.start_time | slice:0:5 }}–{{ s.end_time | slice:0:5 }}</td>
      <td>{{ s.instructor_name || s.instructor_id }}</td>
      <td>{{ getLessonTypeLabel(s) }}</td>
      <td>
        <button type="button"
                class="appt-cta"
                (click)="selectAndRequestOccupancySlot(s)">
          קבע שיעור מילוי מקום
        </button>
      </td>
    </tr>
  </tbody>
  </table>

  <p *ngIf="loadingOccupancySlots">טוען שיעורים למילוי מקום...</p>
  <p class="error" *ngIf="occupancySlotsError">
    {{ occupancySlotsError }}
  </p>
</div>

 <!-- ======== טאב: שיעור השלמה ======== -->
<div *ngIf="selectedTab === 'makeup'" class="appt-card">
  <h3>שיעור השלמה</h3>

  <!-- רשימת שיעורים שניתן להשלים -->
  <div class="slots-list">
    <h4>שיעורים שניתן להשלים</h4>

    <ng-container *ngIf="loadingMakeupCandidates">
      <p>טוען שיעורים שניתן להשלים...</p>
    </ng-container>

    <ng-container *ngIf="!loadingMakeupCandidates && makeupCandidates.length > 0">
      <table class="appt-table makeup-table">
        <thead>
          <tr>
            <th>תאריך</th>
            <th>יום</th>
            <th>שעה</th>
            <th>מדריך</th>
            <th></th>
          </tr>
        </thead>

        <tbody>
          <tr
            *ngFor="let c of makeupCandidates"
            [ngClass]="{
              'makeup-row-selected':
                selectedMakeupCandidate?.lesson_id === c.lesson_id &&
                selectedMakeupCandidate?.occur_date === c.occur_date
            }"
          >
            <td>{{ c.occur_date }}</td>
            <td>{{ c.day_of_week }}</td>
            <td>{{ c.start_time | slice:0:5 }}–{{ c.end_time | slice:0:5 }}</td>
            <td>{{ getInstructorNameById(c.instructor_id) }}</td>
            <td>
              <button type="button" class="appt-cta" (click)="openHolesForCandidate(c)">
                להשלמת שיעור זה
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </ng-container>

    <p class="empty-text" *ngIf="!loadingMakeupCandidates && !makeupCandidates.length">
      אין כרגע שיעורים שניתן להשלים.
    </p>

    <p class="error" *ngIf="makeupError">{{ makeupError }}</p>
    <p class="success" *ngIf="makeupCreatedMessage">{{ makeupCreatedMessage }}</p>
  </div>

  <!-- חורים פנויים עבור השיעור שנבחר -->
  <div class="slots-list" *ngIf="selectedMakeupCandidate && candidateSlots.length > 0">
    <h4>חורים פנויים להשלמה עבור {{ selectedMakeupCandidate.occur_date }}</h4>

    <table class="appt-table">
      <thead>
        <tr>
          <th>תאריך</th>
          <th>יום</th>
          <th>שעה</th>
          <th>מדריך</th>
          <th>סוג שיעור</th>
          <th></th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let s of candidateSlots">
          <td>{{ s.occur_date }}</td>
          <td>{{ getSlotDayLabel(s.occur_date) }}</td>
          <td>{{ s.start_time | slice:0:5 }}–{{ s.end_time | slice:0:5 }}</td>
          <td>{{ s.instructor_name || s.instructor_id }}</td>
          <td>{{ getLessonTypeLabel(s) }}</td>
          <td>
            <button type="button" class="appt-cta" (click)="onMakeupSlotChosen(s)">
              קבע שיעור השלמה
            </button>
          </td>
        </tr>
      </tbody>
    </table>

    <p *ngIf="loadingCandidateSlots">טוען חורים פנויים...</p>
    <p class="error" *ngIf="candidateSlotsError">{{ candidateSlotsError }}</p>
  </div>

  <!-- דיאלוג אישור להורה -->
  <ng-template #confirmMakeupDialog let-dialogRef="dialogRef">
    <div dir="rtl" style="padding: 10px; max-width: 350px;">
      <h3>אישור בקשת שיעור השלמה</h3>

      <p>
        האם את בטוחה שברצונך לבקש שיעור השלמה
        לתאריך <b>{{ confirmData.newDate }}</b>
        בשעות <b>{{ confirmData.newStart }}–{{ confirmData.newEnd }}</b>
        במקום השיעור בתאריך
        <b>{{ confirmData.oldDate }}</b>
        בשעות <b>{{ confirmData.oldStart }}–{{ confirmData.oldEnd }}</b>?
        ניתן לבטל שיעור עד {{ hoursBeforeCancel }} שעות לפני מועד השיעור ללא חיוב.
      </p>

      <div style="display:flex; justify-content: flex-end; gap: 8px; margin-top: 20px;">
        <button mat-button (click)="dialogRef.close(false)">ביטול</button>
        <button mat-raised-button color="primary" (click)="dialogRef.close(true)">אישור</button>
      </div>
    </div>
  </ng-template>
</div>

<!-- דיאלוג אישור מילוי מקום -->
<ng-template #confirmOccupancyDialog let-dialogRef="dialogRef">
  <div dir="rtl" style="padding: 10px; max-width: 380px;">
    <h3>אישור קביעת שיעור מילוי מקום</h3>

    <p>
      האם את בטוחה שברצונך לקבוע שיעור מילוי מקום
      בתאריך <b>{{ occupancyConfirmData.newDate }}</b>
      בשעות <b>{{ occupancyConfirmData.newStart }}–{{ occupancyConfirmData.newEnd }}</b>
      עם המדריך <b>{{ occupancyConfirmData.newInstructorName }}</b><br>
      במקום השיעור שהיה בתאריך
      <b>{{ occupancyConfirmData.oldDate }}</b>
      בשעות <b>{{ occupancyConfirmData.oldStart }}–{{ occupancyConfirmData.oldEnd }}</b>
      עם המדריך <b>{{ occupancyConfirmData.oldInstructorName }}</b>?
    </p>

    <div style="display:flex; justify-content:flex-end; gap: 8px; margin-top: 20px;">
      <button mat-button (click)="dialogRef.close(false)">ביטול</button>
      <button mat-raised-button color="primary" (click)="dialogRef.close(true)">אישור</button>
    </div>
  </div>
</ng-template>

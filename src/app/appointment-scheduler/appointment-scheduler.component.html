<div class="appt-wrapper" dir="rtl">
  <!-- בחירת ילד + אישורים -->
  <div class="appt-card">
  <h2>זימון תורים</h2>

 <div class="appt-header-row">
  
  <!-- טור ימין: בחירת ילד -->
  <div class="appt-field-group child-group">
    <span class="appt-field-label">ילד/ה</span>
    <select
      class="appt-select"
      [(ngModel)]="selectedChildId"
      (change)="onChildChange()"
    >
      <option [ngValue]="null">בחר/י ילד</option>
      <option *ngFor="let child of children" [ngValue]="child.child_uuid">
        {{ child.first_name }} {{ child.last_name }}
      </option>
    </select>
  </div>

  <!-- טור שמאל: מדריך + אין העדפה -->
  <div class="appt-field-group instructor-group">
    <span class="appt-field-label">מדריך</span>

    <div class="instructor-select-row">
    <select
  class="appt-select"
  [(ngModel)]="selectedInstructorId"
  (change)="onInstructorChange()"
>
  <option [ngValue]="null" disabled hidden>בחר/י מדריך</option>

  <!-- האופציה החדשה -->
  <option [ngValue]="'any'">כל המדריכים</option>

  <option
    *ngFor="let ins of instructors"
    [ngValue]="ins.instructor_uid"
  >
    {{ ins.full_name }}
  </option>
</select>

      
    </div>
  </div>
</div>

    <!-- כרטיס מידע על המדריך שנבחר -->
<div 
  *ngIf="selectedInstructor && !noInstructorPreference && showInstructorDetails"
class="instructor-card">
  <!-- כפתור איקס לסגירה -->
  <button
    type="button"
    class="instructor-close"
    (click)="showInstructorDetails = false"
    aria-label="סגירת פרטי מדריך"
  >
    ✕
  </button>

 <div class="instructor-card-header">
  <div class="instructor-name">
    {{ selectedInstructor.full_name }}
  </div>
</div>

<div class="instructor-card-body">
  <!-- עמודת מידע טקסטואלי -->
  <div class="instructor-info-col">
    <div class="instructor-line" *ngIf="selectedInstructor.gender">
      <span class="label">מין:</span>
      <span class="value">{{ selectedInstructor.gender }}</span>
    </div>

    <div class="instructor-about" *ngIf="selectedInstructor.about">
      <span class="label">אודות:</span>
      <p class="about-text">
        {{ selectedInstructor.about }}
      </p>
    </div>
  </div>

  <!-- עמודת תעודה -->
   
  <div class="instructor-cert-col"*ngIf="selectedInstructor.certificate">
  <div class="label">תעודה:</div>

    <a
      [href]="selectedInstructor.certificate"
      target="_blank"
      rel="noopener noreferrer"
    >
      <img
        [src]="selectedInstructor.certificate"
        alt="תעודת מדריך"
        class="certificate-thumb"
      />
    </a>
  </div>
</div>

  </div>

  <!-- טאבים -->
  <div class="appt-tabs">
    <button
      type="button"
      class="appt-tab"
      [class.active]="selectedTab === 'series'"
      (click)="selectedTab = 'series'"
    >
      סדרת טיפולים
    </button>
    <button
      type="button"
      class="appt-tab"
      [class.active]="selectedTab === 'makeup'"
      (click)="selectedTab = 'makeup'"
    >
      שיעור השלמה
    </button>
  </div>

  <!-- ======== טאב: סדרת טיפולים ======== -->
  <div *ngIf="selectedTab === 'series'" class="appt-card">
    <h3>סדרת טיפולים קבועה</h3>

    <div class="appt-form-row">
      <div class="appt-field-group">
        <span class="appt-field-label">יום בשבוע</span>
        <select class="appt-select" [(ngModel)]="seriesDayOfWeek">
          <option [ngValue]="null">בחר/י יום</option>
          <option *ngFor="let d of daysOfWeek" [ngValue]="d.value">
            {{ d.label }}
          </option>
        </select>
      </div>

      <div class="appt-field-group">
        <span class="appt-field-label">שעת התחלה</span>
        <input
          class="appt-input"
          type="time"
          [(ngModel)]="seriesStartTime"
        />
      </div>
    </div>

    <div class="appt-form-row">
      <div class="appt-field-group">
        <span class="appt-field-label">סוג תשלום</span>
        <select
          class="appt-select"
          [(ngModel)]="paymentSourceForSeries"
        >
          <option value="health_fund">קופה</option>
          <option value="private">פרטי</option>
        </select>
      </div>
    </div>

    <div class="appt-actions">
      <button
        type="button"
        class="appt-cta primary"
        (click)="searchRecurringSlots()"
        [disabled]="loadingSeries || !selectedChildId"
        [attr.aria-disabled]="loadingSeries || !selectedChildId ? 'true' : null"
      >
        {{ loadingSeries ? 'מחפש...' : 'חפש סדרות זמינות' }}
      </button>
    </div>

    <p class="error" *ngIf="seriesError">{{ seriesError }}</p>
    <p class="success" *ngIf="seriesCreatedMessage">
      {{ seriesCreatedMessage }}
    </p>

    <div *ngIf="recurringSlots.length > 0" class="slots-list">
      <h4>זמנים אפשריים</h4>
      <table>
        <thead>
          <tr>
            <th>תאריך ראשון</th>
            <th>שעה</th>
            <th>מדריך</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let s of recurringSlots">
            <td>{{ s.lesson_date }}</td>
            <td>
              {{ s.start_time | slice: 0:5 }}–{{
                s.end_time | slice: 0:5
              }}
            </td>
            <td>{{ s.instructor_id }}</td>
            <td>
              <button
                type="button"
                class="appt-cta"
                (click)="createSeriesFromSlot(s)"
              >
                קבע סדרה
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ======== טאב: שיעור השלמה ======== -->
  <div *ngIf="selectedTab === 'makeup'" class="appt-card">
    <h3>שיעור השלמה</h3>

    <div class="appt-form-row">
      <div class="appt-field-group">
        <span class="appt-field-label">מתאריך</span>
        <input
          class="appt-input"
          type="date"
          [(ngModel)]="makeupFromDate"
        />
      </div>

      <div class="appt-field-group">
        <span class="appt-field-label">עד תאריך</span>
        <input
          class="appt-input"
          type="date"
          [(ngModel)]="makeupToDate"
        />
      </div>
    </div>

    <div class="appt-actions">
      <button
        type="button"
        class="appt-cta primary"
        (click)="searchMakeupSlots()"
        [disabled]="loadingMakeup || !selectedChildId"
        [attr.aria-disabled]="loadingMakeup || !selectedChildId ? 'true' : null"
      >
        {{ loadingMakeup ? 'מחפש...' : 'חפש חורים להשלמה' }}
      </button>
    </div>

    <p class="error" *ngIf="makeupError">{{ makeupError }}</p>
    <p class="success" *ngIf="makeupCreatedMessage">
      {{ makeupCreatedMessage }}
    </p>

    <div *ngIf="makeupSlots.length > 0" class="slots-list">
      <h4>חורים זמינים</h4>
      <table>
        <thead>
          <tr>
            <th>תאריך</th>
            <th>שעה</th>
            <th>מדריך</th>
            <th>יתרה ב-slot</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let s of makeupSlots">
            <td>{{ s.occur_date }}</td>
            <td>
              {{ s.start_time | slice: 0:5 }}–{{
                s.end_time | slice: 0:5
              }}
            </td>
            <td>{{ s.instructor_id }}</td>
            <td>{{ s.remaining_capacity }}</td>
            <td>
              <button
                type="button"
                class="appt-cta"
                (click)="bookMakeupSlot(s)"
              >
                קבע שיעור השלמה
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
